<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚Œãªã¡çš„VSPOä¸­æ–‡ç²¾è¯æ”¶é›†è™•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> 
        html {
            scroll-behavior: smooth;
        }
        body { 
            background-color: #111827; 
        }
        /* å‹•æ…‹å°é¢æ¯”ä¾‹é‚è¼¯ */
        .video-thumbnail-container {
            aspect-ratio: 16 / 9;
            transition: aspect-ratio 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        /* åªæœ‰åœ¨ "shorts-only" æ¨¡å¼ä¸‹æ‰æ”¹è®Šæ¯”ä¾‹ */
        .view-mode-shorts-only .video-thumbnail-container {
            aspect-ratio: 9 / 16;
        }

        /* Shorts æ¨¡å¼ä¸‹å¡ç‰‡çš„å­—é«”èˆ‡é–“è·èª¿æ•´ */
        .view-mode-shorts-only .group h3 {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
        }
        .view-mode-shorts-only .group .text-sm {
            font-size: 0.75rem; /* text-xs */
            line-height: 1rem;
        }
        .view-mode-shorts-only .group .w-6.h-6 {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
        }
        .view-mode-shorts-only .group .p-4 {
            padding: 0.75rem; /* p-3 */
        }

        /* â˜… æ–°å¢ï¼šåœ¨æ‰‹æ©Ÿç‰ˆä¸Šéš±è—ç¬¬11å’Œ12éƒ¨æœ€æ–°å½±ç‰‡ */
        @media (max-width: 1279px) {
            #latest-videos-grid > .video-card:nth-child(n+11) {
                display: none;
            }
        }

        /* Tooltip æ¨£å¼ */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937; /* gray-800 */
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 30;
            bottom: 150%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4b5563; /* gray-600 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext,
        .tooltip:focus-within .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .secret-trigger { cursor: pointer; }
        /* æŒ‰éˆ•æ¨£å¼ */
        .tab-btn {
            padding: 0.5rem 1rem; border-radius: 0.375rem;
            background-color: #374151; color: #d1d5db;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        .tab-btn.active, .tab-btn:hover {
            background-color: #4f46e5; color: #fff;
        }
        .type-filter-btn.active, .type-filter-btn:hover {
            background-color: #0d9488; /* teal-600 */
            color: #fff;
        }
        .pagination-btn {
            min-width: 2.5rem; padding: 0.5rem; 
            border: 1px solid #4b5563;
            background-color: #374151; color: #d1d5db;
            border-radius: 0.375rem; transition: background-color 0.2s;
            text-align: center;
        }
        .pagination-btn:hover:not(:disabled) { background-color: #4f46e5; }
        .pagination-btn.active { background-color: #4f46e5; color: #fff; border-color: #4f46e5; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-ellipsis {
            display: flex; align-items: center; justify-content: center;
            min-width: 2.5rem; padding: 0.5rem; color: #9ca3af;
        }
        /* æˆå“¡ç¯©é¸æ¨™ç±¤æ¨£å¼ */
        .filter-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }
        .filter-btn:hover {
            transform: scale(1.03);
        }
        .filter-btn[data-filter="all"] {
            background-color: #4b5563;
            color: #ffffff;
        }
        .filter-btn[data-filter="all"].active {
            background-color: #6366f1;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }
        .filter-btn.active {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.25);
            transform: scale(1.02);
        }
        /* éš±è—æ»¾å‹•æ¢ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modal & Dropdown æ¨£å¼ */
        .modal-overlay, .dropdown-menu {
            position: fixed;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay {
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center;
        }
        .modal-overlay.visible, .dropdown-menu.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            max-width: 90%;
            width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .dropdown-menu {
            position: absolute;
            background-color: #1f2937;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-top: 0.5rem;
            min-width: 10rem;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .dropdown-menu.visible {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="app"></div>

    <script type="module">
        // --- å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹ç®¡ç† ---
        const CURRENT_APP_VERSION = 'V9.2';
        const PROXY_ENDPOINT = 'https://vspo-proxy-git-main-renas-projects-c8ce958b.vercel.app'; 
        const BLACKLIST_KEY = 'vspo_channel_blacklist';
        const LAST_SEEN_VERSION_KEY = 'vspo_last_seen_version';

        let state = {
            allVideos: [], 
            blacklist: [],
            isLoading: true, 
            lastUpdated: null, 
            apiError: null,
            totalVisits: 0,
            todayVisits: 0,
            activeView: 'latest', 
            activeVideoTypeFilter: 'all',
            isFilterDropdownOpen: false,
            currentPage: 1,
            itemsPerPage: 10,
            activeMemberFilter: 'all', 
            activeChannelFilter: null,
        };

        const appContainer = document.getElementById('app');

        // ç‰ˆæœ¬æ›´æ–°æ—¥èªŒ
        const UPDATE_LOGS = {
            'V9.1': {
                title: 'V9.1 æ›´æ–°æƒ…å ±ï¼',
                date: '2025-07-20',
                features: [
                    'ã€éŒ¯èª¤ä¿®æ­£ã€‘ä¿®å¾©äº†åœ¨æ‰‹æ©Ÿä¸Šæ»‘å‹•æ™‚ï¼Œé é¢æœƒè‡ªå‹•è·³å›é ‚éƒ¨çš„å•é¡Œã€‚',
                ]
            },
            'V9.2': {
                title: 'V9.2 æ›´æ–°æƒ…å ±ï¼',
                date: '2025-07-20',
                features: [
                    'ã€éŒ¯èª¤ä¿®æ­£ã€‘ä¿®å¾©äº†åœ¨æ‰‹æ©Ÿä¸Šèˆ‡shortså…©æ¬„é…ç½®å°è‡´çš„éŒ¯èª¤éš±è—å•é¡Œã€‚'
                ]
            }
        };
        // VSPO æˆå“¡è³‡æ–™ (åˆ†å€)
        const vspoJPMembers = [
            {"name_jp": "èŠ±èŠ½ã™ã¿ã‚Œ", "filter_keyword": "èŠ±èŠ½ã™ã¿ã‚Œ", "color": "#b0c4de"},
            {"name_jp": "èŠ±èŠ½ãªãšãª", "filter_keyword": "èŠ±èŠ½ãªãšãª", "color": "#fabedc"},
            {"name_jp": "å°é›€ã¨ã¨", "filter_keyword": "å°é›€ã¨ã¨", "color": "#f5eb4a"},
            {"name_jp": "ä¸€ãƒç€¬ã†ã‚‹ã¯", "filter_keyword": "ä¸€ãƒç€¬ã†ã‚‹ã¯", "color": "#4182fa"},
            {"name_jp": "èƒ¡æ¡ƒã®ã‚", "filter_keyword": "èƒ¡æ¡ƒã®ã‚", "color": "#ffdbfe"},
            {"name_jp": "å…å’²ãƒŸãƒŸ", "filter_keyword": "å…å’²ãƒŸãƒŸ", "color": "#c7b2d6"},
            {"name_jp": "ç©ºæ¾„ã‚»ãƒŠ", "filter_keyword": "ç©ºæ¾„ã‚»ãƒŠ", "color": "#ffffff"},
            {"name_jp": "æ©˜ã²ãªã®", "filter_keyword": "æ©˜ã²ãªã®", "color": "#fa96c8"},
            {"name_jp": "è‹±ãƒªã‚µ", "filter_keyword": "è‹±ãƒªã‚µ", "color": "#d1de79"},
            {"name_jp": "å¦‚æœˆã‚Œã‚“", "filter_keyword": "å¦‚æœˆã‚Œã‚“", "color": "#be2152"},
            {"name_jp": "ç¥æˆãã‚…ã´", "filter_keyword": "ç¥æˆãã‚…ã´", "color": "#ffd23c"},
            {"name_jp": "å…«é›²ã¹ã«", "filter_keyword": "å…«é›²ã¹ã«", "color": "#85cab3"},
            {"name_jp": "è—æ²¢ã‚¨ãƒ", "filter_keyword": "è—æ²¢ã‚¨ãƒ", "color": "#b4f1f9"},
            {"name_jp": "ç´«å®®ã‚‹ãª", "filter_keyword": "ç´«å®®ã‚‹ãª", "color": "#d6adff"},
            {"name_jp": "çŒ«æ±°ã¤ãª", "filter_keyword": "çŒ«æ±°ã¤ãª", "color": "#ff3652"},
            {"name_jp": "ç™½æ³¢ã‚‰ã‚€ã­", "filter_keyword": "ç™½æ³¢ã‚‰ã‚€ã­", "color": "#8eced9"},
            {"name_jp": "å°æ£®ã‚ã¨", "filter_keyword": "å°æ£®ã‚ã¨", "color": "#fba03f"},
            {"name_jp": "å¤¢é‡ã‚ã‹ã‚Š", "filter_keyword": "å¤¢é‡ã‚ã‹ã‚Š", "color": "#ff998d"},
            {"name_jp": "å¤œä¹ƒãã‚ã‚€", "filter_keyword": "å¤œä¹ƒãã‚ã‚€", "color": "#909ec8"},
            {"name_jp": "ç´¡æœ¨ã“ã‹ã’", "filter_keyword": "ç´¡æœ¨ã“ã‹ã’", "color": "#5195e1"},
            {"name_jp": "åƒç‡ˆã‚†ã†ã²", "filter_keyword": "åƒç‡ˆã‚†ã†ã²", "color": "#ed784a"},
            {"name_jp": "è¶å±‹ã¯ãªã³", "filter_keyword": "è¶å±‹ã¯ãªã³", "color": "#ea5506"},
            {"name_jp": "ç”˜çµã‚‚ã‹", "filter_keyword": "ç”˜çµã‚‚ã‹", "color": "#eca0aa"}
        ];

        const otherMemberGroups = {
            "VSPO! EN": [
                {"name_jp": "Remia Aotsuki", "filter_keyword": "Remia", "color": "#398FB2", "forceWhiteText": true},
                {"name_jp": "Arya Kuroha", "filter_keyword": "Arya", "color": "#000000", "forceWhiteText": true},
                {"name_jp": "Jira Jisaki", "filter_keyword": "Jira", "color": "#606D3D", "forceWhiteText": true},
                {"name_jp": "Narin Mikure", "filter_keyword": "Narin", "color": "#F3A6EF", "forceWhiteText": true},
                {"name_jp": "Riko Solari", "filter_keyword": "Riko", "color": "#9373D7", "forceWhiteText": true}
            ],
            "VSPO! CN": [
                {"name_jp": "å°é’ˆå½©", "filter_keyword": "å°é‡å½©", "color": "#FE688D", "forceWhiteText": true},
                {"name_jp": "ç™½å’²éœ²ç†", "filter_keyword": "ç™½å’²éœ²ç†", "color": "#E9E5E6", "forceWhiteText": true},
                {"name_jp": "å¸•å¦ƒ", "filter_keyword": "å¸•å¦ƒ", "color": "#9F0019", "forceWhiteText": true},
                {"name_jp": "åƒéƒéƒ", "filter_keyword": "åƒéƒéƒ", "color": "#8986C0", "forceWhiteText": true}
            ]
        };
        
        const allMembers = [...vspoJPMembers, ...Object.values(otherMemberGroups).flat()];
        
        // --- é»‘åå–®ç®¡ç† ---
        function getBlacklist() {
            try {
                const stored = localStorage.getItem(BLACKLIST_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("è®€å–é»‘åå–®å¤±æ•—:", e);
                return [];
            }
        }

        function saveBlacklist(blacklist) {
            try {
                localStorage.setItem(BLACKLIST_KEY, JSON.stringify(blacklist));
            } catch (e) {
                console.error("å„²å­˜é»‘åå–®å¤±æ•—:", e);
            }
        }

        function addToBlacklist(channel) {
            const currentBlacklist = getBlacklist();
            if (!currentBlacklist.some(item => item.id === channel.id)) {
                const newBlacklist = [...currentBlacklist, channel];
                saveBlacklist(newBlacklist);
                state.blacklist = newBlacklist;
                render();
                showBlacklistModal();
            }
        }

        function removeFromBlacklist(channelId) {
            const currentBlacklist = getBlacklist();
            const newBlacklist = currentBlacklist.filter(item => item.id !== channelId);
            saveBlacklist(newBlacklist);
            state.blacklist = newBlacklist;
            render();
            showBlacklistModal();
        }

        function showBlacklistModal() {
            const existingModal = document.getElementById('blacklist-modal');
            if (existingModal) existingModal.remove();

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'blacklist-modal';
            modalOverlay.className = 'modal-overlay visible';

            const currentBlacklist = getBlacklist();
            const allChannels = [...new Map(state.allVideos.map(v => [v.channelId, {id: v.channelId, name: v.channelTitle}])).values()]
                .sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            
            const channelsToBlock = allChannels.filter(channel => !currentBlacklist.some(b => b.id === channel.id));

            let blockedListHTML = '<p class="text-gray-400 text-sm">ç›®å‰æ²’æœ‰å·²å°é–ã®é »é“ã€‚</p>';
            if (currentBlacklist.length > 0) {
                blockedListHTML = currentBlacklist.map(channel => `
                    <div class="flex items-center justify-between p-2 bg-gray-700 rounded-md">
                        <span class="truncate">${channel.name}</span>
                        <button class="unblock-btn text-red-400 hover:text-red-300 font-semibold text-sm" data-channel-id="${channel.id}">è§£é™¤å°é–</button>
                    </div>
                `).join('');
            }

            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-2xl font-bold text-red-400 mb-4">ç®¡ç†å€‹äººé»‘åå–®</h3>
                    <div class="mb-6">
                        <h4 class="font-semibold mb-2 text-gray-300">å·²å°é–æ¸…å–®</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-900 rounded-lg">${blockedListHTML}</div>
                    </div>
                    <div class="border-t border-gray-600 pt-6">
                        <h4 class="font-semibold mb-2 text-gray-300">æ–°å¢å°é–</h4>
                        <div class="flex space-x-2">
                            <select id="channel-to-block-select" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-400">
                                <option value="">-- è«‹é¸æ“‡è¦å°é–çš„é »é“ --</option>
                                ${channelsToBlock.map(c => `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`).join('')}
                            </select>
                            <button id="add-to-blacklist-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex-shrink-0">å°é–</button>
                        </div>
                    </div>
                    <button id="close-blacklist-modal-btn" class="mt-8 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">é—œé–‰</button>
                </div>`;

            document.body.appendChild(modalOverlay);

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay || e.target.id === 'close-blacklist-modal-btn' || e.target.closest('#close-blacklist-modal-btn')) {
                    modalOverlay.classList.remove('visible');
                    setTimeout(() => modalOverlay.remove(), 300);
                }
            });

            document.getElementById('add-to-blacklist-btn').addEventListener('click', () => {
                const select = document.getElementById('channel-to-block-select');
                const channelId = select.value;
                if (channelId) {
                    const selectedOption = select.options[select.selectedIndex];
                    const channelName = selectedOption.dataset.name;
                    addToBlacklist({ id: channelId, name: channelName });
                }
            });

            document.querySelectorAll('.unblock-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const channelId = e.currentTarget.dataset.channelId;
                    removeFromBlacklist(channelId);
                });
            });
        }

        // --- æ›´æ–°æª¢æŸ¥ç›¸é—œå‡½å¼ ---
        function showUpdateModal(title, message, showDownloadButton = false) {
            const existingModal = document.getElementById('update-modal');
            if (existingModal) existingModal.remove();

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'update-modal';
            modalOverlay.className = 'modal-overlay';
            
            let downloadButtonHTML = '';
            if (showDownloadButton) {
                const releaseUrl = "https://github.com/renachiouo/vspo_clip_collector/releases";
                if (navigator.userAgent.toLowerCase().includes('wv')) {
                    downloadButtonHTML = `
                        <div class="mt-6 p-3 bg-gray-900 rounded-lg">
                            <p class="text-sm text-gray-400 mb-2">è«‹è¤‡è£½ä»¥ä¸‹ç¶²å€ï¼Œä¸¦åœ¨æ‚¨çš„æ‰‹æ©Ÿç€è¦½å™¨ä¸­é–‹å•Ÿä»¥ä¸‹è¼‰æ›´æ–°ï¼š</p>
                            <input type="text" readonly value="${releaseUrl}" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none select-all">
                        </div>`;
                } else {
                    downloadButtonHTML = `<a href="${releaseUrl}" target="_blank" rel="noopener noreferrer" class="mt-6 block w-full text-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors">å‰å¾€ä¸‹è¼‰é é¢</a>`;
                }
            }

            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-2xl font-bold text-cyan-400 mb-4">${title}</h3>
                    <p class="text-gray-300">${message}</p>
                    ${downloadButtonHTML}
                    <button id="close-modal-btn" class="mt-4 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">é—œé–‰</button>
                </div>`;

            document.body.appendChild(modalOverlay);
            
            setTimeout(() => modalOverlay.classList.add('visible'), 10);

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay || e.target.id === 'close-modal-btn' || e.target.closest('#close-modal-btn')) {
                    modalOverlay.classList.remove('visible');
                    setTimeout(() => modalOverlay.remove(), 300);
                }
            });

            const urlInput = modalOverlay.querySelector('input[type="text"]');
            if (urlInput) {
                urlInput.addEventListener('click', () => urlInput.select());
            }
        }

        // ç‰ˆæœ¬æ›´æ–°æƒ…å ±è¦–çª—
        function showVersionUpdateModal(versionsToShow) {
            const existingModal = document.getElementById('version-update-modal');
            if (existingModal) existingModal.remove();

            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'version-update-modal';
            modalOverlay.className = 'modal-overlay';

            let allFeaturesHTML = '';
            versionsToShow.forEach((version, index) => {
                const log = UPDATE_LOGS[version];
                if (!log) return;

                const featuresHTML = log.features.map(feature => `
                    <li class="flex items-start">
                        <svg class="w-5 h-5 mr-2 text-green-400 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>${feature}</span>
                    </li>
                `).join('');

                allFeaturesHTML += `
                    ${index > 0 ? '<hr class="border-gray-600 my-4">' : ''}
                    <div class="text-center mb-4">
                        <h4 class="text-xl font-bold text-green-400">${log.title}</h4>
                        <p class="text-xs text-gray-500">ç™¼å¸ƒæ—¥æœŸ: ${log.date}</p>
                    </div>
                    <ul class="space-y-3 text-gray-300">
                        ${featuresHTML}
                    </ul>
                `;
            });

            modalOverlay.innerHTML = `
                <div class="modal-content">
                    ${allFeaturesHTML}
                    <button id="close-version-modal-btn" class="mt-8 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">æˆ‘äº†è§£äº†</button>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            setTimeout(() => modalOverlay.classList.add('visible'), 10);

            const closeModal = () => {
                modalOverlay.classList.remove('visible');
                localStorage.setItem(LAST_SEEN_VERSION_KEY, CURRENT_APP_VERSION);
                setTimeout(() => modalOverlay.remove(), 300);
            };

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay || e.target.id === 'close-version-modal-btn' || e.target.closest('#close-version-modal-btn')) {
                    closeModal();
                }
            });
        }

        async function checkForUpdates() {
            showUpdateModal('æª¢æŸ¥æ›´æ–°ä¸­...', 'æ­£åœ¨å¾ GitHub ç²å–æœ€æ–°ç‰ˆæœ¬è³‡è¨Šï¼Œè«‹ç¨å€™...');
            try {
                const response = await fetch('https://api.github.com/repos/renachiouo/vspo_clip_collector/commits?per_page=1');
                if (!response.ok) throw new Error(`GitHub API è«‹æ±‚å¤±æ•— (${response.status})`);
                
                const data = await response.json();
                const latestCommitMessage = data[0]?.commit?.message || '';
                
                const versionMatch = latestCommitMessage.match(/V(\d+\.\d+(\.\d+)?)/);
                const latestVersion = versionMatch ? `V${versionMatch[1]}` : null;

                if (!latestVersion) throw new Error('ç„¡æ³•å¾æœ€æ–°çš„ commit ä¸­è§£æç‰ˆæœ¬è™Ÿã€‚');

                if (latestVersion === CURRENT_APP_VERSION) {
                    showUpdateModal('æª¢æŸ¥å®Œæˆ', `æ‚¨ç›®å‰ä½¿ç”¨çš„å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ (${CURRENT_APP_VERSION})ã€‚`);
                } else {
                    showUpdateModal(
                        'ç™¼ç¾æ–°ç‰ˆæœ¬ï¼', 
                        `ç›®å‰æœ€æ–°ç‰ˆæœ¬ç‚º <strong>${latestVersion}</strong>ï¼Œæ‚¨ä½¿ç”¨çš„ç‰ˆæœ¬ç‚º ${CURRENT_APP_VERSION}ã€‚<br><br>å»ºè­°æ›´æ–°ä»¥ç²å–æœ€æ–°çš„åŠŸèƒ½èˆ‡ä¿®æ­£ã€‚`,
                        true
                    );
                }
            } catch (error) {
                console.error('æª¢æŸ¥æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showUpdateModal('æª¢æŸ¥å¤±æ•—', `ç„¡æ³•å®Œæˆæ›´æ–°æª¢æŸ¥ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚<br>éŒ¯èª¤è¨Šæ¯: ${error.message}`);
            }
        }

        // --- UI å…ƒä»¶ç”¢ç”Ÿå™¨ ---
        function createErrorDisplay(error) {
            let errorMessage = error;
            let errorHint = "è«‹æª¢æŸ¥ä»£ç†ä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚";
            if (error && error.toLowerCase().includes('quota')) {
                 errorMessage = "API æ¯æ—¥é…é¡å·²ç”¨ç›¡";
                 errorHint = "è«‹ç­‰å¾…å°ç£æ™‚é–“ä¸‹åˆ 4 é»å¾Œï¼Œé…é¡å°‡æœƒè‡ªå‹•é‡ç½®ã€‚";
            }
            return `<div class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-center"><strong class="font-bold">ç™¼ç”ŸéŒ¯èª¤ï¼</strong><p class="block sm:inline ml-2">${errorMessage}</p><p class="mt-2 text-sm">${errorHint}</p></div>`;
        }

        function createVideoCard(video, showChannel = true) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}è¬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'å¹´': 31536000, 'å€‹æœˆ': 2592000, 'å¤©': 86400, 'å°æ™‚': 3600, 'åˆ†é˜': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}å‰`;
                }
                return "å‰›å‰›";
            };
            const card = document.createElement('div');
            // â˜… æ–°å¢ï¼šç‚ºå¡ç‰‡æœ¬èº«åŠ ä¸Š video-card classï¼Œæ–¹ä¾¿ CSS é¸å–
            card.className = "video-card group bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-400/30 transition-shadow duration-300 flex flex-col";
            
            const channelLink = showChannel ? `
                <a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-2">
                    <img src="${video.channelAvatarUrl}" class="w-6 h-6 rounded-full bg-gray-700">
                    <p class="text-sm text-gray-400 hover:text-white transition-colors truncate">${video.channelTitle}</p>
                </a>` : '';
            
            card.innerHTML = `
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="video-thumbnail-container block w-full bg-gray-700 overflow-hidden">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
                </a>
                <div class="p-4 flex flex-col flex-grow">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                    </a>
                    ${channelLink}
                    <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                        <span>${formatNumber(video.viewCount)} æ¬¡è§€çœ‹</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>`;
            return card;
        }
        
        function createVideoListItem(video) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}è¬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'å¹´': 31536000, 'å€‹æœˆ': 2592000, 'å¤©': 86400, 'å°æ™‚': 3600, 'åˆ†é˜': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}å‰`;
                }
                return "å‰›å‰›";
            };
            const item = document.createElement('div');
            item.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors duration-200";
            item.innerHTML = `
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 w-32 aspect-video bg-gray-700 rounded-md overflow-hidden">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/128x72/1a202c/e53e3e?text=Error';">
                </a>
                <div class="flex-1 min-w-0">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer">
                        <h3 class="font-semibold text-gray-100 truncate hover:text-cyan-400">${video.title}</h3>
                    </a>
                    <a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-1">
                        <img src="${video.channelAvatarUrl}" class="w-5 h-5 rounded-full bg-gray-700">
                        <p class="text-sm text-gray-400 hover:text-white truncate">${video.channelTitle}</p>
                    </a>
                    <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                        <span>${formatNumber(video.viewCount)} æ¬¡è§€çœ‹</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>`;
            return item;
        }

        function createChannelGridCard(channel) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}è¬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'å¹´': 31536000, 'å€‹æœˆ': 2592000, 'å¤©': 86400, 'å°æ™‚': 3600, 'åˆ†é˜': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}å‰`;
                }
                return "å‰›å‰›";
            };

            const card = document.createElement('div');
            card.className = "group rounded-lg overflow-hidden shadow-lg hover:shadow-purple-400/30 transition-shadow duration-300 relative";
            card.style.backgroundImage = `url('${channel.avatarUrl}')`;
            card.style.backgroundSize = 'cover';
            card.style.backgroundPosition = 'center';
            
            const video = channel.latestVideo;

            card.innerHTML = `
                <div class="absolute inset-0 bg-gray-900/70 backdrop-blur"></div>
                <div class="relative z-10 flex flex-col h-full">
                    <div class="p-4">
                        <div class="flex items-center space-x-3">
                            <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0">
                                <img src="${channel.avatarUrl}" alt="${channel.name}" class="w-12 h-12 rounded-full bg-gray-700 border-2 border-white/20">
                            </a>
                            <div class="flex-1 min-w-0">
                                <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer">
                                    <p class="text-lg font-bold text-purple-300 truncate">${channel.name}</p>
                                </a>
                                <p class="text-sm text-gray-300">${formatNumber(channel.subscriberCount)} ä½è¨‚é–±è€…</p>
                            </div>
                            <button class="channel-filter-btn flex-shrink-0 p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors" data-channel-id="${channel.id}" data-channel-name="${channel.name}" title="ç¯©é¸æ­¤é »é“">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-300" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 12.414V17a1 1 0 01-1.447.894l-3-2A1 1 0 017 15V12.414L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="px-4 text-sm text-gray-400">æœ€æ–°å½±ç‰‡:</div>
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="block w-full aspect-video bg-gray-700/50 overflow-hidden mt-2">
                        <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
                    </a>
                    <div class="p-4 flex flex-col flex-grow mt-auto">
                        <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                            <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                        </a>
                        <div class="flex justify-between items-center text-sm text-gray-300 mt-3 pt-3 border-t border-gray-500/50">
                            <span>${formatNumber(video.viewCount)} æ¬¡è§€çœ‹</span>
                            <span>${timeAgo(video.publishedAt)}</span>
                        </div>
                    </div>
                </div>`;
            return card;
        }

        function isColorLight(hexColor) {
            if (!hexColor) return false;
            const color = (hexColor.charAt(0) === '#') ? hexColor.substring(1, 7) : hexColor;
            if (color.length < 6) return false;
            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            return (r * 0.299 + g * 0.587 + b * 0.114) > 186;
        }

        function createMemberFilterListHTML(jpMembers, otherGroups, activeFilter) {
            const listContainer = document.createElement('div');
            listContainer.className = 'flex flex-row space-x-2 md:flex-col md:space-y-2 md:space-x-0 overflow-x-auto md:overflow-y-auto no-scrollbar pb-2 md:pb-0';
            listContainer.id = 'member-filter-list-container';
            
            const allBtn = document.createElement('button');
            allBtn.className = `filter-btn flex-shrink-0 ${activeFilter === 'all' ? 'active' : ''}`;
            allBtn.dataset.filter = 'all';
            allBtn.textContent = 'é¡¯ç¤ºå…¨éƒ¨';
            listContainer.appendChild(allBtn);

            const createMemberButton = (member) => {
                const btn = document.createElement('button');
                const isActive = activeFilter === member.filter_keyword;
                btn.className = `filter-btn flex-shrink-0 ${isActive ? 'active' : ''}`;
                btn.dataset.filter = member.filter_keyword;
                btn.style.backgroundColor = member.color;
                
                if (member.forceWhiteText) {
                    btn.style.color = '#FFFFFF';
                } else {
                    btn.style.color = isColorLight(member.color) ? '#1f2937' : '#f9fafb';
                }

                btn.textContent = member.name_jp;
                return btn;
            };

            jpMembers.forEach(member => listContainer.appendChild(createMemberButton(member)));

            for (const groupName in otherGroups) {
                const divider = document.createElement('div');
                divider.className = 'text-xs text-gray-500 pt-2 pb-1 pl-2 md:pt-3 md:pb-1 whitespace-nowrap';
                divider.textContent = groupName;
                listContainer.appendChild(divider);

                otherGroups[groupName].forEach(member => listContainer.appendChild(createMemberButton(member)));
            }
            return listContainer;
        }
        
        function createSkeleton(type) {
            const skeleton = document.createElement('div');
            if (type === 'card') {
                skeleton.className = "bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col";
                skeleton.innerHTML = `<div class="w-full aspect-video bg-gray-700 animate-pulse"></div><div class="p-4"><div class="h-4 bg-gray-700 rounded w-3/4 mb-4 animate-pulse"></div><div class="h-4 bg-gray-700 rounded w-1/2 animate-pulse"></div></div>`;
            } else if (type === 'list') {
                skeleton.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg animate-pulse";
                skeleton.innerHTML = `<div class="w-32 h-[72px] bg-gray-700 rounded-md"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-700 rounded w-5/6"></div><div class="h-4 bg-gray-700 rounded w-1/3"></div><div class="h-3 bg-gray-700 rounded w-1/2"></div></div>`;
            }
            return skeleton;
        }

        async function fetchAllDataFromProxy(force = false, password = '', mode = 'normal') {
            const url = new URL(`${PROXY_ENDPOINT}/api/youtube`);
            if (force) {
                url.searchParams.append('force_refresh', 'true');
                url.searchParams.append('password', password);
                if (mode) {
                    url.searchParams.append('mode', mode);
                }
            }
            const response = await fetch(url);
            const data = await response.json().catch(() => ({ error: `è«‹æ±‚å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: ${response.status}` }));
            if (!response.ok) throw new Error(data.message || data.error || `Request failed with status ${response.status}`);
            return data;
        }
        
        function createPaginationControls(totalPages, currentPage) {
            const container = document.createElement('div');
            container.className = 'flex justify-center items-center space-x-1 md:space-x-2 mt-8';
            const createBtn = (text, page, isDisabled = false, isActive = false) => {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${isActive ? 'active' : ''}`;
                btn.textContent = text;
                btn.dataset.page = page;
                if (isDisabled) btn.disabled = true;
                return btn;
            };
            const createEllipsis = () => {
                const span = document.createElement('span');
                span.className = 'pagination-ellipsis';
                span.textContent = '...';
                return span;
            };
            container.appendChild(createBtn('â€¹', currentPage - 1, currentPage === 1));
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) {
                    container.appendChild(createBtn(i, i, false, i === currentPage));
                }
            } else {
                const pages = new Set([1, totalPages, currentPage, currentPage - 1, currentPage + 1]);
                const sortedPages = Array.from(pages).filter(p => p > 0 && p <= totalPages).sort((a, b) => a - b);
                let lastPage = 0;
                for (const page of sortedPages) {
                    if (lastPage !== 0 && page - lastPage > 1) {
                        container.appendChild(createEllipsis());
                    }
                    container.appendChild(createBtn(page, page, false, page === currentPage));
                    lastPage = page;
                }
            }
            container.appendChild(createBtn('â€º', currentPage + 1, currentPage === totalPages));
            return container;
        }

        function render(onRenderComplete) {
            const { allVideos, isLoading, lastUpdated, apiError, totalVisits, todayVisits, activeView, activeVideoTypeFilter, currentPage, itemsPerPage, activeMemberFilter, activeChannelFilter, blacklist, isFilterDropdownOpen } = state;
            
            appContainer.innerHTML = '';

            const visibleVideos = allVideos.filter(video => !blacklist.some(b => b.id === video.channelId));
            const isClassificationAvailable = visibleVideos.length > 0 && visibleVideos.some(v => v.videoType);

            const header = document.createElement('header');
            header.className = "text-center pt-8 mb-8";
            header.innerHTML = `
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-cyan-400 flex justify-center items-baseline flex-wrap gap-x-3 px-4">
                    <span><span class="secret-trigger" data-char="ã‚Œ">ã‚Œ</span><span class="secret-trigger" data-char="ãª">ãª</span><span class="secret-trigger" data-char="ã¡">ã¡</span>çš„VSPOä¸­æ–‡ç²¾è¯æ”¶é›†è™•</span>
                    <span class="text-lg align-middle text-gray-500 whitespace-nowrap">${CURRENT_APP_VERSION}</span>
                </h1>`;
            
            const topBar = document.createElement('div');
            topBar.className = "sticky top-0 z-20 bg-gray-900/80 backdrop-blur-sm py-4 mb-8";
            topBar.innerHTML = `
                <div class="container mx-auto px-4 text-center text-sm text-gray-500 flex flex-col items-center space-y-2">
                    <div class="flex justify-center items-center space-x-4 flex-wrap gap-y-2">
                        <span class="whitespace-nowrap">ğŸ‘€ ç¸½äººæ¬¡: <span class="font-semibold text-teal-400">${totalVisits.toLocaleString()}</span></span>
                        <span class="whitespace-nowrap">â˜€ï¸ ä»Šæ—¥äººæ¬¡: <span class="font-semibold text-amber-400">${todayVisits.toLocaleString()}</span></span>
                        ${lastUpdated ? `<span class="whitespace-nowrap">è³‡æ–™æ™‚é–“: ${lastUpdated.toLocaleTimeString()}</span>` : ''}
                    </div>
                    <div class="flex justify-center items-center space-x-4 flex-wrap gap-y-2">
                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSdPXcKRZdp6KgVcw_yiXhDy979wrl3y42knIh5fIjP1tGUZBQ/viewform?usp=sharing&ouid=104059498550822009260" target="_blank" rel="noopener noreferrer" class="whitespace-nowrap font-semibold text-indigo-400 hover:text-indigo-300 transition-colors duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            å›å ±éºæ¼é »é“/å½±ç‰‡
                        </a>
                        <button id="manage-blacklist-btn" class="whitespace-nowrap font-semibold text-red-400 hover:text-red-300 transition-colors duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.367zM14.89 13.477a6 6 0 01-8.367-8.367l8.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" /></svg>
                            ç®¡ç†é»‘åå–®
                        </button>
                        <button id="check-update-btn" class="whitespace-nowrap font-semibold text-cyan-400 hover:text-cyan-300 transition-colors duration-200 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zM9 13a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd" /></svg>
                            æª¢æŸ¥æ›´æ–°
                        </button>
                    </div>
                </div>`;
            
            const mainGrid = document.createElement('div');
            mainGrid.className = "container mx-auto px-4 grid grid-cols-1 md:grid-cols-[12rem_minmax(0,1fr)] gap-8";

            const filterSection = document.createElement('aside');
            filterSection.className = "md:col-start-1";
            const filterContainer = document.createElement('div');
            filterContainer.className = "bg-gray-800/50 p-4 rounded-lg md:sticky md:top-28 md:flex md:flex-col md:max-h-[calc(100vh-9rem)]";
            filterContainer.innerHTML = `<h3 class="text-xl font-bold mb-4 text-gray-300 border-b border-gray-600 pb-2">æˆå“¡ç¯©é¸</h3>`;
            filterContainer.appendChild(createMemberFilterListHTML(vspoJPMembers, otherMemberGroups, activeMemberFilter));
            filterSection.appendChild(filterContainer);

            const rightContent = document.createElement('main');
            rightContent.className = "md:col-start-2 min-w-0"; 

            if (isLoading) {
                const videoSkeletons = Array.from({ length: 12 }).map(() => createSkeleton('card')).map(el => el.outerHTML).join('');
                rightContent.innerHTML = `<section style="min-height: 720px;"><div class="flex items-center justify-between mb-6"><div class="h-8 bg-gray-700 rounded w-1/3 animate-pulse"></div><div class="h-8 bg-gray-700 rounded w-1/4 animate-pulse"></div></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">${videoSkeletons}</div></section>`;
            } else if (apiError) {
                rightContent.innerHTML = createErrorDisplay(apiError);
            } else {
                let baseFilteredVideos;
                if (activeChannelFilter) {
                    baseFilteredVideos = visibleVideos.filter(video => video.channelId === activeChannelFilter.id);
                } else if (activeMemberFilter !== 'all') {
                    const filterKeyword = activeMemberFilter.toLowerCase();
                    baseFilteredVideos = visibleVideos.filter(video => (video.searchableText || '').includes(filterKeyword));
                } else {
                    baseFilteredVideos = visibleVideos;
                }
                
                let filteredVideos;
                if (isClassificationAvailable && activeVideoTypeFilter !== 'all') {
                    filteredVideos = baseFilteredVideos.filter(v => v.videoType === activeVideoTypeFilter);
                } else {
                    filteredVideos = baseFilteredVideos;
                }
                
                const videosForChannelList = baseFilteredVideos;

                if (filteredVideos.length === 0 && (activeMemberFilter !== 'all' || activeChannelFilter || activeVideoTypeFilter !== 'all')) {
                    const filterName = activeChannelFilter ? activeChannelFilter.name : activeMemberFilter;
                    let message = `æ‰¾ä¸åˆ°é—œæ–¼ã€Œ${filterName}ã€çš„å½±ç‰‡ã€‚`;
                    if (activeVideoTypeFilter !== 'all') {
                        message = `æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„ ${activeVideoTypeFilter === 'short' ? 'Shorts çŸ­ç‰‡' : 'ä¸€èˆ¬å½±ç‰‡'}ã€‚`;
                    }
                    rightContent.innerHTML = `<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-lg">${message}</p>`;
                } else {
                    const videosSection = document.createElement('section');
                    videosSection.id = 'videos-section'; 
                    
                    if (activeChannelFilter) {
                        const filterBanner = document.createElement('div');
                        filterBanner.className = 'flex items-center justify-between bg-purple-900/50 text-purple-200 px-4 py-2 rounded-lg mb-6';
                        filterBanner.innerHTML = `
                            <span>ç›®å‰ç¯©é¸ä¸­ï¼š<strong class="font-semibold">${activeChannelFilter.name}</strong></span>
                            <button id="clear-channel-filter-btn" class="p-1 rounded-full hover:bg-white/20 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>`;
                        videosSection.appendChild(filterBanner);
                    }

                    const videosHeader = document.createElement('div');
                    videosHeader.className = "flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4";
                    
                    const titleHTML = `
                        <div class="flex items-center">
                            <h2 class="text-3xl font-bold border-l-4 border-cyan-400 pl-4">ç²¾è¯å½±ç‰‡</h2>
                            <div class="tooltip ml-2">
                                <button class="text-sm bg-gray-600 text-gray-300 rounded-full w-5 h-5 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="èªªæ˜">?</button>
                                <div class="tooltiptext">
                                    <p class="font-semibold mb-2">èªªæ˜ï¼š</p>
                                    <p>1. ä¼ºæœå™¨å¿«å–æ¯ 30 åˆ†é˜æ›´æ–°ä¸€æ¬¡</p>
                                    <p>2. ç‚ºé—œéµå­—æœå°‹ï¼Œæ•…å¯èƒ½å‡ºç¾ï¼š</p>
                                    <div class="pl-4">
                                        <p>a. å«VSPOé—œéµå­—çš„éVSPOçƒ¤è‚‰</p>
                                        <p>b. å«ä¸­æ–‡é—œéµå­—çš„å¤–æ–‡å‰ªè¼¯</p>
                                        <p class="mt-2">æœ‰ä»¥ä¸Šæƒ…å½¢è«‹è‡³é é¦–å›å ±è™•å›å ±</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    const filterControlsHTML = (() => {
                        const latestButtonText = 'æœ€æ–°12éƒ¨';
                        const viewModeButtons = `
                            <div class="flex space-x-2">
                                <button id="view-latest-btn" class="tab-btn ${activeView === 'latest' ? 'active' : ''}">${latestButtonText}</button>
                                <button id="view-all-btn" class="tab-btn ${activeView === 'all' ? 'active' : ''}">ä¸€å€‹æœˆå…§</button>
                            </div>`;

                        if (!isClassificationAvailable) {
                            return `<div class="flex-shrink-0">${viewModeButtons}</div>`;
                        }
                        
                        const desktopTypeFilters = `
                            <div id="desktop-type-filters" class="hidden md:flex space-x-2">
                                <button data-type-filter="all" class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'all' ? 'active' : ''}">å…¨éƒ¨</button>
                                <button data-type-filter="video" class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'video' ? 'active' : ''}">åªçœ‹å½±ç‰‡</button>
                                <button data-type-filter="short" class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'short' ? 'active' : ''}">åªçœ‹Shorts</button>
                            </div>`;
                        
                        const typeLabels = { all: 'å…¨éƒ¨é¡¯ç¤º', video: 'åªçœ‹å½±ç‰‡', short: 'åªçœ‹Shorts' };
                        const mobileTypeFilter = `
                            <div class="relative md:hidden">
                                <button id="mobile-filter-toggle" class="tab-btn type-filter-btn flex items-center space-x-2">
                                    <span>${typeLabels[activeVideoTypeFilter]}</span>
                                    <svg class="w-4 h-4 transition-transform ${isFilterDropdownOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="mobile-filter-menu" class="dropdown-menu ${isFilterDropdownOpen ? 'visible' : ''}">
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-teal-700" data-type-filter="all">å…¨éƒ¨é¡¯ç¤º</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-teal-700" data-type-filter="video">åªçœ‹å½±ç‰‡</a>
                                    <a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-teal-700" data-type-filter="short">åªçœ‹Shorts</a>
                                </div>
                            </div>`;
                        
                        return `
                            <div class="flex w-full md:w-auto items-center justify-between md:justify-start md:space-x-4">
                                <div class="flex items-center space-x-4">
                                    ${desktopTypeFilters}
                                    ${mobileTypeFilter}
                                </div>
                                <div class="md:border-l-2 border-gray-600 md:pl-4">
                                    ${viewModeButtons}
                                </div>
                            </div>
                            `;
                    })();
                    
                    videosHeader.innerHTML = `
                        ${titleHTML}
                        <div class="w-full md:w-auto flex-shrink-0">${filterControlsHTML}</div>
                    `;
                    videosSection.appendChild(videosHeader);

                    const viewContainer = document.createElement('div');
                    viewContainer.style.minHeight = '720px'; 
                    
                    const videosToDisplay = filteredVideos;

                    if (activeView === 'latest') {
                        const grid = document.createElement('div');
                        grid.id = 'latest-videos-grid';
                        const isShortsMode = activeVideoTypeFilter === 'short';
                        
                        let gridClasses = 'grid gap-4 ';
                        if (isShortsMode) {
                            gridClasses += 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 view-mode-shorts-only';
                        } else {
                            gridClasses += 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';
                        }
                        grid.className = gridClasses;

                        const sliceCount = 12;
                        videosToDisplay.slice(0, sliceCount).forEach(video => grid.appendChild(createVideoCard(video)));
                        viewContainer.appendChild(grid);
                    } else { 
                        const listContainer = document.createElement('div');
                        listContainer.className = 'space-y-3';
                        const totalPages = Math.ceil(videosToDisplay.length / itemsPerPage);
                        const startIndex = (currentPage - 1) * itemsPerPage;
                        const paginatedVideos = videosToDisplay.slice(startIndex, startIndex + itemsPerPage);
                        
                        paginatedVideos.forEach(video => listContainer.appendChild(createVideoListItem(video)));
                        viewContainer.appendChild(listContainer);
                        if (totalPages > 1) {
                            viewContainer.appendChild(createPaginationControls(totalPages, currentPage));
                        }
                    }
                    videosSection.appendChild(viewContainer);
                    rightContent.appendChild(videosSection);
                }

                const channelListSection = document.createElement('section');
                const channelListHeader = document.createElement('div');
                channelListHeader.className = 'flex items-baseline mb-6 gap-x-3';
                
                if (activeMemberFilter !== 'all') {
                    const member = allMembers.find(m => m.filter_keyword === activeMemberFilter);
                    const memberColor = member ? member.color : '#fbbf24';
                    channelListHeader.innerHTML = `<h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4 mt-12">ä¸€å€‹æœˆå…§ç™¼å¸ƒé <span style="color: ${memberColor}">${member ? member.name_jp : activeMemberFilter}</span> å‰ªè¼¯çš„é »é“</h2>`;
                } else {
                    channelListHeader.innerHTML = `<h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4 mt-12">ç²¾è¯é »é“åˆ—è¡¨</h2><p class="text-gray-500 text-sm">åƒ…åˆ—å‡º30å¤©å…§æœ‰ç™¼å¸ƒæ–°å½±ç‰‡ä¹‹é »é“</p>`;
                }
                channelListSection.appendChild(channelListHeader);

                const channels = {};
                videosForChannelList.forEach(video => {
                    if (!channels[video.channelId]) {
                        channels[video.channelId] = { id: video.channelId, name: video.channelTitle, subscriberCount: video.subscriberCount, latestVideo: video, avatarUrl: video.channelAvatarUrl };
                    }
                });
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const channelData = Object.values(channels)
                    .filter(channel => new Date(channel.latestVideo.publishedAt) > thirtyDaysAgo)
                    .sort((a, b) => new Date(b.latestVideo.publishedAt) - new Date(a.latestVideo.publishedAt));

                if (channelData.length > 0) {
                    const channelListGrid = document.createElement('div');
                    channelListGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
                    channelData.forEach(channel => channelListGrid.appendChild(createChannelGridCard(channel)));
                    channelListSection.appendChild(channelListGrid);
                } else if (activeMemberFilter !== 'all') {
                    channelListSection.innerHTML += `<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-lg">æ‰¾ä¸åˆ°ä¸€å€‹æœˆå…§ç™¼å¸ƒéã€Œ${activeMemberFilter}ã€å‰ªè¼¯çš„é »é“ã€‚</p>`;
                }
                
                rightContent.appendChild(channelListSection);
            }

            mainGrid.appendChild(filterSection);
            mainGrid.appendChild(rightContent);
            appContainer.appendChild(header);
            appContainer.appendChild(topBar);
            appContainer.appendChild(mainGrid);

            setupEventListeners();

            if (onRenderComplete) {
                onRenderComplete();
            }
        }

        function setupEventListeners() {
            setupSecretTrigger();
            document.getElementById('check-update-btn')?.addEventListener('click', checkForUpdates);
            document.getElementById('manage-blacklist-btn')?.addEventListener('click', showBlacklistModal);
            document.getElementById('view-latest-btn')?.addEventListener('click', () => {
                state.activeView = 'latest';
                render();
            });
            document.getElementById('view-all-btn')?.addEventListener('click', () => {
                state.activeView = 'all';
                state.currentPage = 1;
                render();
            });
            
            document.querySelectorAll('#desktop-type-filters .type-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    state.activeVideoTypeFilter = e.currentTarget.dataset.typeFilter;
                    state.currentPage = 1;
                    render();
                });
            });

            const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
            const mobileFilterMenu = document.getElementById('mobile-filter-menu');
            
            if (mobileFilterToggle) {
                mobileFilterToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    state.isFilterDropdownOpen = !state.isFilterDropdownOpen;
                    render();
                });
                
                mobileFilterMenu.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        state.activeVideoTypeFilter = e.currentTarget.dataset.typeFilter;
                        state.currentPage = 1;
                        state.isFilterDropdownOpen = false;
                        render();
                    });
                });
                
                document.addEventListener('click', (e) => {
                    if (state.isFilterDropdownOpen && !mobileFilterMenu.contains(e.target) && !mobileFilterToggle.contains(e.target)) {
                        state.isFilterDropdownOpen = false;
                        render();
                    }
                });
            }

            document.querySelectorAll('.pagination-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const page = parseInt(e.currentTarget.dataset.page, 10);
                    if (page && page !== state.currentPage) {
                        state.currentPage = page;
                        render(() => window.scrollTo({ top: 0, behavior: 'smooth' }));
                    }
                });
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterList = document.getElementById('member-filter-list-container');
                    const scrollPosition = { top: filterList?.scrollTop || 0, left: filterList?.scrollLeft || 0 };
                    state.activeChannelFilter = null;
                    state.activeMemberFilter = e.currentTarget.dataset.filter;
                    state.currentPage = 1; 
                    render(() => {
                        const newFilterList = document.getElementById('member-filter-list-container');
                        if (newFilterList) {
                            newFilterList.scrollTop = scrollPosition.top;
                            newFilterList.scrollLeft = scrollPosition.left;
                        }
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                });
            });
            
            document.querySelectorAll('.channel-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const button = e.currentTarget;
                    state.activeMemberFilter = 'all';
                    state.activeChannelFilter = { id: button.dataset.channelId, name: button.dataset.channelName };
                    state.currentPage = 1;
                    render(() => window.scrollTo({ top: 0, behavior: 'smooth' }));
                });
            });

            document.getElementById('clear-channel-filter-btn')?.addEventListener('click', () => {
                state.activeChannelFilter = null;
                render();
            });
            
            // â˜… Bug Fix: å„ªåŒ– resize äº‹ä»¶ç›£è½å™¨
            let lastWidth = window.innerWidth;
            window.addEventListener('resize', () => {
                const currentWidth = window.innerWidth;
                const breakpoint = 1280;
                // åªæœ‰åœ¨è·¨è¶Šæ–·é»æ™‚æ‰é‡æ–°æ¸²æŸ“
                if ((lastWidth < breakpoint && currentWidth >= breakpoint) || (lastWidth >= breakpoint && currentWidth < breakpoint)) {
                    if (state.activeView === 'latest') {
                        render();
                    }
                }
                lastWidth = currentWidth;
            });
        }

        async function initializeApp(force = false, password = '', mode = 'normal') {
            state.blacklist = getBlacklist();
            state.isLoading = true;
            render(); 

            // â˜… ä¿®æ­£ï¼šå°‡ç‰ˆæœ¬æª¢æŸ¥ç§»åˆ°æœ€å‰é¢ï¼Œç¢ºä¿ç«‹å³è§¸ç™¼
            const lastSeenVersion = localStorage.getItem(LAST_SEEN_VERSION_KEY);
            if (lastSeenVersion !== CURRENT_APP_VERSION) {
                showVersionUpdateModal(CURRENT_APP_VERSION);
            }

            try {
                const dataPackage = await fetchAllDataFromProxy(force, password, mode);

                if (force && dataPackage.message) {
                    if (dataPackage.sample_videos) {
                        console.log("--- å½±ç‰‡æŠ½æŸ¥çµæœ ---");
                        console.log(dataPackage.sample_videos);
                        alert(`æŠ½æŸ¥çµæœå·²æ‰“å°åˆ°é–‹ç™¼è€…å·¥å…·(F12)çš„ Console ä¸­ã€‚\nè¨Šæ¯: ${dataPackage.message}`);
                    } else {
                        alert(`æ“ä½œå®Œæˆ: ${dataPackage.message}`);
                    }
                    state.isLoading = false;
                    render();
                    return;
                }

                state.allVideos = dataPackage.videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                state.lastUpdated = new Date(dataPackage.timestamp);
                state.totalVisits = dataPackage.totalVisits || 0;
                state.todayVisits = dataPackage.todayVisits || 0;
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±æ•—:", error);
                state.apiError = error.message;
                if (force) {
                    alert(`éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } finally {
                state.isLoading = false;
                render();
            }
        }
        
        function setupSecretTrigger() {
            let sequence = [];
            let lastClickTime = 0;
            const targetSequence = ['ã‚Œ', 'ãª', 'ã¡'];

            document.querySelectorAll('.secret-trigger').forEach(span => {
                span.addEventListener('click', (e) => {
                    const char = e.target.dataset.char;
                    const now = Date.now();
                    if (now - lastClickTime > 3000) sequence = [];
                    sequence.push(char);
                    lastClickTime = now;
                    if (sequence.join('') === targetSequence.join('')) {
                        console.log("ç§˜å¯†é€šé“å·²è§¸ç™¼ï¼");
                        const input = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
                        if (input) {
                            const parts = input.split(',');
                            const password = parts[0];
                            const mode = parts[1] || 'normal'; 
                            alert(`æ­£åœ¨ä»¥ ${mode} æ¨¡å¼åŸ·è¡ŒæŒ‡ä»¤...`);
                            initializeApp(true, password, mode);
                        }
                        sequence = [];
                    }
                    if (sequence.length >= targetSequence.length && sequence.join('') !== targetSequence.join('')) {
                       sequence = [];
                    }
                });
            });
        }

        initializeApp();

    </script>
</body>
</html>