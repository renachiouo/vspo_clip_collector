<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>れなち的VSPO精華收集處</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: #111827;
        }

        .video-thumbnail-container {
            aspect-ratio: 16 / 9;
            transition: aspect-ratio 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .view-mode-shorts-only .video-thumbnail-container {
            aspect-ratio: 9 / 16;
        }

        .view-mode-shorts-only .group h3 {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        .view-mode-shorts-only .group .text-sm {
            font-size: 0.75rem;
            line-height: 1rem;
        }

        .view-mode-shorts-only .group .w-6.h-6 {
            width: 1.25rem;
            height: 1.25rem;
        }

        .view-mode-shorts-only .group .p-4 {
            padding: 0.75rem;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 30;
            bottom: 150%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4b5563;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext,
        .tooltip:focus-within .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .secret-trigger {
            cursor: pointer;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            background-color: #374151;
            color: #d1d5db;
            transition: background-color 0.2s, opacity 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn.active,
        .tab-btn:hover:not(:disabled) {
            background-color: #4f46e5;
            color: #fff;
        }

        .type-filter-btn.active,
        .type-filter-btn:hover:not(:disabled) {
            background-color: #0d9488;
            color: #fff;
        }

        .tab-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .pagination-btn {
            min-width: 2.5rem;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            background-color: #374151;
            color: #d1d5db;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            text-align: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #4f46e5;
        }

        .pagination-btn.active {
            background-color: #4f46e5;
            color: #fff;
            border-color: #4f46e5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-ellipsis {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5rem;
            padding: 0.5rem;
            color: #9ca3af;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .filter-btn:hover {
            transform: scale(1.03);
        }

        .filter-btn[data-filter="all"] {
            background-color: #4b5563;
            color: #ffffff;
        }

        .filter-btn[data-filter="all"].active {
            background-color: #6366f1;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }

        .filter-btn.active {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.25);
            transform: scale(1.02);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .modal-overlay,
        .dropdown-menu {
            position: fixed;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal-overlay {
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.visible,
        .dropdown-menu.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 95%;
            width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .dropdown-menu {
            position: absolute;
            background-color: #1f2937;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
            min-width: 10rem;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .dropdown-menu.visible {
            transform: translateY(0);
        }

        .spinner {
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin .6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 語言切換按鈕樣式 */
        .lang-switcher-btn {
            padding: 0.5rem 1.5rem;
            border: 2px solid transparent;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .lang-switcher-btn.active {
            border-color: #6366f1;
            background-color: #4338ca;
            color: #ffffff;
        }

        .lang-switcher-btn:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }

        /* --- START: Admin UI 新增樣式 --- */
        .admin-modal-content {
            width: 90vw;
            max-width: 1000px;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .admin-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid #374151;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            overflow-x: auto;
            overflow-y: hidden;
            /* 禁止垂直滾動 */
            flex-shrink: 0;
            /* 防止被壓縮 */
        }

        .admin-tabs::-webkit-scrollbar {
            height: 8px;
        }

        .admin-tabs::-webkit-scrollbar-track {
            background: #1f2937;
            /* gray-800 */
            border-radius: 4px;
        }

        .admin-tabs::-webkit-scrollbar-thumb {
            background: #4b5563;
            /* gray-600 */
            border-radius: 4px;
        }

        .admin-tabs::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
            /* gray-500 */
        }



        .admin-tab-btn {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: #9ca3af;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .admin-tab-btn:hover {
            color: #e5e7eb;
        }

        .admin-tab-btn.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
        }

        .admin-tab-content {
            display: none;
            padding-top: 1.5rem;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background-color: #374151;
            border-radius: 0.375rem;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .admin-list-item:hover {
            border-color: #4f46e5;
        }

        .admin-list-item img {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
        }

        .admin-list-item .channel-name {
            flex-grow: 1;
            font-weight: 500;
            min-width: 0;
        }

        .admin-list-item .channel-name span {
            display: block;
        }

        .admin-list-item .channel-name .name {
            color: #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-list-item .channel-name .id {
            font-size: 0.75rem;
            color: #9ca3af;
            font-family: monospace;
        }

        .admin-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .admin-btn:active {
            transform: scale(0.95);
        }

        .admin-btn-approve {
            background-color: #22c55e;
            color: #fff;
        }

        .admin-btn-approve:hover {
            background-color: #16a34a;
        }

        .admin-btn-reject {
            background-color: #ef4444;
            color: #fff;
        }

        .admin-btn-reject:hover {
            background-color: #dc2626;
        }

        .admin-btn-delete {
            background-color: #6b7280;
            color: #fff;
        }

        .admin-btn-delete:hover {
            background-color: #4b5563;
        }

        .admin-btn-add {
            background-color: #6366f1;
            color: #fff;
        }

        .admin-btn-add:hover {
            background-color: #4f46e5;
        }

        .admin-add-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .admin-add-form input {
            flex-grow: 1;
            background-color: #4b5563;
            border: 1px solid #6b7280;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            color: #fff;
            outline: none;
        }

        .admin-add-form input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #4f46e5;
        }

        /* --- END: Admin UI 新增樣式 --- */

        /* --- START: 公告欄樣式 --- */
        #announcement-banner {
            display: none;
            position: relative;
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 40;
            transition: transform 0.3s ease-in-out;
        }

        #announcement-banner.visible {
            display: flex;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        #announcement-banner.type-info {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2) 0%, rgba(30, 64, 175, 0.2) 100%);
            border-bottom-color: rgba(59, 130, 246, 0.3);
        }

        #announcement-banner.type-warning {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.2) 0%, rgba(180, 83, 9, 0.2) 100%);
            border-bottom-color: rgba(245, 158, 11, 0.3);
        }

        #announcement-banner.type-critical {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.2) 0%, rgba(153, 27, 27, 0.2) 100%);
            border-bottom-color: rgba(239, 68, 68, 0.3);
        }

        .announcement-content {
            flex-grow: 1;
            text-align: center;
            font-weight: 500;
            color: #f3f4f6;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .announcement-icon {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
        }

        .type-info .announcement-icon {
            color: #60a5fa;
        }

        .type-warning .announcement-icon {
            color: #fbbf24;
        }

        .type-critical .announcement-icon {
            color: #f87171;
        }

        #close-announcement-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.2s, background-color 0.2s;
            margin-left: 1rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            /* Mobile friendly touch target */
            min-width: 44px;
        }

        #close-announcement-btn:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* --- END: 公告欄樣式 --- */
    </style>
</head>


<body class="bg-gray-900 text-white font-sans">

    <!-- 公告欄容器 -->
    <div id="announcement-banner">
        <div class="announcement-content">
            <svg class="announcement-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="announcement-text"></span>
        </div>
        <button id="close-announcement-btn" aria-label="關閉公告">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <div id="app"></div>

    <script type="module">
        // --- 全域變數與狀態管理 ---
        const CURRENT_APP_VERSION = 'V12.0';
        const API_BASE_URL = 'https://vspo-proxy-git-main-renas-projects-c8ce958b.vercel.app/api';
        const BLACKLIST_KEY = 'vspo_channel_blacklist';
        const LAST_SEEN_VERSION_KEY = 'vspo_last_seen_version';
        const LANGUAGE_KEY = 'vspo_active_language';

        let state = {
            allVideos: [],
            blacklist: [],
            isLoading: true,
            isClassifying: false,
            needsClassification: false,
            classificationIntervalId: null,
            lastUpdated: null,
            apiError: null,
            totalVisits: 0,
            todayVisits: 0,
            activeView: 'latest',
            activeVideoTypeFilter: 'all',
            isFilterDropdownOpen: false,
            currentPage: 1,
            itemsPerPage: 10,
            activeMemberFilter: 'all',
            activeChannelFilter: null,
            activeLanguage: 'cn',
        };

        const appContainer = document.getElementById('app');

        // 版本更新日誌
        const UPDATE_LOGS = {
            'V12.0': {
                title: 'V12.0 自動搜索！',
                date: '2025-12-04',
                features: [
                    '【功能增強】現在會由系統自動探索新頻道。',
                ]
            },
            'V11.1': {
                title: 'V11.1 BUG修復',
                date: '2025-08-23',
                features: ['【BUG修復】修復「只看影片」分類失效問題',]
            },
            'V11.0': {
                title: 'V11.0 日文精華支援',
                date: '2025-08-19',
                features: [
                    '【重大更新】新增「日文精華」頁面，可在頂部自由切換！',
                    '【重大更新】新增「同元配信」可查看「同場直播」之剪輯！',
                ]
            },
            'V10.0': {
                title: 'V10.0 效能升級！',
                date: '2025-07-21',
                features: [
                    '【架構升級】頁面載入速度提升 90%！',
                    '【無縫體驗】分類過程中篩選按鈕會顯示「分類中」，完成後自動解鎖，無需手動重整。',
                    '【自動更新】現在啟動應用程式時，會自動在背景檢查是否有新版本，需要時才會提示您更新。',
                ]
            },
        };

        // VSPO 成員資料 (與您原先相同)
        const vspoJPMembers = [{ "name_jp": "花芽すみれ", "filter_keyword": "花芽すみれ", "color": "#b0c4de" }, { "name_jp": "花芽なずな", "filter_keyword": "花芽なずな", "color": "#fabedc" }, { "name_jp": "小雀とと", "filter_keyword": "小雀とと", "color": "#f5eb4a" }, { "name_jp": "一ノ瀬うるは", "filter_keyword": "一ノ瀬うるは", "color": "#4182fa" }, { "name_jp": "胡桃のあ", "filter_keyword": "胡桃のあ", "color": "#ffdbfe" }, { "name_jp": "兎咲ミミ", "filter_keyword": "兎咲ミミ", "color": "#c7b2d6" }, { "name_jp": "空澄セナ", "filter_keyword": "空澄セナ", "color": "#ffffff" }, { "name_jp": "橘ひなの", "filter_keyword": "橘ひなの", "color": "#fa96c8" }, { "name_jp": "英リサ", "filter_keyword": "英リサ", "color": "#d1de79" }, { "name_jp": "如月れん", "filter_keyword": "如月れん", "color": "#be2152" }, { "name_jp": "神成きゅぴ", "filter_keyword": "神成きゅぴ", "color": "#ffd23c" }, { "name_jp": "八雲べに", "filter_keyword": "八雲べに", "color": "#85cab3" }, { "name_jp": "藍沢エマ", "filter_keyword": "藍沢エマ", "color": "#b4f1f9" }, { "name_jp": "紫宮るな", "filter_keyword": "紫宮るな", "color": "#d6adff" }, { "name_jp": "猫汰つな", "filter_keyword": "猫汰つな", "color": "#ff3652" }, { "name_jp": "白波らむね", "filter_keyword": "白波らむね", "color": "#8eced9" }, { "name_jp": "小森めと", "filter_keyword": "小森めと", "color": "#fba03f" }, { "name_jp": "夢野あかり", "filter_keyword": "夢野あかり", "color": "#ff998d" }, { "name_jp": "夜乃くろむ", "filter_keyword": "夜乃くろむ", "color": "#909ec8" }, { "name_jp": "紡木こかげ", "filter_keyword": "紡木こかげ", "color": "#5195e1" }, { "name_jp": "千燈ゆうひ", "filter_keyword": "千燈ゆうひ", "color": "#ed784a" }, { "name_jp": "蝶屋はなび", "filter_keyword": "蝶屋はなび", "color": "#ea5506" }, { "name_jp": "甘結もか", "filter_keyword": "甘結もか", "color": "#eca0aa" }];
        const otherMemberGroups = { "VSPO! EN": [{ "name_jp": "Remia Aotsuki", "filter_keyword": "Remia", "color": "#398FB2", "forceWhiteText": true }, { "name_jp": "Arya Kuroha", "filter_keyword": "Arya", "color": "#000000", "forceWhiteText": true }, { "name_jp": "Jira Jisaki", "filter_keyword": "Jira", "color": "#606D3D", "forceWhiteText": true }, { "name_jp": "Narin Mikure", "filter_keyword": "Narin", "color": "#F3A6EF", "forceWhiteText": true }, { "name_jp": "Riko Solari", "filter_keyword": "Riko", "color": "#9373D7", "forceWhiteText": true }, { "name_jp": "Eris Suzukami", "filter_keyword": "Eris", "color": "#E9F3FD" }], "VSPO! CN": [{ "name_jp": "小针彩", "filter_keyword": "小針彩", "color": "#FE688D", "forceWhiteText": true }, { "name_jp": "白咲露理", "filter_keyword": "白咲露理", "color": "#E9E5E6", "forceWhiteText": true }, { "name_jp": "帕妃", "filter_keyword": "帕妃", "color": "#9F0019", "forceWhiteText": true }, { "name_jp": "千郁郁", "filter_keyword": "千郁郁", "color": "#8986C0", "forceWhiteText": true }] };
        const allMembers = [...vspoJPMembers, ...Object.values(otherMemberGroups).flat()];

        // --- 黑名單 & Modal 相關函式 (與之前相同) ---
        function getBlacklist() { try { const stored = localStorage.getItem(BLACKLIST_KEY); return stored ? JSON.parse(stored) : []; } catch (e) { console.error("讀取黑名單失敗:", e); return []; } }
        function saveBlacklist(blacklist) { try { localStorage.setItem(BLACKLIST_KEY, JSON.stringify(blacklist)); } catch (e) { console.error("儲存黑名單失敗:", e); } }
        function addToBlacklist(channel) { const currentBlacklist = getBlacklist(); if (!currentBlacklist.some(item => item.id === channel.id)) { const newBlacklist = [...currentBlacklist, channel]; saveBlacklist(newBlacklist); state.blacklist = newBlacklist; render(); showBlacklistModal(); } }
        function removeFromBlacklist(channelId) { const currentBlacklist = getBlacklist(); const newBlacklist = currentBlacklist.filter(item => item.id !== channelId); saveBlacklist(newBlacklist); state.blacklist = newBlacklist; render(); showBlacklistModal(); }
        function showBlacklistModal() {
            const existingModal = document.getElementById('blacklist-modal');
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'blacklist-modal';
            modalOverlay.className = 'modal-overlay visible';
            const currentBlacklist = getBlacklist();
            const allChannels = [...new Map(state.allVideos.map(v => [v.channelId, { id: v.channelId, name: v.channelTitle }])).values()].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            const channelsToBlock = allChannels.filter(channel => !currentBlacklist.some(b => b.id === channel.id));
            let blockedListHTML = '<p class="text-gray-400 text-sm">目前沒有已封鎖の頻道。</p>';
            if (currentBlacklist.length > 0) {
                blockedListHTML = currentBlacklist.map(channel => `<div class="flex items-center justify-between p-2 bg-gray-700 rounded-md"><span class="truncate">${channel.name}</span><button class="unblock-btn text-red-400 hover:text-red-300 font-semibold text-sm" data-channel-id="${channel.id}">解除封鎖</button></div>`).join('');
            }
            modalOverlay.innerHTML = `<div class="modal-content"><h3 class="text-2xl font-bold text-red-400 mb-4">管理個人黑名單</h3><div class="mb-6"><h4 class="font-semibold mb-2 text-gray-300">已封鎖清單</h4><div class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-900 rounded-lg">${blockedListHTML}</div></div><div class="border-t border-gray-600 pt-6"><h4 class="font-semibold mb-2 text-gray-300">新增封鎖</h4><div class="flex space-x-2"><select id="channel-to-block-select" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-400"><option value="">-- 請選擇要封鎖的頻道 --</option>${channelsToBlock.map(c => `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`).join('')}</select><button id="add-to-blacklist-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex-shrink-0">封鎖</button></div></div><button id="close-blacklist-modal-btn" class="mt-8 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">關閉</button></div>`;
            document.body.appendChild(modalOverlay);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay || e.target.id === 'close-blacklist-modal-btn' || e.target.closest('#close-blacklist-modal-btn')) { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); } });
            document.getElementById('add-to-blacklist-btn').addEventListener('click', () => { const select = document.getElementById('channel-to-block-select'); const channelId = select.value; if (channelId) { const selectedOption = select.options[select.selectedIndex]; const channelName = selectedOption.dataset.name; addToBlacklist({ id: channelId, name: channelName }); } });
            document.querySelectorAll('.unblock-btn').forEach(btn => { btn.addEventListener('click', (e) => { const channelId = e.currentTarget.dataset.channelId; removeFromBlacklist(channelId); }); });
        }
        function showUpdateModal(title, message, showDownloadButton = false) {
            const existingModal = document.getElementById('update-modal');
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'update-modal';
            modalOverlay.className = 'modal-overlay';
            let downloadButtonHTML = '';
            if (showDownloadButton) { const releaseUrl = "https://github.com/renachiouo/vspo_clip_collector/releases"; if (navigator.userAgent.toLowerCase().includes('wv')) { downloadButtonHTML = `<div class="mt-6 p-3 bg-gray-900 rounded-lg"><p class="text-sm text-gray-400 mb-2">請複製以下網址，並在您的手機瀏覽器中開啟以下載更新：</p><input type="text" readonly value="${releaseUrl}" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none select-all"></div>`; } else { downloadButtonHTML = `<a href="${releaseUrl}" target="_blank" rel="noopener noreferrer" class="mt-6 block w-full text-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors">前往下載頁面</a>`; } }
            modalOverlay.innerHTML = `<div class="modal-content"><h3 class="text-2xl font-bold text-cyan-400 mb-4">${title}</h3><p class="text-gray-300">${message}</p>${downloadButtonHTML}<button id="close-modal-btn" class="mt-4 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">關閉</button></div>`;
            document.body.appendChild(modalOverlay);
            setTimeout(() => modalOverlay.classList.add('visible'), 10);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay || e.target.id === 'close-modal-btn' || e.target.closest('#close-modal-btn')) { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); } });
            const urlInput = modalOverlay.querySelector('input[type="text"]'); if (urlInput) { urlInput.addEventListener('click', () => urlInput.select()); }
        }
        function showVersionUpdateModal(versionsToShow) {
            const existingModal = document.getElementById('version-update-modal');
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'version-update-modal';
            modalOverlay.className = 'modal-overlay';
            let allFeaturesHTML = '';
            if (Array.isArray(versionsToShow)) {
                versionsToShow.forEach((version, index) => {
                    const log = UPDATE_LOGS[version]; if (!log) return;
                    const featuresHTML = log.features.map(feature => `<li class="flex items-start"><svg class="w-5 h-5 mr-2 text-green-400 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>${feature}</span></li>`).join('');
                    allFeaturesHTML += `${index > 0 ? '<hr class="border-gray-600 my-4">' : ''}<div class="text-center mb-4"><h4 class="text-xl font-bold text-green-400">${log.title}</h4><p class="text-xs text-gray-500">發布日期: ${log.date}</p></div><ul class="space-y-3 text-gray-300">${featuresHTML}</ul>`;
                });
            }
            modalOverlay.innerHTML = `<div class="modal-content">${allFeaturesHTML}<button id="close-version-modal-btn" class="mt-8 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">我了解了</button></div>`;
            document.body.appendChild(modalOverlay);
            setTimeout(() => modalOverlay.classList.add('visible'), 10);
            const closeModal = () => { modalOverlay.classList.remove('visible'); localStorage.setItem(LAST_SEEN_VERSION_KEY, CURRENT_APP_VERSION); setTimeout(() => modalOverlay.remove(), 300); };
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay || e.target.id === 'close-version-modal-btn' || e.target.closest('#close-version-modal-btn')) { closeModal(); } });
        }

        async function showRelatedClipsModal(originalStreamInfo) {
            const modalId = 'related-clips-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = modalId;
            modalOverlay.className = 'modal-overlay visible';
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '1200px';
            modalContent.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-teal-400">同場直播所有剪輯</h3>
                <button id="close-related-clips-modal-btn" class="p-2 rounded-full hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="related-clips-container" class="max-h-[75vh] overflow-y-auto p-1">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${Array.from({ length: 4 }).map(() => createSkeleton('card').outerHTML).join('')}
                </div>
            </div>`;
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            const closeModal = () => { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); };
            modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
            document.getElementById('close-related-clips-modal-btn').addEventListener('click', closeModal);

            try {
                const data = await fetchApi('get-related-clips', { params: { platform: originalStreamInfo.platform, id: originalStreamInfo.id } });
                const container = document.getElementById('related-clips-container');
                if (data.videos && data.videos.length > 0) {
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
                    data.videos.forEach(video => grid.appendChild(createVideoCard(video, true)));
                    container.innerHTML = '';
                    container.appendChild(grid);
                } else {
                    container.innerHTML = `<p class="text-center text-gray-400 p-8">找不到其他相關剪輯。</p>`;
                }
            } catch (error) {
                console.error("獲取相關剪輯失敗:", error);
                document.getElementById('related-clips-container').innerHTML = createErrorDisplay(error.message);
            }
        }

        // --- START: Admin UI 新增函式 ---
        async function showAdminUI(password, activeTab = 'pending_jp') {
            const modalId = 'admin-ui-modal';
            let modalOverlay = document.getElementById(modalId);
            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.id = modalId;
                modalOverlay.className = 'modal-overlay';
                document.body.appendChild(modalOverlay);
                const closeModal = () => { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); };
                modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
            }

            modalOverlay.innerHTML = `<div class="modal-content admin-modal-content">
            <h3 class="text-2xl font-bold text-indigo-400 mb-4">管理員後台</h3>
            <div class="flex-grow flex items-center justify-center">
                <div class="spinner text-indigo-400" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
                <p class="ml-4 text-lg text-gray-400">正在載入列表資料...</p>
            </div>
            <button id="close-admin-modal-btn" class="mt-4 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">關閉</button>
        </div>`;
            modalOverlay.querySelector('#close-admin-modal-btn').addEventListener('click', () => {
                modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300);
            });

            setTimeout(() => modalOverlay.classList.add('visible'), 10);

            try {
                const listsData = await fetchApi('admin/lists', { params: { password } });
                modalOverlay.innerHTML = createAdminModalHTML(listsData, password, activeTab);
                setupAdminModalEventListeners(password);
            } catch (error) {
                console.error('載入管理列表失敗:', error);
                modalOverlay.querySelector('.modal-content').innerHTML = `
                <h3 class="text-2xl font-bold text-red-500 mb-4">錯誤</h3>
                <p class="text-gray-300">無法載入管理列表資料。請檢查您的密碼或網路連線。</p>
                <p class="mt-2 text-sm text-gray-500 bg-gray-800 p-2 rounded">${error.message}</p>
                 <button onclick="this.closest('.modal-overlay').remove()" class="mt-4 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">關閉</button>
            `;
            }
        }

        function createAdminModalHTML(listsData, password, activeTab = 'pending_jp') {
            const createListItems = (list, type) => {
                if (!list || list.length === 0) {
                    return '<p class="text-gray-500 text-center py-8">這個列表是空的。</p>';
                }
                return list.map(channel => `
                <div class="admin-list-item">
                    <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-4 flex-grow min-w-0 hover:opacity-80 transition-opacity group text-decoration-none">
                        <img src="${channel.avatar}" alt="${channel.name}">
                        <div class="channel-name">
                            <span class="name group-hover:text-indigo-400 transition-colors">${channel.name}</span>
                            <span class="id">${channel.id}</span>
                        </div>
                    </a>
                    <div class="ml-auto flex-shrink-0 flex gap-2">
                        ${type === 'pending' ? `
                            <button class="admin-btn admin-btn-approve" data-action="approve_jp" data-channel-id="${channel.id}">核准</button>
                            <button class="admin-btn admin-btn-reject" data-action="reject_jp" data-channel-id="${channel.id}">否決</button>
                        ` : ''}
                        ${type === 'whitelist_jp' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="jp" data-channel-id="${channel.id}">刪除</button>` : ''}
                        ${type === 'whitelist_cn' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="cn" data-channel-id="${channel.id}">刪除</button>` : ''}
                        ${type === 'blacklist_cn' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="blacklist_cn" data-channel-id="${channel.id}">解除封鎖</button>` : ''}
                        ${type === 'blacklist_jp' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="blacklist_jp" data-channel-id="${channel.id}">解除封鎖</button>` : ''}
                    </div>
                </div>
            `).join('');
            };

            return `
            <div class="modal-content admin-modal-content">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 class="text-2xl font-bold text-indigo-400">管理員後台</h3>
                    <div class="flex gap-2">
                         <button class="admin-btn-refresh bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors" data-lang="cn">立即更新中文資料</button>
                         <button class="admin-btn-refresh bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors" data-lang="jp">立即更新日文資料</button>
                        <button id="close-admin-modal-btn" class="p-2 rounded-full hover:bg-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="admin-tabs overflow-x-auto">
                    <button class="admin-tab-btn ${activeTab === 'pending_jp' ? 'active' : ''} whitespace-nowrap" data-tab="pending_jp">待審核日文 <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-yellow-500/20 text-yellow-300">${listsData.pending_jp?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'whitelist_jp' ? 'active' : ''} whitespace-nowrap" data-tab="whitelist_jp">日文白名單 <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-blue-500/20 text-blue-300">${listsData.whitelist_jp?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'whitelist_cn' ? 'active' : ''} whitespace-nowrap" data-tab="whitelist_cn">中文白名單 <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-green-500/20 text-green-300">${listsData.whitelist_cn?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'blacklist_cn' ? 'active' : ''} whitespace-nowrap" data-tab="blacklist_cn">中文黑名單 <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-500/20 text-red-300">${listsData.blacklist_cn?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'blacklist_jp' ? 'active' : ''} whitespace-nowrap" data-tab="blacklist_jp">日文黑名單 <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-500/20 text-red-300">${listsData.blacklist_jp?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'backfill' ? 'active' : ''} whitespace-nowrap" data-tab="backfill">資料回填</button>
                    <button class="admin-tab-btn ${activeTab === 'announcement' ? 'active' : ''} whitespace-nowrap" data-tab="announcement">公告管理</button>
                </div>
                <div class="flex-grow min-h-0 overflow-y-auto">
                    <div id="tab-pending_jp" class="admin-tab-content ${activeTab === 'pending_jp' ? 'active' : ''} space-y-2">${createListItems(listsData.pending_jp, 'pending')}</div>
                    <div id="tab-whitelist_jp" class="admin-tab-content ${activeTab === 'whitelist_jp' ? 'active' : ''} space-y-2">
                        <div class="admin-add-form"><input type="text" id="add-jp-input" placeholder="輸入要新增的頻道 ID..."><button class="admin-btn admin-btn-add" data-action="add" data-list-type="jp" data-input-id="add-jp-input">手動新增</button></div>
                        ${createListItems(listsData.whitelist_jp, 'whitelist_jp')}
                    </div>
                    <div id="tab-whitelist_cn" class="admin-tab-content ${activeTab === 'whitelist_cn' ? 'active' : ''} space-y-2">
                        <div class="admin-add-form"><input type="text" id="add-cn-input" placeholder="輸入要新增的頻道 ID..."><button class="admin-btn admin-btn-add" data-action="add" data-list-type="cn" data-input-id="add-cn-input">手動新增</button></div>
                        ${createListItems(listsData.whitelist_cn, 'whitelist_cn')}
                    </div>
                    <div id="tab-blacklist_cn" class="admin-tab-content ${activeTab === 'blacklist_cn' ? 'active' : ''} space-y-2">
                         <div class="admin-add-form"><input type="text" id="add-blacklist-cn-input" placeholder="輸入要封鎖的頻道 ID..."><button class="admin-btn admin-btn-add bg-red-600 hover:bg-red-700" data-action="add" data-list-type="blacklist_cn" data-input-id="add-blacklist-cn-input">手動封鎖</button></div>
                        ${createListItems(listsData.blacklist_cn, 'blacklist_cn')}
                    </div>
                    <div id="tab-blacklist_jp" class="admin-tab-content ${activeTab === 'blacklist_jp' ? 'active' : ''} space-y-2">
                         <div class="admin-add-form"><input type="text" id="add-blacklist-jp-input" placeholder="輸入要封鎖的頻道 ID..."><button class="admin-btn admin-btn-add bg-red-600 hover:bg-red-700" data-action="add" data-list-type="blacklist_jp" data-input-id="add-blacklist-jp-input">手動封鎖</button></div>
                        ${createListItems(listsData.blacklist_jp, 'blacklist_jp')}
                    </div>
                    <div id="tab-backfill" class="admin-tab-content ${activeTab === 'backfill' ? 'active' : ''} space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-indigo-400 mb-4">歷史資料回填</h4>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">開始日期</label>
                                        <input type="date" id="backfill-start-date" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">結束日期</label>
                                        <input type="date" id="backfill-end-date" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">目標語言</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="backfill-lang" value="cn" checked class="text-indigo-500 focus:ring-indigo-500">
                                            <span class="text-gray-300">中文 (VSPO中文, VSPO精華...)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="backfill-lang" value="jp" class="text-indigo-500 focus:ring-indigo-500">
                                            <span class="text-gray-300">日文 (ぶいすぽ 切り抜き...)</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">關鍵字 (可複選，請謹慎選擇以節省 Quota)</label>
                                    <div id="backfill-keywords-container" class="grid grid-cols-2 gap-2 bg-gray-700 p-2 rounded border border-gray-600">
                                        <!-- JS will populate this -->
                                    </div>
                                </div>
                                <div class="pt-2">
                                    <button id="start-backfill-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors">開始回填任務</button>
                                </div>
                                <div id="backfill-log" class="mt-4 p-2 bg-black rounded text-xs font-mono text-green-400 h-32 overflow-y-auto hidden"></div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-announcement" class="admin-tab-content ${activeTab === 'announcement' ? 'active' : ''} space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-indigo-400 mb-4">發布新公告</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">公告內容</label>
                                    <textarea id="announcement-content" rows="3" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="輸入公告內容...">${listsData.announcement?.content || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">公告類型</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="announcement-type" value="info" ${!listsData.announcement?.type || listsData.announcement?.type === 'info' ? 'checked' : ''} class="text-blue-500 focus:ring-blue-500">
                                            <span class="text-blue-300">一般 (Info)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="announcement-type" value="warning" ${listsData.announcement?.type === 'warning' ? 'checked' : ''} class="text-yellow-500 focus:ring-yellow-500">
                                            <span class="text-yellow-300">注意 (Warning)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="announcement-type" value="critical" ${listsData.announcement?.type === 'critical' ? 'checked' : ''} class="text-red-500 focus:ring-red-500">
                                            <span class="text-red-300">緊急 (Critical)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="announcement-active" class="sr-only peer" ${listsData.announcement?.active === 'true' ? 'checked' : ''}>
                                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-300">啟用公告</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <button id="save-announcement-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors">儲存設定</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function setupAdminModalEventListeners(password) {
            const modal = document.getElementById('admin-ui-modal');
            if (!modal) return;

            modal.querySelector('#close-admin-modal-btn').addEventListener('click', () => {
                modal.classList.remove('visible');
                setTimeout(() => modal.remove(), 300);
            });

            modal.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.querySelector('.admin-tab-btn.active').classList.remove('active');
                    modal.querySelector('.admin-tab-content.active').classList.remove('active');
                    btn.classList.add('active');
                    modal.querySelector(`#tab-${btn.dataset.tab}`).classList.add('active');
                });
            });

            modal.querySelectorAll('.admin-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const { action, listType, channelId, inputId } = e.currentTarget.dataset;
                    let finalChannelId = channelId;
                    if (action === 'add') {
                        const input = document.getElementById(inputId);
                        finalChannelId = input.value.trim();
                        if (!finalChannelId) { alert('頻道 ID 不能為空！'); return; }
                    }

                    if (!confirm(`確定要對頻道 ${finalChannelId} 執行「${action}」操作嗎？`)) return;

                    await performAdminAction(action, finalChannelId, listType, password);
                });
            });

            modal.querySelectorAll('.admin-btn-refresh').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const lang = e.currentTarget.dataset.lang;
                    const langText = lang === 'cn' ? '中文' : '日文';
                    if (!confirm(`確定要立即強制更新${langText}資料嗎？這可能需要幾分鐘的時間。`)) return;

                    const originalText = btn.innerText;
                    btn.innerText = '更新中...';
                    btn.disabled = true;

                    try {
                        await fetchApi('youtube', {
                            params: { force_refresh: 'true', lang: lang, password: password }
                        });
                        alert(`${langText}資料更新請求已發送並完成！`);
                    } catch (error) {
                        console.error(`更新失敗:`, error);
                        alert(`更新失敗: ${error.message}`);
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                });
            });

            // 公告儲存按鈕事件
            const saveAnnouncementBtn = modal.querySelector('#save-announcement-btn');
            if (saveAnnouncementBtn) {
                saveAnnouncementBtn.addEventListener('click', async () => {
                    const content = modal.querySelector('#announcement-content').value.trim();
                    const type = modal.querySelector('input[name="announcement-type"]:checked').value;
                    const active = modal.querySelector('#announcement-active').checked;

                    if (!content && active) {
                        alert('啟用公告時，內容不能為空！');
                        return;
                    }

                    const originalText = saveAnnouncementBtn.innerText;
                    saveAnnouncementBtn.innerText = '儲存中...';
                    saveAnnouncementBtn.disabled = true;

                    try {
                        await performAdminAction('update_announcement', null, null, password, { content, type, active });
                        alert('公告設定已儲存！');
                    } catch (error) {
                        alert(`儲存失敗: ${error.message}`);
                    } finally {
                        saveAnnouncementBtn.innerText = originalText;
                        saveAnnouncementBtn.disabled = false;
                    }
                });
            }

            // 回填功能邏輯
            const backfillTabBtn = modal.querySelector('.admin-tab-btn[data-tab="backfill"]');
            if (backfillTabBtn) {
                const keywordsContainer = modal.querySelector('#backfill-keywords-container');
                const cnKeywords = ["VSPO中文", "VSPO中文精華", "VSPO精華", "VSPO中文剪輯", "VSPO剪輯", "ぶいすぽっ！許諾番号"];
                const jpKeywords = ["ぶいすぽ 切り抜き", "ぶいすぽっ！許諾番号"];

                const updateKeywords = () => {
                    const lang = modal.querySelector('input[name="backfill-lang"]:checked').value;
                    const keywords = lang === 'cn' ? cnKeywords : jpKeywords;
                    keywordsContainer.innerHTML = keywords.map(k => `
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="${k}" checked class="text-indigo-500 focus:ring-indigo-500">
                            <span class="text-gray-300 text-sm">${k}</span>
                        </label>
                    `).join('');
                };

                modal.querySelectorAll('input[name="backfill-lang"]').forEach(radio => {
                    radio.addEventListener('change', updateKeywords);
                });
                updateKeywords(); // Initialize

                const startBackfillBtn = modal.querySelector('#start-backfill-btn');
                const logDiv = modal.querySelector('#backfill-log');

                startBackfillBtn.addEventListener('click', async () => {
                    const startDateStr = modal.querySelector('#backfill-start-date').value;
                    const endDateStr = modal.querySelector('#backfill-end-date').value;
                    const lang = modal.querySelector('input[name="backfill-lang"]:checked').value;
                    const selectedKeywords = Array.from(modal.querySelectorAll('#backfill-keywords-container input:checked')).map(cb => cb.value);

                    if (!startDateStr || !endDateStr) { alert('請選擇開始與結束日期'); return; }
                    if (selectedKeywords.length === 0) { alert('請至少選擇一個關鍵字'); return; }

                    const startDate = new Date(startDateStr);
                    const endDate = new Date(endDateStr);
                    if (startDate > endDate) { alert('開始日期不能晚於結束日期'); return; }

                    if (!confirm(`確定要開始回填嗎？\n日期: ${startDateStr} ~ ${endDateStr}\n語言: ${lang}\n關鍵字: ${selectedKeywords.join(', ')}\n\n這將會消耗大量 YouTube API Quota，請確認！`)) return;

                    startBackfillBtn.disabled = true;
                    startBackfillBtn.innerText = '回填進行中...';
                    logDiv.classList.remove('hidden');
                    logDiv.innerHTML = '--- 任務開始 ---\n';

                    const log = (msg) => {
                        logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
                        logDiv.scrollTop = logDiv.scrollHeight;
                    };

                    let currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        const dateStr = currentDate.toISOString().split('T')[0];
                        log(`正在處理: ${dateStr}...`);

                        try {
                            const res = await fetchApi('admin/manage', {
                                method: 'POST',
                                body: { action: 'backfill', date: dateStr, lang, keywords: selectedKeywords, password }
                            });
                            log(`完成: ${dateStr} - 新增/更新 ${res.count} 部影片`);
                        } catch (err) {
                            log(`錯誤: ${dateStr} - ${err.message}`);
                        }

                        currentDate.setDate(currentDate.getDate() + 1);
                        // 簡單的延遲以避免過於密集的請求 (雖然是序列執行)
                        await new Promise(r => setTimeout(r, 1000));
                    }

                    log('--- 任務結束 ---');
                    startBackfillBtn.disabled = false;
                    startBackfillBtn.innerText = '開始回填任務';
                    alert('回填任務已完成，請查看日誌確認結果。');
                });
            }
        }

        async function performAdminAction(action, channelId, listType, password, extraData = {}) {
            try {
                // 1. 在操作前先獲取當前活躍的 Tab
                const activeTabBtn = document.querySelector('.admin-tab-btn.active');
                const currentTab = activeTabBtn ? activeTabBtn.dataset.tab : 'pending_jp';

                await fetchApi('admin/manage', {
                    method: 'POST',
                    body: { action, channelId, listType, password, ...extraData }
                });

                // 如果是公告更新，不需要重新載入列表
                if (action !== 'update_announcement') {
                    // 2. 重新載入 UI，並傳入 currentTab 以保持分頁狀態
                    await showAdminUI(password, currentTab);
                }
            } catch (error) {
                console.error(`管理操作失敗 (${action}):`, error);
                alert(`操作失敗: ${error.message}`);
                throw error; // 重新拋出錯誤以便上層處理
            }
        }
        // --- END: Admin UI 新增函式 ---

        async function fetchApi(endpoint, options = {}) {
            const url = new URL(`${API_BASE_URL}/${endpoint}`);
            const defaultParams = { version: CURRENT_APP_VERSION };
            const allParams = { ...defaultParams, ...options.params };
            Object.keys(allParams).forEach(key => url.searchParams.append(key, allParams[key]));

            // 修改：讓 POST 請求也能攜帶 password
            const body = options.body ? JSON.stringify(options.body) : null;
            const headers = { 'Content-Type': 'application/json', ...options.headers };

            const response = await fetch(url, {
                method: options.method || 'GET',
                headers: headers,
                body: body,
            });

            const data = await response.json().catch(() => ({ error: `請求失敗，狀態碼: ${response.status}` }));
            if (!response.ok) {
                throw new Error(data.message || data.error || `Request failed with status ${response.status}`);
            }
            return data;
        }

        async function performUpdateCheck(isManual = false) {
            if (isManual) { showUpdateModal('檢查更新中...', '正在從 GitHub 獲取最新版本資訊，請稍候...'); }
            try {
                const response = await fetch('https://api.github.com/repos/renachiouo/vspo_clip_collector/commits?per_page=1');
                if (!response.ok) throw new Error(`GitHub API 請求失敗 (${response.status})`);
                const data = await response.json();
                const latestCommitMessage = data[0]?.commit?.message || '';
                const versionMatch = latestCommitMessage.match(/V(\d+\.\d+(\.\d+)?)/);
                const latestVersion = versionMatch ? `V${versionMatch[1]}` : null;
                if (!latestVersion) throw new Error('無法從最新的 commit 中解析版本號。');
                const isNewer = parseFloat(latestVersion.slice(1)) > parseFloat(CURRENT_APP_VERSION.slice(1));
                if (isNewer) {
                    showUpdateModal('發現新版本！', `目前最新版本為 <strong>${latestVersion}</strong>，您使用的版本為 ${CURRENT_APP_VERSION}。<br><br>建議更新以獲取最新的功能與修正。`, true);
                } else if (isManual) {
                    showUpdateModal('檢查完成', `您目前使用的已是最新版本 (${CURRENT_APP_VERSION})。`);
                }
            } catch (error) {
                console.error('檢查更新時發生錯誤:', error);
                if (isManual) { showUpdateModal('檢查失敗', `無法完成更新檢查，請稍後再試。<br>錯誤訊息: ${error.message}`); }
            }
        }

        function createErrorDisplay(error) {
            let errorMessage = error;
            let errorHint = "請檢查代理伺服器是否正常運作，或稍後再試。";
            if (error && error.toLowerCase().includes('quota')) {
                errorMessage = "API 每日配額已用盡";
                errorHint = "請等待台灣時間下午 4 點後，配額將會自動重置。";
            }
            return `<div class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-center"><strong class="font-bold">發生錯誤！</strong><p class="block sm:inline ml-2">${errorMessage}</p><p class="mt-2 text-sm">${errorHint}</p></div>`;
        }

        function createVideoCard(video, showChannel = true) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { '年': 31536000, '個月': 2592000, '天': 86400, '小時': 3600, '分鐘': 60 };
                for (let unit in intervals) { if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}前`; }
                return "剛剛";
            };
            const card = document.createElement('div');
            card.className = "video-card group bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-400/30 transition-shadow duration-300 flex flex-col";

            const channelLink = showChannel ? `<a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-2"><img src="${video.channelAvatarUrl}" class="w-6 h-6 rounded-full bg-gray-700"><p class="text-sm text-gray-400 hover:text-white transition-colors truncate">${video.channelTitle}</p></a>` : '';

            let relatedClipsButton = '';
            if (video.originalStreamInfo) {
                relatedClipsButton = `<button class="related-clips-btn p-2 rounded-full bg-teal-500/20 hover:bg-teal-500/40 transition-colors" title="查看同場直播所有剪輯"><span class="text-lg">🎬</span></button>`;
            }

            card.innerHTML = `
            <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="video-thumbnail-container block w-full bg-gray-700 overflow-hidden">
                <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
            </a>
            <div class="p-4 flex flex-col flex-grow">
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                    <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                </a>
                ${channelLink}
                <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                    <span class="truncate">${formatNumber(video.viewCount)} 次觀看</span>
                    <div class="flex items-center gap-x-2">
                        ${relatedClipsButton}
                        <span class="flex-shrink-0">${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>
            </div>`;

            if (video.originalStreamInfo) {
                card.querySelector('.related-clips-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showRelatedClipsModal(video.originalStreamInfo);
                });
            }
            return card;
        }

        function createVideoListItem(video) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { '年': 31536000, '個月': 2592000, '天': 86400, '小時': 3600, '分鐘': 60 };
                for (let unit in intervals) { if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}前`; }
                return "剛剛";
            };
            const item = document.createElement('div');
            item.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors duration-200";

            let relatedClipsButton = '';
            if (video.originalStreamInfo) {
                relatedClipsButton = `<button class="related-clips-btn ml-auto p-2 rounded-full bg-teal-500/20 hover:bg-teal-500/40 transition-colors" title="查看同場直播所有剪輯"><span class="text-lg">🎬</span></button>`;
            }

            item.innerHTML = `
            <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 w-32 aspect-video bg-gray-700 rounded-md overflow-hidden">
                <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/128x72/1a202c/e53e3e?text=Error';">
            </a>
            <div class="flex-1 min-w-0">
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer">
                    <h3 class="font-semibold text-gray-100 truncate hover:text-cyan-400">${video.title}</h3>
                </a>
                <a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-1">
                    <img src="${video.channelAvatarUrl}" class="w-5 h-5 rounded-full bg-gray-700">
                    <p class="text-sm text-gray-400 hover:text-white truncate">${video.channelTitle}</p>
                </a>
                <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                    <span>${formatNumber(video.viewCount)} 次觀看</span>
                    <span>${timeAgo(video.publishedAt)}</span>
                </div>
            </div>
            ${relatedClipsButton}`;

            if (video.originalStreamInfo) {
                item.querySelector('.related-clips-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showRelatedClipsModal(video.originalStreamInfo);
                });
            }
            return item;
        }

        function createChannelGridCard(channel) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}萬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { '年': 31536000, '個月': 2592000, '天': 86400, '小時': 3600, '分鐘': 60 };
                for (let unit in intervals) { if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}前`; }
                return "剛剛";
            };
            const card = document.createElement('div');
            card.className = "group rounded-lg overflow-hidden shadow-lg hover:shadow-purple-400/30 transition-shadow duration-300 relative";
            card.style.backgroundImage = `url('${channel.avatarUrl}')`;
            card.style.backgroundSize = 'cover';
            card.style.backgroundPosition = 'center';
            const video = channel.latestVideo;

            let relatedClipsButton = '';
            if (video.originalStreamInfo) {
                relatedClipsButton = `<button class="related-clips-btn p-2 rounded-full bg-teal-500/20 hover:bg-teal-500/40 transition-colors" title="查看同場直播所有剪輯"><span class="text-lg">🎬</span></button>`;
            }

            card.innerHTML = `<div class="absolute inset-0 bg-gray-900/70 backdrop-blur"></div><div class="relative z-10 flex flex-col h-full"><div class="p-4"><div class="flex items-center space-x-3"><a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0"><img src="${channel.avatarUrl}" alt="${channel.name}" class="w-12 h-12 rounded-full bg-gray-700 border-2 border-white/20"></a><div class="flex-1 min-w-0"><a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer"><p class="text-lg font-bold text-purple-300 truncate">${channel.name}</p></a><p class="text-sm text-gray-300">${formatNumber(channel.subscriberCount)} 位訂閱者</p></div><button class="channel-filter-btn flex-shrink-0 p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors" data-channel-id="${channel.id}" data-channel-name="${channel.name}" title="篩選此頻道"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 12.414V17a1 1 0 01-1.447.894l-3-2A1 1 0 017 15V12.414L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg></button></div></div><div class="px-4 text-sm text-gray-400">最新影片:</div><a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="block w-full aspect-video bg-gray-700/50 overflow-hidden mt-2"><img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';"></a><div class="p-4 flex flex-col flex-grow mt-auto"><a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow"><h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3></a><div class="flex justify-between items-center text-sm text-gray-300 mt-3 pt-3 border-t border-gray-500/50"><span>${formatNumber(video.viewCount)} 次觀看</span><div class="flex items-center gap-x-2">${relatedClipsButton}<span>${timeAgo(video.publishedAt)}</span></div></div></div></div>`;

            if (video.originalStreamInfo) {
                card.querySelector('.related-clips-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showRelatedClipsModal(video.originalStreamInfo);
                });
            }
            return card;
        }

        function isColorLight(hexColor) {
            if (!hexColor) return false;
            const color = (hexColor.charAt(0) === '#') ? hexColor.substring(1, 7) : hexColor;
            if (color.length < 6) return false;
            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            return (r * 0.299 + g * 0.587 + b * 0.114) > 186;
        }

        function createMemberFilterListHTML(jpMembers, otherGroups, activeFilter) {
            const listContainer = document.createElement('div');
            listContainer.className = 'flex flex-row space-x-2 md:flex-col md:space-y-2 md:space-x-0 overflow-x-auto md:overflow-y-auto no-scrollbar pb-2 md:pb-0';
            listContainer.id = 'member-filter-list-container';
            const allBtn = document.createElement('button');
            allBtn.className = `filter-btn flex-shrink-0 ${activeFilter === 'all' ? 'active' : ''}`;
            allBtn.dataset.filter = 'all';
            allBtn.textContent = '顯示全部';
            listContainer.appendChild(allBtn);
            const createMemberButton = (member) => {
                const btn = document.createElement('button');
                const isActive = activeFilter === member.filter_keyword;
                btn.className = `filter-btn flex-shrink-0 ${isActive ? 'active' : ''}`;
                btn.dataset.filter = member.filter_keyword;
                btn.style.backgroundColor = member.color;
                if (member.forceWhiteText) { btn.style.color = '#FFFFFF'; } else { btn.style.color = isColorLight(member.color) ? '#1f2937' : '#f9fafb'; }
                btn.textContent = member.name_jp;
                return btn;
            };
            jpMembers.forEach(member => listContainer.appendChild(createMemberButton(member)));
            for (const groupName in otherGroups) {
                const divider = document.createElement('div');
                divider.className = 'text-xs text-gray-500 pt-2 pb-1 pl-2 md:pt-3 md:pb-1 whitespace-nowrap';
                divider.textContent = groupName;
                listContainer.appendChild(divider);
                otherGroups[groupName].forEach(member => listContainer.appendChild(createMemberButton(member)));
            }
            return listContainer;
        }

        function createSkeleton(type) {
            const skeleton = document.createElement('div');
            if (type === 'card') {
                skeleton.className = "bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col animate-pulse";
                skeleton.innerHTML = `<div class="w-full aspect-video bg-gray-700"></div><div class="p-4"><div class="h-4 bg-gray-700 rounded w-3/4 mb-4"></div><div class="h-4 bg-gray-700 rounded w-1/2"></div></div>`;
            } else if (type === 'list') {
                skeleton.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg animate-pulse";
                skeleton.innerHTML = `<div class="w-32 h-[72px] bg-gray-700 rounded-md"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-700 rounded w-5/6"></div><div class="h-4 bg-gray-700 rounded w-1/3"></div><div class="h-3 bg-gray-700 rounded w-1/2"></div></div>`;
            }
            return skeleton;
        }

        function createPaginationControls(totalPages, currentPage) {
            const container = document.createElement('div');
            container.className = 'flex justify-center items-center space-x-1 md:space-x-2 mt-8';
            const createBtn = (text, page, isDisabled = false, isActive = false) => {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${isActive ? 'active' : ''}`;
                btn.textContent = text;
                btn.dataset.page = page;
                if (isDisabled) btn.disabled = true;
                return btn;
            };
            const createEllipsis = () => { const span = document.createElement('span'); span.className = 'pagination-ellipsis'; span.textContent = '...'; return span; };
            container.appendChild(createBtn('‹', currentPage - 1, currentPage === 1));
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) { container.appendChild(createBtn(i, i, false, i === currentPage)); }
            } else {
                const pages = new Set([1, totalPages, currentPage, currentPage - 1, currentPage + 1]);
                const sortedPages = Array.from(pages).filter(p => p > 0 && p <= totalPages).sort((a, b) => a - b);
                let lastPage = 0;
                for (const page of sortedPages) {
                    if (lastPage !== 0 && page - lastPage > 1) { container.appendChild(createEllipsis()); }
                    container.appendChild(createBtn(page, page, false, page === currentPage));
                    lastPage = page;
                }
            }
            container.appendChild(createBtn('›', currentPage + 1, currentPage === totalPages));
            return container;
        }

        function render(onRenderComplete) {
            const { allVideos, isLoading, isClassifying, lastUpdated, apiError, totalVisits, todayVisits, activeView, activeVideoTypeFilter, currentPage, itemsPerPage, activeMemberFilter, activeChannelFilter, blacklist, isFilterDropdownOpen, activeLanguage } = state;

            appContainer.innerHTML = '';

            const header = document.createElement('header');
            header.className = "text-center pt-8 mb-4";
            const titleText = activeLanguage === 'cn' ? 'VSPO中文精華收集處' : 'VSPO日文精華收集處';
            document.title = `れなち的${titleText}`;
            header.innerHTML = `
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-cyan-400 flex justify-center items-baseline flex-wrap gap-x-3 px-4">
                <span><span class="secret-trigger" data-char="れ">れ</span><span class="secret-trigger" data-char="な">な</span><span class="secret-trigger" data-char="ち">ち</span>的${titleText}</span>
                <span class="text-lg align-middle text-gray-500 whitespace-nowrap">${CURRENT_APP_VERSION}</span>
            </h1>
            <div id="lang-switcher" class="mt-6 flex justify-center items-center space-x-4">
                <button data-lang="cn" class="lang-switcher-btn ${activeLanguage === 'cn' ? 'active' : ''}">中文精華</button>
                <button data-lang="jp" class="lang-switcher-btn ${activeLanguage === 'jp' ? 'active' : ''}">日文精華</button>
            </div>`;

            const topBar = document.createElement('div');
            topBar.className = "sticky top-0 z-20 bg-gray-900/80 backdrop-blur-sm py-4 mb-8";
            topBar.innerHTML = `
            <div class="container mx-auto px-4 text-center text-sm text-gray-500 flex flex-col items-center space-y-2">
                <div class="flex justify-center items-center space-x-4 flex-wrap gap-y-2">
                    <span class="whitespace-nowrap">👀 總人次: <span class="font-semibold text-teal-400">${totalVisits.toLocaleString()}</span></span>
                    <span class="whitespace-nowrap">☀️ 今日人次: <span class="font-semibold text-amber-400">${todayVisits.toLocaleString()}</span></span>
                    ${lastUpdated ? `<span class="whitespace-nowrap">資料時間: ${lastUpdated.toLocaleTimeString()}</span>` : ''}
                </div>
                <div class="flex justify-center items-center space-x-4 flex-wrap gap-y-2">
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdPXcKRZdp6KgVcw_yiXhDy979wrl3y42knIh5fIjP1tGUZBQ/viewform?usp=sharing&ouid=104059498550822009260" target="_blank" rel="noopener noreferrer" class="whitespace-nowrap font-semibold text-indigo-400 hover:text-indigo-300 transition-colors duration-200 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>回報遺漏頻道/影片</a>
                    <button id="manage-blacklist-btn" class="whitespace-nowrap font-semibold text-red-400 hover:text-red-300 transition-colors duration-200 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.367zM14.89 13.477a6 6 0 01-8.367-8.367l8.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" /></svg>管理個人黑名單</button>
                    <button id="check-update-btn" class="whitespace-nowrap font-semibold text-cyan-400 hover:text-cyan-300 transition-colors duration-200 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zM9 13a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd" /></svg>檢查更新</button>
                </div>
            </div>`;

            const mainGrid = document.createElement('div');
            mainGrid.className = "container mx-auto px-4 grid grid-cols-1 md:grid-cols-[12rem_minmax(0,1fr)] gap-8";

            const filterSection = document.createElement('aside');
            filterSection.className = "md:col-start-1";
            const filterContainer = document.createElement('div');
            filterContainer.className = "bg-gray-800/50 p-4 rounded-lg md:sticky md:top-28 md:flex md:flex-col md:max-h-[calc(100vh-9rem)]";
            filterContainer.innerHTML = `<h3 class="text-xl font-bold mb-4 text-gray-300 border-b border-gray-600 pb-2">成員篩選</h3>`;
            filterContainer.appendChild(createMemberFilterListHTML(vspoJPMembers, otherMemberGroups, activeMemberFilter));
            filterSection.appendChild(filterContainer);

            const rightContent = document.createElement('main');
            rightContent.className = "md:col-start-2 min-w-0";

            if (isLoading) {
                const videoSkeletons = Array.from({ length: 12 }).map(() => createSkeleton('card').outerHTML).join('');
                rightContent.innerHTML = `<section style="min-height: 720px;"><div class="flex items-center justify-between mb-6"><div class="h-8 bg-gray-700 rounded w-1/3 animate-pulse"></div><div class="h-8 bg-gray-700 rounded w-1/4 animate-pulse"></div></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">${videoSkeletons}</div></section>`;
            } else if (apiError) {
                rightContent.innerHTML = createErrorDisplay(apiError);
            } else {
                const visibleVideos = allVideos.filter(video => !blacklist.some(b => b.id === video.channelId));
                let baseFilteredVideos;
                if (activeChannelFilter) { baseFilteredVideos = visibleVideos.filter(video => video.channelId === activeChannelFilter.id); }
                else if (activeMemberFilter !== 'all') { const filterKeyword = activeMemberFilter.toLowerCase(); baseFilteredVideos = visibleVideos.filter(video => (video.searchableText || '').includes(filterKeyword)); }
                else { baseFilteredVideos = visibleVideos; }
                let filteredVideos;
                if (!isClassifying && activeVideoTypeFilter !== 'all') { filteredVideos = baseFilteredVideos.filter(v => v.videoType === activeVideoTypeFilter); }
                else { filteredVideos = baseFilteredVideos; }
                const videosForChannelList = baseFilteredVideos;
                if (filteredVideos.length === 0 && (activeMemberFilter !== 'all' || activeChannelFilter || activeVideoTypeFilter !== 'all')) {
                    const filterName = activeChannelFilter ? activeChannelFilter.name : activeMemberFilter;
                    let message = `找不到關於「${filterName}」的影片。`;
                    if (activeVideoTypeFilter !== 'all') { message = `找不到符合條件的 ${activeVideoTypeFilter === 'short' ? 'Shorts 短片' : '一般影片'}。`; }
                    rightContent.innerHTML = `<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-lg">${message}</p>`;
                } else {
                    const videosSection = document.createElement('section');
                    videosSection.id = 'videos-section';
                    if (activeChannelFilter) {
                        const filterBanner = document.createElement('div');
                        filterBanner.className = 'flex items-center justify-between bg-purple-900/50 text-purple-200 px-4 py-2 rounded-lg mb-6';
                        filterBanner.innerHTML = `<span>目前篩選中：<strong class="font-semibold">${activeChannelFilter.name}</strong></span><button id="clear-channel-filter-btn" class="p-1 rounded-full hover:bg-white/20 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>`;
                        videosSection.appendChild(filterBanner);
                    }
                    const videosHeader = document.createElement('div');
                    videosHeader.className = "flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4";
                    const titleHTML = `<div class="flex items-center"><h2 class="text-3xl font-bold border-l-4 border-cyan-400 pl-4">精華影片</h2><div class="tooltip ml-2"><button class="text-sm bg-gray-600 text-gray-300 rounded-full w-5 h-5 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="說明">?</button><div class="tooltiptext"><p class="font-semibold mb-2">說明：</p><p>1. 伺服器快取每 20 分鐘更新一次</p><p>2. 為關鍵字搜尋，故可能出現：</p><div class="pl-4"><p>a. 含VSPO關鍵字的非VSPO烤肉</p><p>b. 含中文關鍵字的外文剪輯</p><p class="mt-2">有以上情形請至頁首回報處回報</p></div></div></div></div>`;
                    const filterControlsHTML = (() => {
                        const latestButtonText = window.innerWidth < 1280 ? '最新10部' : '最新12部';
                        const viewModeButtons = `<div class="flex space-x-2"><button id="view-latest-btn" class="tab-btn ${activeView === 'latest' ? 'active' : ''}">${latestButtonText}</button><button id="view-all-btn" class="tab-btn ${activeView === 'all' ? 'active' : ''}">一個月內</button></div>`;
                        const typeLabels = { all: '全部顯示', video: '只看影片', short: '只看Shorts' };
                        const classifyingSpinner = `<div class="spinner"></div>`;
                        const desktopTypeFilters = `<div id="desktop-type-filters" class="hidden md:flex space-x-2"><button data-type-filter="all" class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'all' ? 'active' : ''}" ${isClassifying ? 'disabled' : ''}>${isClassifying ? classifyingSpinner : ''} <span>${isClassifying ? '分類中' : '全部'}</span></button><button data-type-filter="video" class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'video' ? 'active' : ''}" ${isClassifying ? 'disabled' : ''}>只看影片</button><button data-type-filter="short" class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'short' ? 'active' : ''}" ${isClassifying ? 'disabled' : ''}>只看Shorts</button></div>`;
                        const mobileTypeFilter = `<div class="relative md:hidden"><button id="mobile-filter-toggle" class="tab-btn type-filter-btn flex items-center space-x-2" ${isClassifying ? 'disabled' : ''}>${isClassifying ? classifyingSpinner : ''}<span>${isClassifying ? '分類中...' : typeLabels[activeVideoTypeFilter]}</span>${!isClassifying ? `<svg class="w-4 h-4 transition-transform ${isFilterDropdownOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>` : ''}</button><div id="mobile-filter-menu" class="dropdown-menu ${isFilterDropdownOpen ? 'visible' : ''}"><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-teal-700" data-type-filter="all">全部顯示</a><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-teal-700" data-type-filter="video">只看影片</a><a href="#" class="block px-4 py-2 text-sm text-gray-200 hover:bg-teal-700" data-type-filter="short">只看Shorts</a></div></div>`;
                        return `<div class="flex w-full md:w-auto items-center justify-between md:justify-start md:space-x-4"><div class="flex items-center space-x-4">${desktopTypeFilters}${mobileTypeFilter}</div><div class="md:border-l-2 border-gray-600 md:pl-4">${viewModeButtons}</div></div>`;
                    })();
                    videosHeader.innerHTML = `${titleHTML} <div class="w-full md:w-auto flex-shrink-0">${filterControlsHTML}</div>`;
                    videosSection.appendChild(videosHeader);
                    const viewContainer = document.createElement('div');
                    viewContainer.style.minHeight = '720px';
                    const videosToDisplay = filteredVideos;
                    if (activeView === 'latest') {
                        const grid = document.createElement('div');
                        const isShortsMode = !isClassifying && activeVideoTypeFilter === 'short';
                        let gridClasses = 'grid gap-4 ';
                        if (isShortsMode) { gridClasses += 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 view-mode-shorts-only'; }
                        else { gridClasses += 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'; }
                        grid.className = gridClasses;
                        const sliceCount = window.innerWidth < 1280 ? 10 : 12;
                        videosToDisplay.slice(0, sliceCount).forEach(video => grid.appendChild(createVideoCard(video)));
                        viewContainer.appendChild(grid);
                    } else {
                        const listContainer = document.createElement('div');
                        listContainer.className = 'space-y-3';
                        const totalPages = Math.ceil(videosToDisplay.length / itemsPerPage);
                        const startIndex = (currentPage - 1) * itemsPerPage;
                        const paginatedVideos = videosToDisplay.slice(startIndex, startIndex + itemsPerPage);
                        paginatedVideos.forEach(video => listContainer.appendChild(createVideoListItem(video)));
                        viewContainer.appendChild(listContainer);
                        if (totalPages > 1) { viewContainer.appendChild(createPaginationControls(totalPages, currentPage)); }
                    }
                    videosSection.appendChild(viewContainer);
                    rightContent.appendChild(videosSection);
                    const channelListSection = document.createElement('section');
                    const channelListHeader = document.createElement('div');
                    channelListHeader.className = 'flex items-baseline mb-6 gap-x-3';
                    if (activeMemberFilter !== 'all') {
                        const member = allMembers.find(m => m.filter_keyword === activeMemberFilter);
                        const memberColor = member ? member.color : '#fbbf24';
                        channelListHeader.innerHTML = `<h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4 mt-12">一個月內發布過 <span style="color: ${memberColor}">${member ? member.name_jp : activeMemberFilter}</span> 剪輯的頻道</h2>`;
                    } else {
                        channelListHeader.innerHTML = `<h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4 mt-12">精華頻道列表</h2><p class="text-gray-500 text-sm">僅列出30天內有發布新影片之頻道</p>`;
                    }
                    channelListSection.appendChild(channelListHeader);
                    const channels = {};
                    videosForChannelList.forEach(video => { if (!channels[video.channelId]) { channels[video.channelId] = { id: video.channelId, name: video.channelTitle, subscriberCount: video.subscriberCount, latestVideo: video, avatarUrl: video.channelAvatarUrl }; } });
                    const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    const channelData = Object.values(channels).filter(channel => new Date(channel.latestVideo.publishedAt) > thirtyDaysAgo).sort((a, b) => new Date(b.latestVideo.publishedAt) - new Date(a.latestVideo.publishedAt));
                    if (channelData.length > 0) {
                        const channelListGrid = document.createElement('div');
                        channelListGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
                        channelData.forEach(channel => channelListGrid.appendChild(createChannelGridCard(channel)));
                        channelListSection.appendChild(channelListGrid);
                    } else if (activeMemberFilter !== 'all') {
                        channelListSection.innerHTML += `<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-lg">找不到一個月內發布過「${activeMemberFilter}」剪輯的頻道。</p>`;
                    }
                    rightContent.appendChild(channelListSection);
                }
            }
            mainGrid.appendChild(filterSection);
            mainGrid.appendChild(rightContent);
            appContainer.appendChild(header);
            appContainer.appendChild(topBar);
            appContainer.appendChild(mainGrid);
            setupEventListeners();
            if (onRenderComplete) onRenderComplete();
        }

        function setupEventListeners() {
            setupSecretTrigger();
            document.getElementById('check-update-btn')?.addEventListener('click', () => performUpdateCheck(true));
            document.getElementById('manage-blacklist-btn')?.addEventListener('click', showBlacklistModal);

            document.querySelectorAll('#lang-switcher .lang-switcher-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const lang = e.currentTarget.dataset.lang;
                    if (lang !== state.activeLanguage) {
                        state.activeLanguage = lang;
                        localStorage.setItem(LANGUAGE_KEY, lang);
                        state.activeMemberFilter = 'all';
                        state.activeChannelFilter = null;
                        state.currentPage = 1;
                        initializeApp();
                    }
                });
            });

            document.getElementById('view-latest-btn')?.addEventListener('click', () => { state.activeView = 'latest'; render(); });
            document.getElementById('view-all-btn')?.addEventListener('click', () => { state.activeView = 'all'; state.currentPage = 1; render(); });
            document.querySelectorAll('#desktop-type-filters .type-filter-btn').forEach(btn => { btn.addEventListener('click', (e) => { state.activeVideoTypeFilter = e.currentTarget.dataset.typeFilter; state.currentPage = 1; render(); }); });
            const mobileFilterToggle = document.getElementById('mobile-filter-toggle');
            const mobileFilterMenu = document.getElementById('mobile-filter-menu');
            if (mobileFilterToggle) {
                mobileFilterToggle.addEventListener('click', (e) => { e.stopPropagation(); state.isFilterDropdownOpen = !state.isFilterDropdownOpen; render(); });
                mobileFilterMenu.querySelectorAll('a').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); state.activeVideoTypeFilter = e.currentTarget.dataset.typeFilter; state.currentPage = 1; state.isFilterDropdownOpen = false; render(); }); });
                document.addEventListener('click', (e) => { if (state.isFilterDropdownOpen && !mobileFilterMenu?.contains(e.target) && !mobileFilterToggle.contains(e.target)) { state.isFilterDropdownOpen = false; render(); } });
            }
            document.querySelectorAll('.pagination-btn').forEach(btn => { btn.addEventListener('click', (e) => { const page = parseInt(e.currentTarget.dataset.page, 10); if (page && page !== state.currentPage) { state.currentPage = page; render(() => window.scrollTo({ top: 0, behavior: 'smooth' })); } }); });
            document.querySelectorAll('.filter-btn').forEach(btn => { btn.addEventListener('click', (e) => { const filterList = document.getElementById('member-filter-list-container'); const scrollPosition = { top: filterList?.scrollTop || 0, left: filterList?.scrollLeft || 0 }; state.activeChannelFilter = null; state.activeMemberFilter = e.currentTarget.dataset.filter; state.currentPage = 1; render(() => { const newFilterList = document.getElementById('member-filter-list-container'); if (newFilterList) { newFilterList.scrollTop = scrollPosition.top; newFilterList.scrollLeft = scrollPosition.left; } window.scrollTo({ top: 0, behavior: 'smooth' }); }); }); });
            document.querySelectorAll('.channel-filter-btn').forEach(btn => { btn.addEventListener('click', (e) => { const button = e.currentTarget; state.activeMemberFilter = 'all'; state.activeChannelFilter = { id: button.dataset.channelId, name: button.dataset.channelName }; state.currentPage = 1; render(() => window.scrollTo({ top: 0, behavior: 'smooth' })); }); });
            document.getElementById('clear-channel-filter-btn')?.addEventListener('click', () => { state.activeChannelFilter = null; render(); });
            let lastWidth = window.innerWidth;
            window.addEventListener('resize', () => {
                const currentWidth = window.innerWidth;
                const breakpoint = 1280;
                if ((lastWidth < breakpoint && currentWidth >= breakpoint) || (lastWidth >= breakpoint && currentWidth < breakpoint)) { if (state.activeView === 'latest') { render(); } }
                lastWidth = currentWidth;
            });
        }

        function startClassificationPolling() {
            if (state.classificationIntervalId) { clearInterval(state.classificationIntervalId); }
            console.log("開始輪詢分類狀態...");
            state.classificationIntervalId = setInterval(async () => {
                try {
                    const status = await fetchApi('check-status');
                    if (status.isDone) {
                        console.log("分類完成！停止輪詢並重新獲取最終資料。");
                        clearInterval(state.classificationIntervalId);
                        state.classificationIntervalId = null;
                        state.isClassifying = false;
                        const finalData = await fetchApi('youtube', { params: { lang: state.activeLanguage, no_increment: 'true' } });
                        state.allVideos = finalData.videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                        render();
                    }
                } catch (error) {
                    console.error("輪詢失敗:", error);
                    clearInterval(state.classificationIntervalId);
                    state.isClassifying = false;
                    render();
                }
            }, 3000);
        }

        async function initializeApp(force = false, password = '') {
            state.activeLanguage = localStorage.getItem(LANGUAGE_KEY) || 'cn';
            state.blacklist = getBlacklist();
            state.isLoading = true;
            render();

            const lastSeenVersion = localStorage.getItem(LAST_SEEN_VERSION_KEY);
            if (lastSeenVersion !== CURRENT_APP_VERSION) {
                const allVersions = Object.keys(UPDATE_LOGS).sort((a, b) => parseFloat(b.slice(1)) - parseFloat(a.slice(1)));
                const newVersionsToShow = [];
                for (const v of allVersions) {
                    if (!lastSeenVersion || parseFloat(v.slice(1)) > parseFloat(lastSeenVersion.slice(1))) { newVersionsToShow.push(v); } else { break; }
                }
                if (newVersionsToShow.length > 0) { showVersionUpdateModal(newVersionsToShow.reverse()); }
            }

            try {
                const apiParams = { lang: state.activeLanguage };
                if (force) {
                    apiParams.force_refresh = true;
                    apiParams.password = password;
                }

                const visitCountedInSession = sessionStorage.getItem('vspo_visit_counted');
                if (!visitCountedInSession) {
                    sessionStorage.setItem('vspo_visit_counted', 'true');
                } else {
                    apiParams.no_increment = 'true';
                }

                const dataPackage = await fetchApi('youtube', { params: apiParams });

                const videos = dataPackage.videos.map(v => {
                    if (v.originalStreamInfo && typeof v.originalStreamInfo === 'string') {
                        try { v.originalStreamInfo = JSON.parse(v.originalStreamInfo); }
                        catch (e) { console.error(`解析 'originalStreamInfo' 失敗 (Video ID: ${v.id}):`, e); v.originalStreamInfo = null; }
                    }
                    return v;
                });

                state.allVideos = videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                state.lastUpdated = new Date(dataPackage.timestamp);
                state.totalVisits = dataPackage.totalVisits || 0;
                state.totalVisits = dataPackage.totalVisits || 0;
                state.todayVisits = dataPackage.todayVisits || 0;

                // --- START: 處理公告顯示 ---
                const announcement = dataPackage.announcement;
                const banner = document.getElementById('announcement-banner');
                const bannerText = document.getElementById('announcement-text');
                const closeBtn = document.getElementById('close-announcement-btn');

                if (announcement && announcement.active === 'true') {
                    const dismissedKey = `vspo_announcement_dismissed_${announcement.timestamp}`;
                    const isDismissed = localStorage.getItem(dismissedKey);

                    if (!isDismissed) {
                        bannerText.textContent = announcement.content;
                        banner.className = `type-${announcement.type}`; // 設定類型樣式
                        banner.classList.add('visible');

                        closeBtn.onclick = () => {
                            banner.classList.remove('visible');
                            localStorage.setItem(dismissedKey, 'true');
                        };
                    }
                }
                // --- END: 處理公告顯示 ---

                const classificationStatus = await fetchApi('check-status');
                state.needsClassification = !classificationStatus.isDone;

                if (state.needsClassification) {
                    console.log("偵測到後端有未分類的影片，啟動背景分類程序。");
                    state.isClassifying = true;
                    fetchApi('classify-videos', { method: 'POST' }).catch(err => console.error("觸發分類失敗:", err));
                    startClassificationPolling();
                }

            } catch (error) {
                console.error("初始化失敗:", error);
                state.apiError = error.message;
                if (force) { alert(`錯誤: ${error.message || '未知錯誤'}`); }
            } finally {
                state.isLoading = false;
                render();
                setTimeout(() => performUpdateCheck(false), 2000);
            }
        }

        function setupSecretTrigger() {
            let sequence = [];
            let lastClickTime = 0;
            const targetSequence = ['れ', 'な', 'ち'];
            document.querySelectorAll('.secret-trigger').forEach(span => {
                span.addEventListener('click', (e) => {
                    const char = e.target.dataset.char;
                    const now = Date.now();
                    if (now - lastClickTime > 3000) sequence = [];
                    sequence.push(char);
                    lastClickTime = now;
                    if (sequence.join('') === targetSequence.join('')) {
                        console.log("秘密通道已觸發！");
                        const password = prompt("請輸入管理員密碼：");
                        if (password) {
                            // --- START: 修改觸發邏輯 ---
                            showAdminUI(password);
                            // --- END: 修改觸發邏輯 ---
                        }
                        sequence = [];
                    }
                    if (sequence.length >= targetSequence.length && sequence.join('') !== targetSequence.join('')) { sequence = []; }
                });
            });
        }

        initializeApp();
    </script>
</body>

</html>