<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚Œãªã¡çš„VSPOä¸­æ–‡ç²¾è¯æ”¶é›†è™•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style> 
        body { background-color: #111827; } 
        /* Tooltip æ¨£å¼ */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937; /* gray-800 */
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 10;
            bottom: 150%;
            left: 50%;
            margin-left: -140px; /* Use half of the width to center the tooltip */
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4b5563; /* gray-600 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        /* åœ¨ hover æˆ– focus-within (é©ç”¨æ–¼éµç›¤å’Œè§¸æ§) æ™‚é¡¯ç¤º */
        .tooltip:hover .tooltiptext,
        .tooltip:focus-within .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="app"></div>

    <script type="module">
        // --- å…¨åŸŸè®Šæ•¸èˆ‡ç‹€æ…‹ç®¡ç† ---
        const PROXY_ENDPOINT = 'https://vspo-proxy-git-main-renas-projects-c8ce958b.vercel.app'; 

        let state = {
            allVideos: [], isLoading: true, lastUpdated: null, apiError: null,
            totalVisits: 0, todayVisits: 0,
        };

        const appContainer = document.getElementById('app');
        
        // --- UI å…ƒä»¶ç”¢ç”Ÿå™¨ ---
        function createSpinner() {
            const container = document.createElement('div');
            container.className = "flex flex-col items-center justify-center space-y-4 p-8";
            container.innerHTML = `<div class="w-16 h-16 border-4 border-blue-400 border-t-transparent border-solid rounded-full animate-spin"></div><p class="text-lg text-gray-300">æ­£åœ¨ç²å– VSPO ç²¾è¯... âœ¨</p>`;
            return container;
        }
        function createErrorDisplay(error) {
            const container = document.createElement('div');
            let errorMessage = error;
            let errorHint = "è«‹æª¢æŸ¥ä»£ç†ä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚";
            
            if (error && error.toLowerCase().includes('quota')) {
                 errorMessage = "API æ¯æ—¥é…é¡å·²ç”¨ç›¡";
                 errorHint = "è«‹ç­‰å¾…å°ç£æ™‚é–“ä¸‹åˆ 4 é»å¾Œï¼Œé…é¡å°‡æœƒè‡ªå‹•é‡ç½®ã€‚";
            }

            container.className = "bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-center";
            container.innerHTML = `<strong class="font-bold">ç™¼ç”ŸéŒ¯èª¤ï¼</strong><p class="block sm:inline ml-2">${errorMessage}</p><p class="mt-2 text-sm">${errorHint}</p>`;
            return container;
        }
        function createVideoCard(video, showChannel = true) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}è¬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'å¹´': 31536000, 'å€‹æœˆ': 2592000, 'å¤©': 86400, 'å°æ™‚': 3600, 'åˆ†é˜': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}å‰`;
                }
                return "å‰›å‰›";
            };
            const card = document.createElement('div');
            card.className = "group bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-400/30 transition-shadow duration-300 flex flex-col";
            
            const channelLink = showChannel ? `
                <a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-2">
                    <img src="${video.channelAvatarUrl}" class="w-6 h-6 rounded-full bg-gray-700">
                    <p class="text-sm text-gray-400 hover:text-white transition-colors truncate">${video.channelTitle}</p>
                </a>` : '';

            card.innerHTML = `
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="block w-full aspect-video bg-gray-700 overflow-hidden">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
                </a>
                <div class="p-4 flex flex-col flex-grow">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                    </a>
                    ${channelLink}
                    <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                        <span>${formatNumber(video.viewCount)} æ¬¡è§€çœ‹</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>`;
            return card;
        }

        function createChannelGridCard(channel) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}è¬` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'å¹´': 31536000, 'å€‹æœˆ': 2592000, 'å¤©': 86400, 'å°æ™‚': 3600, 'åˆ†é˜': 60 };
                for (let unit in intervals) {
                    if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}å‰`;
                }
                return "å‰›å‰›";
            };

            const card = document.createElement('div');
            card.className = "group bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-purple-400/30 transition-shadow duration-300 flex flex-col";
            
            const video = channel.latestVideo;

            card.innerHTML = `
                <div class="p-4">
                    <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-3">
                        <img src="${channel.avatarUrl}" alt="${channel.name}" class="w-12 h-12 rounded-full bg-gray-700 flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-bold text-purple-300 truncate">${channel.name}</p>
                            <p class="text-sm text-gray-400">${formatNumber(channel.subscriberCount)} ä½è¨‚é–±è€…</p>
                        </div>
                    </a>
                </div>
                <div class="px-4 text-sm text-gray-400">æœ€æ–°å½±ç‰‡:</div>
                <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="block w-full aspect-video bg-gray-700 overflow-hidden mt-2">
                    <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
                </a>
                <div class="p-4 flex flex-col flex-grow">
                    <a href="https://www.youtube.com/watch?v=${video.id}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                    </a>
                    <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                        <span>${formatNumber(video.viewCount)} æ¬¡è§€çœ‹</span>
                        <span>${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>
            `;
            return card;
        }
        
        // --- API è«‹æ±‚é‚è¼¯ ---
        async function fetchAllDataFromProxy() {
            console.log("å‘ä»£ç†ä¼ºæœå™¨ç™¼é€å–®ä¸€è«‹æ±‚...");
            const url = new URL(`${PROXY_ENDPOINT}/api/youtube`);
            const response = await fetch(url);
            
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `Proxy request failed with status ${response.status}`);
            }
            console.log("æˆåŠŸå¾ä»£ç†ç²å–è³‡æ–™ï¼");
            return data;
        }
        
        // --- ä¸»æ‡‰ç”¨ç¨‹å¼é‚è¼¯èˆ‡æ¸²æŸ“ ---
        function render() {
            const { allVideos, isLoading, lastUpdated, apiError, totalVisits, todayVisits } = state;
            
            const recentVideos = allVideos.slice(0, 10);
            
            const channels = {};
            allVideos.forEach(video => {
                if (!channels[video.channelId]) {
                    channels[video.channelId] = {
                        id: video.channelId, name: video.channelTitle,
                        subscriberCount: video.subscriberCount, 
                        latestVideo: video,
                        avatarUrl: video.channelAvatarUrl
                    };
                }
            });

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const channelData = Object.values(channels)
                .filter(channel => new Date(channel.latestVideo.publishedAt) > thirtyDaysAgo)
                .sort((a, b) => new Date(b.latestVideo.publishedAt) - new Date(a.latestVideo.publishedAt));
            
            appContainer.innerHTML = '';
            const mainContainer = document.createElement('div');
            mainContainer.className = "container mx-auto px-4 py-8";
            
            let contentHtml;
             if (isLoading) {
                // ... skeleton loading ...
             } else if (apiError) {
                contentHtml = createErrorDisplay(apiError).outerHTML;
            } else if (allVideos.length === 0) {
                 contentHtml = `<p class="text-center text-gray-400 p-8">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å½±ç‰‡ï¼Œæˆ–ä»£ç†ä¼ºæœå™¨çš„å¿«å–å°šæœªå»ºç«‹ã€‚</p>`;
            } else {
                const recentVideosSection = document.createElement('section');
                const recentVideosGrid = document.createElement('div');
                recentVideosGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6';
                if(recentVideos.length > 0) {
                   recentVideos.forEach(video => recentVideosGrid.appendChild(createVideoCard(video)));
                } else {
                   recentVideosGrid.innerHTML = `<p class="text-gray-400">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å½±ç‰‡ã€‚</p>`;
                }
                
                // *** é€™æ˜¯é—œéµçš„ä¿®æ­£ï¼šä½¿ç”¨ç°¡åŒ–çš„ HTML çµæ§‹ä¾†ç¢ºä¿ Tooltip æ­£å¸¸é¡¯ç¤º ***
                const tooltipHtml = `
                    <div class="tooltip ml-2">
                        <button class="text-sm bg-gray-600 text-gray-300 rounded-full w-5 h-5 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="èªªæ˜">?</button>
                        <div class="tooltiptext">
                            <p class="font-semibold mb-2">èªªæ˜ï¼š</p>
                            <p>1. ä¼ºæœå™¨å¿«å–æ¯ 30 åˆ†é˜æ›´æ–°ä¸€æ¬¡ã€‚</p>
                            <p>2. ç‚ºé—œéµå­—æœå°‹ï¼Œæ•…å¯èƒ½å‡ºç¾ï¼š</p>
                            <p class="pl-4">a. å«VSPOé—œéµå­—çš„éVSPOçƒ¤è‚‰</p>
                            <p class="pl-4">b. å«ä¸­æ–‡é—œéµå­—çš„å¤–æ–‡å‰ªè¼¯</p>
                        </div>
                    </div>
                `;
                recentVideosSection.innerHTML = `<div class="flex items-center mb-6"><h2 class="text-3xl font-bold border-l-4 border-cyan-400 pl-4">æœ€æ–°ç²¾è¯å½±ç‰‡</h2>${tooltipHtml}</div>`;
                recentVideosSection.appendChild(recentVideosGrid);

                const channelListSection = document.createElement('section');
                const channelListGrid = document.createElement('div');
                channelListGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6';
                if(channelData.length > 0) {
                    channelData.forEach(channel => {
                        channelListGrid.appendChild(createChannelGridCard(channel));
                    });
                } else {
                     channelListGrid.innerHTML = `<p class="text-gray-400">æ‰¾ä¸åˆ°éå»30å¤©å…§æœ‰æ›´æ–°çš„é »é“ã€‚</p>`;
                }

                channelListSection.innerHTML = `<div class="flex items-baseline mb-6 gap-x-3"><h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4 mt-12">ç²¾è¯é »é“åˆ—è¡¨</h2><p class="text-gray-500 text-sm">åƒ…åˆ—å‡º30å¤©å…§æœ‰ç™¼å¸ƒæ–°å½±ç‰‡ä¹‹é »é“</p></div>`;
                channelListSection.appendChild(channelListGrid);
                
                contentHtml = recentVideosSection.outerHTML + channelListSection.outerHTML;
            }

            mainContainer.innerHTML = `
                <header class="text-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-cyan-400">ã‚Œãªã¡çš„VSPOä¸­æ–‡ç²¾è¯æ”¶é›†è™•</h1>
                </header>
                <div class="sticky top-0 z-10 bg-gray-900/80 backdrop-blur-sm py-4 mb-8">
                    <div class="text-center text-sm text-gray-500 mt-3 flex justify-center items-center space-x-4 flex-wrap">
                        <span class="whitespace-nowrap">ğŸ‘€ ç¸½äººæ¬¡: <span class="font-semibold text-teal-400">${totalVisits.toLocaleString()}</span></span>
                        <span class="whitespace-nowrap">â˜€ï¸ ä»Šæ—¥äººæ¬¡: <span class="font-semibold text-amber-400">${todayVisits.toLocaleString()}</span></span>
                        ${lastUpdated ? `<span class="whitespace-nowrap">è³‡æ–™æ™‚é–“: ${lastUpdated.toLocaleTimeString()}</span>` : ''}
                    </div>
                </div>
                <div>${contentHtml}</div>
            `;
            appContainer.appendChild(mainContainer);
        }

        async function initializeApp() {
            state.isLoading = true;
            render(); 
            try {
                const dataPackage = await fetchAllDataFromProxy();
                state.allVideos = dataPackage.videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                state.lastUpdated = new Date(dataPackage.timestamp);
                state.totalVisits = dataPackage.totalVisits || 0;
                state.todayVisits = dataPackage.todayVisits || 0;
            } catch (error) {
                console.error("åˆå§‹åŒ–å¤±æ•—:", error);
                state.apiError = error.message;
            } finally {
                state.isLoading = false;
                render();
            }
        }

        initializeApp();

    </script>
</body>
</html>
