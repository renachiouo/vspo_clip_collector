<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>„Çå„Å™„Å°ÁöÑVSPOÁ≤æËèØÊî∂ÈõÜËôï</title>
    <link rel="icon" type="image/png" href="./icon.png" sizes="192x192">
    <link rel="apple-touch-icon" href="./icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: #111827;
        }

        .video-thumbnail-container {
            aspect-ratio: 16 / 9;
            transition: aspect-ratio 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .view-mode-shorts-only .video-thumbnail-container {
            aspect-ratio: 9 / 16;
        }

        .view-mode-shorts-only .group h3 {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }

        .view-mode-shorts-only .group .text-sm {
            font-size: 0.75rem;
            line-height: 1rem;
        }

        .view-mode-shorts-only .group .w-6.h-6 {
            width: 1.25rem;
            height: 1.25rem;
        }

        .view-mode-shorts-only .group .p-4 {
            padding: 0.75rem;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 12px;
            position: absolute;
            z-index: 30;
            bottom: 150%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid #4b5563;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext,
        .tooltip:focus-within .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .secret-trigger {
            cursor: pointer;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            background-color: #374151;
            color: #d1d5db;
            transition: background-color 0.2s, opacity 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn.active,
        .tab-btn:hover:not(:disabled) {
            background-color: #4f46e5;
            color: #fff;
        }

        .type-filter-btn.active,
        .type-filter-btn:hover:not(:disabled) {
            background-color: #0d9488;
            color: #fff;
        }

        .tab-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .pagination-btn {
            min-width: 2.5rem;
            padding: 0.5rem;
            border: 1px solid #4b5563;
            background-color: #374151;
            color: #d1d5db;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            text-align: center;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #4f46e5;
        }

        .pagination-btn.active {
            background-color: #4f46e5;
            color: #fff;
            border-color: #4f46e5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-ellipsis {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 2.5rem;
            padding: 0.5rem;
            color: #9ca3af;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
        }

        .filter-btn:hover {
            transform: scale(1.03);
        }

        .filter-btn[data-filter="all"] {
            background-color: #4b5563;
            color: #ffffff;
        }

        .filter-btn[data-filter="all"].active {
            background-color: #6366f1;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
            transform: scale(1.02);
        }

        .filter-btn.active {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.25);
            transform: scale(1.02);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .modal-overlay,
        .dropdown-menu {
            position: fixed;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal-overlay {
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.visible,
        .dropdown-menu.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.5rem;
            border: 1px solid #4b5563;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-width: 95%;
            width: 500px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        .dropdown-menu {
            position: absolute;
            background-color: #1f2937;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            margin-top: 0.5rem;
            min-width: 10rem;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .dropdown-menu.visible {
            transform: translateY(0);
        }

        .spinner {
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin .6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Ë™ûË®ÄÂàáÊèõÊåâÈàïÊ®£Âºè */
        .lang-switcher-btn {
            padding: 0.5rem 1.5rem;
            border: 2px solid transparent;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .lang-switcher-btn.active {
            border-color: #6366f1;
            background-color: #4338ca;
            color: #ffffff;
        }

        .lang-switcher-btn:not(.active) {
            background-color: #374151;
            color: #d1d5db;
        }

        /* --- START: Admin UI Êñ∞Â¢ûÊ®£Âºè --- */
        .admin-modal-content {
            width: 90vw;
            max-width: 1000px;
            height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .admin-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid #374151;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            overflow-x: auto;
            overflow-y: hidden;
            /* Á¶ÅÊ≠¢ÂûÇÁõ¥ÊªæÂãï */
            flex-shrink: 0;
            /* Èò≤Ê≠¢Ë¢´Â£ìÁ∏Æ */
        }

        .admin-tabs::-webkit-scrollbar {
            height: 8px;
        }

        .admin-tabs::-webkit-scrollbar-track {
            background: #1f2937;
            /* gray-800 */
            border-radius: 4px;
        }

        .admin-tabs::-webkit-scrollbar-thumb {
            background: #4b5563;
            /* gray-600 */
            border-radius: 4px;
        }

        .admin-tabs::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
            /* gray-500 */
        }



        .admin-tab-btn {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            color: #9ca3af;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .admin-tab-btn:hover {
            color: #e5e7eb;
        }

        .admin-tab-btn.active {
            color: #818cf8;
            border-bottom-color: #818cf8;
        }

        .admin-tab-content {
            display: none;
            padding-top: 1.5rem;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background-color: #374151;
            border-radius: 0.375rem;
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .admin-list-item:hover {
            border-color: #4f46e5;
        }

        .admin-list-item img {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
        }

        .admin-list-item .channel-name {
            flex-grow: 1;
            font-weight: 500;
            min-width: 0;
        }

        .admin-list-item .channel-name span {
            display: block;
        }

        .admin-list-item .channel-name .name {
            color: #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-list-item .channel-name .id {
            font-size: 0.75rem;
            color: #9ca3af;
            font-family: monospace;
        }

        .admin-btn {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: background-color 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .admin-btn:active {
            transform: scale(0.95);
        }

        .admin-btn-approve {
            background-color: #22c55e;
            color: #fff;
        }

        .admin-btn-approve:hover {
            background-color: #16a34a;
        }

        .admin-btn-reject {
            background-color: #ef4444;
            color: #fff;
        }

        .admin-btn-reject:hover {
            background-color: #dc2626;
        }

        .admin-btn-delete {
            background-color: #6b7280;
            color: #fff;
        }

        .admin-btn-delete:hover {
            background-color: #4b5563;
        }

        .admin-btn-add {
            background-color: #6366f1;
            color: #fff;
        }

        .admin-btn-add:hover {
            background-color: #4f46e5;
        }

        .admin-add-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .admin-add-form input {
            flex-grow: 1;
            background-color: #4b5563;
            border: 1px solid #6b7280;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            color: #fff;
            outline: none;
        }

        .admin-add-form input:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #4f46e5;
        }

        /* --- END: Admin UI Êñ∞Â¢ûÊ®£Âºè --- */

        /* Leaderboard FAB */
        .leaderboard-fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: pulse-glow 2s infinite;
        }

        .leaderboard-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 165, 0, 0.6);
        }

        .leaderboard-fab::after {
            content: 'ÁàÜËÇùÊåáÊï∏Ê¶ú';
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        .leaderboard-fab:hover::after {
            opacity: 1;
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        /* Leaderboard Modal */
        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .leaderboard-content {
            background: rgba(30, 30, 30, 0.95);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slide-up 0.3s ease-out;
        }

        @keyframes slide-up {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .leaderboard-header {
            padding: 20px;
            background: linear-gradient(to right, #1a1a1a, #2a2a2a);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .leaderboard-hint {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }

        .leaderboard-close {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .leaderboard-close:hover {
            color: white;
        }

        .leaderboard-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: transform 0.2s, background 0.2s;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .rank-badge {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 50%;
            margin-right: 15px;
            font-size: 1.1rem;
            color: #888;
        }

        .rank-1 .rank-badge {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            font-size: 1.5rem;
        }

        .rank-2 .rank-badge {
            color: #C0C0C0;
            text-shadow: 0 0 10px rgba(192, 192, 192, 0.5);
            font-size: 1.3rem;
        }

        .rank-3 .rank-badge {
            color: #CD7F32;
            text-shadow: 0 0 10px rgba(205, 127, 50, 0.5);
            font-size: 1.3rem;
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
            display: block;
            text-decoration: none;
        }

        .channel-name:hover {
            text-decoration: underline;
        }

        .dedication-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 5px;
        }

        .progress-bar-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 3px;
            width: 0;
            transition: width 1s ease-out;
        }

        .rank-1 .progress-bar-fill {
            background: linear-gradient(90deg, #FFD700, #FFC107);
        }

        .rank-2 .progress-bar-fill {
            background: linear-gradient(90deg, #C0C0C0, #E0E0E0);
        }

        .rank-3 .progress-bar-fill {
            background: linear-gradient(90deg, #CD7F32, #D2691E);
        }

        /* Scrollbar for modal */
        .leaderboard-list::-webkit-scrollbar {
            width: 6px;
        }

        .leaderboard-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .leaderboard-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* --- START: ÂÖ¨ÂëäÊ¨ÑÊ®£Âºè --- */
        #announcement-banner {
            display: none;
            position: relative;
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 40;
            transition: transform 0.3s ease-in-out;
        }

        #announcement-banner.visible {
            display: flex;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        #announcement-banner.type-info {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2) 0%, rgba(30, 64, 175, 0.2) 100%);
            border-bottom-color: rgba(59, 130, 246, 0.3);
        }

        #announcement-banner.type-warning {
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.2) 0%, rgba(180, 83, 9, 0.2) 100%);
            border-bottom-color: rgba(245, 158, 11, 0.3);
        }

        #announcement-banner.type-critical {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.2) 0%, rgba(153, 27, 27, 0.2) 100%);
            border-bottom-color: rgba(239, 68, 68, 0.3);
        }

        .announcement-content {
            flex-grow: 1;
            text-align: center;
            font-weight: 500;
            color: #f3f4f6;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .announcement-icon {
            flex-shrink: 0;
            width: 1.25rem;
            height: 1.25rem;
        }

        .type-info .announcement-icon {
            color: #60a5fa;
        }

        .type-warning .announcement-icon {
            color: #fbbf24;
        }

        .type-critical .announcement-icon {
            color: #f87171;
        }

        #close-announcement-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.2s, background-color 0.2s;
            margin-left: 1rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            /* Mobile friendly touch target */
            min-width: 44px;
        }

        #close-announcement-btn:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }


        .duration-line-container {
            position: relative;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            width: 100%;
            margin-top: -2px;
            /* Pull up to touch image */
            z-index: 10;
        }

        .duration-line-accent {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, transparent, #06b6d4);
            opacity: 0.8;
            box-shadow: 0 0 4px rgba(6, 182, 212, 0.4);
        }

        .duration-text-c {
            position: absolute;
            right: 0;
            bottom: 2px;
            padding: 0 4px;
            color: #ffffff;
            font-size: 0.75rem;
            font-weight: bold;
            font-family: monospace;
            /* Strong black contour + Cyan glow */
            text-shadow:
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000,
                0 0 4px rgba(6, 182, 212, 0.8);
            line-height: 1;
            pointer-events: none;
        }

        /* Live Stream Bar Styles */
        .live-stream-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .live-stream-container::-webkit-scrollbar {
            display: none;
        }

        /* --- END: ÂÖ¨ÂëäÊ¨ÑÊ®£Âºè --- */

        /* --- START: Stories Filter Style --- */
        .stories-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .stories-container {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 0.5rem 2.5rem 1rem 2.5rem;
            /* Added 40px padding on sides for fade space */
            scrollbar-width: none;
            /* Firefox */
            -webkit-mask-image: linear-gradient(to right, transparent, black 40px, black calc(100% - 40px), transparent);
            mask-image: linear-gradient(to right, transparent, black 40px, black calc(100% - 40px), transparent);
            touch-action: pan-x;
            /* Ensure touch scrolling works */
        }

        .stories-scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid #374151;
            color: #9ca3af;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        .stories-scroll-btn:hover {
            background: rgba(55, 65, 81, 1);
            color: #22d3ee;
            border-color: #22d3ee;
        }

        .stories-scroll-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .stories-scroll-btn.left {
            left: 4px;
        }

        .stories-scroll-btn.right {
            right: 4px;
        }

        .stories-container::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari */
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            flex-shrink: 0;
            /* Important for scrolling */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 72px;
        }

        .story-item:hover {
            transform: translateY(-2px);
        }



        .story-ring {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            padding: 2px;
            border: 2px solid #374151;
            /* gray-700 */
            transition: all 0.3s;
            position: relative;
        }

        .story-item.active .story-ring {
            border-color: #22d3ee;
            /* cyan-400 */
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.4);
        }

        .story-item.active .story-ring::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid #22d3ee;
            opacity: 0.5;
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }

            100% {
                transform: scale(1.1);
                opacity: 0;
            }
        }

        /* LIVE Badge Styles */
        @keyframes live-pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.05);
            }
        }

        @keyframes live-border-pulse {

            0%,
            100% {
                box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 0 25px rgba(239, 68, 68, 0.7);
            }
        }

        .live-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
            animation: live-pulse 1.5s ease-in-out infinite;
            z-index: 30;
        }

        .live-badge .live-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: live-pulse 1s ease-in-out infinite;
        }

        .stream-card.is-live {
            animation: live-border-pulse 2s ease-in-out infinite;
        }

        .story-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            background-color: #1f2937;
        }

        .story-name {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
            transition: color 0.2s;
        }

        .story-item.active .story-name {
            color: #22d3ee;
            font-weight: bold;
        }

        /* --- END: Stories Filter Style --- */

        /* --- START: Stream Details Modal --- */
        .stream-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            animation: fadeIn 0.2s ease-out;
        }

        .stream-modal-content {
            background: #111827;
            /* gray-900 */
            border: 1px solid #374151;
            /* gray-700 */
            border-radius: 1rem;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            transform: scale(0.95);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes popIn {
            to {
                transform: scale(1);
            }
        }

        .modal-header {
            padding: 1.5rem;
            background: linear-gradient(to bottom, #1f2937, #111827);
            border-bottom: 1px solid #374151;
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close-btn:hover {
            background: #ef4444;
            transform: rotate(90deg);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .clip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .clip-card-mini {
            background: #1f2937;
            border-radius: 0.5rem;
            overflow: hidden;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .clip-card-mini:hover {
            transform: translateY(-2px);
            border-color: #22d3ee;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        /* --- END: Stream Details Modal --- */
    </style>
</head>


<body class="bg-gray-900 text-white font-sans">

    <!-- ÂÖ¨ÂëäÊ¨ÑÂÆπÂô® -->
    <div id="announcement-banner">
        <div class="announcement-content">
            <svg class="announcement-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="announcement-text"></span>
        </div>
        <button id="close-announcement-btn" aria-label="ÈóúÈñâÂÖ¨Âëä">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <div id="app"></div>

    <!-- Leaderboard FAB -->
    <div class="leaderboard-fab" onclick="openLeaderboard()">
        <span style="font-size: 24px;">üèÜ</span>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="leaderboard-modal" onclick="closeLeaderboard(event)">
        <div class="leaderboard-content">
            <div class="leaderboard-header">
                <div>
                    <div class="leaderboard-title">üî• 30Â§©ÁàÜËÇùÊåáÊï∏ÊéíË°åÊ¶ú</div>
                    <div class="leaderboard-hint">Áµ±Ë®àÈÅéÂéª 30 Â§©ÂÖßÁôºÂ∏ÉÁöÑÊâÄÊúâÂΩ±ÁâáÁ∏ΩÊôÇÈï∑</div>
                </div>
                <button class="leaderboard-close" onclick="closeLeaderboard(event, true)">&times;</button>
            </div>
            <div id="leaderboardList" class="leaderboard-list">
                <!-- Items will be injected here -->
                <div style="text-align: center; padding: 20px; color: #888;">ËºâÂÖ•‰∏≠...</div>
            </div>
        </div>
    </div>

    <script type="module">
        // Leaderboard Functions
        async function openLeaderboard() {
            const modal = document.getElementById('leaderboardModal');
            const list = document.getElementById('leaderboardList');
            modal.style.display = 'flex';

            try {
                const response = await fetchApi('leaderboard');
                const data = response; // fetchApi returns data directly

                if (!data || data.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ÁõÆÂâçÊ≤íÊúâÊï∏Êìö</div>';
                    return;
                }

                const maxMinutes = data[0].totalMinutes; // For progress bar calculation

                list.innerHTML = data.map((item, index) => {
                    const rank = index + 1;
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    const percentage = (item.totalMinutes / maxMinutes) * 100;

                    return `
                        <div class="leaderboard-item ${rankClass}">
                            <div class="rank-badge">${rank}</div>
                            <div class="channel-info">
                                <a href="https://www.youtube.com/channel/${item.channelId}" target="_blank" class="channel-name">${item.channelTitle}</a>
                                <div class="dedication-stats">
                                    <span>${item.totalMinutes.toLocaleString()} ÂàÜÈêò</span>
                                    <span>${item.videoCount} ÈÉ®Ââ™ËºØ</span>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to fetch leaderboard:', error);
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #ff6b6b;">ËºâÂÖ•Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶</div>';
            }
        }

        function closeLeaderboard(event, force = false) {
            if (force || event.target.id === 'leaderboardModal') {
                document.getElementById('leaderboardModal').style.display = 'none';
            }
        }

        // Expose to window for onclick handlers
        window.openLeaderboard = openLeaderboard;
        window.closeLeaderboard = closeLeaderboard;

        // --- ÂÖ®ÂüüËÆäÊï∏ËàáÁãÄÊÖãÁÆ°ÁêÜ ---
        const CURRENT_APP_VERSION = 'V14.0';
        const API_BASE_URL = 'https://vspo-proxy.vercel.app/api';
        const BLACKLIST_KEY = 'vspo_channel_blacklist';
        const LAST_SEEN_VERSION_KEY = 'vspo_last_seen_version';
        const LANGUAGE_KEY = 'vspo_active_language';

        let state = {
            allVideos: [],
            blacklist: [],
            isLoading: true,
            isClassifying: false,
            needsClassification: false,
            isUpdatingLive: false,
            liveLastUpdated: 0,
            lastYouTubeSync: null, // NEW: Specific YouTube Sync Time
            activeView: 'list', // list, latest, streams (Legacy view state)
            activeMode: 'cn', // 'cn', 'jp', 'streams' (NEW Top Level Mode)
            activeLanguage: 'cn', // Keeps track of data language (cn/jp)
            streamData: [],
            memberList: [], // NEW: Stores fetched members
            streamPagination: { page: 1, limit: 20, total: 0, totalPages: 1 },
            activeStreamFilter: 'all', // all, youtube, twitch, bilibili
            activeMemberFilterId: null, // NEW: Filter by specific member
            isLoadingStreams: false,
            livePollingId: null, // NEW: Polling ID for live status
            classificationIntervalId: null,
            lastUpdated: null,
            apiError: null,
            totalVisits: 0,
            todayVisits: 0,
            activeView: 'latest',
            activeVideoTypeFilter: 'all',
            isFilterDropdownOpen: false,
            currentPage: 1,
            itemsPerPage: 10,
            activeMemberFilter: 'all',
            activeChannelFilter: null,
            activeLanguage: 'cn',
            activeTab: 'all', // 'all', 'video', 'short', 'channels'
            visibleCount: 24, // Initial visible count for infinite scroll
            storiesScrollLeft: 0, // NEW: Persist member filter scroll (Stories)
            memberFilterScrollLeft: 0, // NEW: Persist main member filter scroll (Mobile/JP/CN)
            memberFilterScrollTop: 0,  // NEW: Persist main member filter scroll (Desktop/JP/CN)
        };

        const appContainer = document.getElementById('app');


        // ÁâàÊú¨Êõ¥Êñ∞Êó•Ë™å
        const UPDATE_LOGS = {
            'V14.0': {
                title: 'V14.0 ÊàêÂì°Áõ¥Êí≠È†ÅÈù¢ÔºÅ',
                date: '2026-01-13',
                features: [
                    '„ÄêÂè≤Ë©©Êõ¥Êñ∞„ÄëÊñ∞Â¢ûÊàêÂì°Áõ¥Êí≠È†ÅÈù¢',
                    '„ÄêÊñ∞Â¢ûÂäüËÉΩ„ÄëÂèØÈÄèÈÅéÁõ¥Êí≠ÂèçÂêëÊü•ÊâæÂâ™ËºØ',
                ]
            },
            'V13.3': {
                title: 'V13.3 Ë™∞Âø´Ë¶ÅÁõ¥Êí≠Ôºü',
                date: '2025-12-24',
                features: [
                    '„ÄêÊñ∞Â¢ûÂäüËÉΩ„ÄëÊñ∞Â¢ûÈ°ØÁ§∫24Â∞èÊôÇÂÖßÂ∑≤ÊéíÂÆöÁõ¥Êí≠',
                ]
            },
            'V13.2': {
                title: 'V13.2 BUG‰øÆÂæ©',
                date: '2025-12-21',
                features: [
                    '„ÄêBUG‰øÆÂæ©„Äë‰øÆÂæ©ÊâãÊ©üÁâàÊá∏ÊµÆË¶ñÁ™óÈÇèËºØÔºöÈªûÊìäÈ†êË¶ΩÔºåÂÜçÊ¨°ÈªûÊìäË∑≥ËΩâ',
                ]
            },
            'V13.1': {
                title: 'V13.1 BUG‰øÆÂæ©',
                date: '2025-12-20',
                features: [
                    '„ÄêBUG‰øÆÂæ©„Äë‰øÆÂæ©ÊâãÊ©üÁâàÊúâÊôÇÊúÉÊç≤ÂõûÈ†ÅÈù¢È†ÇÁ´Ø‰πãÂïèÈ°å',
                ]
            },
            'V13.0': {
                title: 'V13.0 Êá∏ÂÅúÈ†êË¶ΩËàáË°åÂãïÁâàÂÑ™Âåñ',
                date: '2025-12-19',
                features: [
                    '„ÄêÊñ∞Â¢ûÂäüËÉΩ„ÄëÁõ¥Êí≠Êá∏ÂÅúÈ†êË¶ΩÔºöÊîØÊè¥ YouTube / Twitch / Bilibili ÂÖ®Âπ≥Âè∞„ÄÇ',
                    '„ÄêÈ´îÈ©óÂÑ™Âåñ„ÄëÊâãÊ©üÁâàÈªûÊìäÈ†≠ÂÉèÂèØÈ†êË¶ΩÔºåÂÜçÊ¨°ÈªûÊìäÊâçË∑≥ËΩâ„ÄÇ',
                    '„Äê‰ªãÈù¢ÂÑ™Âåñ„ÄëÁõ¥Êí≠ÂàóÊñ∞Â¢ûÂ∑¶Âè≥Êç≤ÂãïÁÆ≠È†≠ËàáÊåáÊ®ô„ÄÇ',
                ]
            },
            'V12.9': {
                title: 'V12.9 Ë™∞Âú®Áõ¥Êí≠‰∏≠ÔºÅ',
                date: '2025-12-18',
                features: [
                    '„ÄêÂäüËÉΩÊñ∞Â¢û„ÄëÊñ∞Â¢ûËÉΩÊü•ÁúãÁõ¥Êí≠‰∏≠ÊàêÂì°ÁöÑÊ¨Ñ‰Ωç',
                ]
            },
            'V12.8': {
                title: 'V12.8 Á≥ªÁµ±ÂÑ™Âåñ',
                date: '2025-12-17',
                features: [
                    '„ÄêBUG‰øÆÂæ©„ÄëÊâãÊ©üÁâàÂΩ±ÁâáÈ°ûÂûãÈÅ∏ÂñÆ‰øÆÂæ©„ÄÇ',
                    '„ÄêBUG‰øÆÂæ©„Äë‰∏≠ÊñáÁØ©ÈÅ∏È†ªÈÅìÊèêÁ§∫‰øÆÂæ©„ÄÇ',
                    '„ÄêÊñ∞Â¢ûÂäüËÉΩ„ÄëÊªëÈº†Êá∏ÂÅúÈ°ØÁ§∫Ë©≥Á¥∞ÁôºÂ∏ÉÊôÇÈñì„ÄÇ',
                    '„ÄêÈ´îÈ©óÂÑ™Âåñ„ÄëShorts ÊîπÊé°Áõ¥ÂºèÂΩ±ÁâáÁ∂≤ÂùÄÈÄ£Â§ñ„ÄÇ',
                ]
            },
            'V12.6': {
                title: 'V12.6 Á≥ªÁµ±ÂÑ™Âåñ',
                date: '2025-12-16',
                features: [
                    '„ÄêBUG‰øÆÂæ©„Äë‰øÆÂæ©‰∏çÂêåË™ûÂçÄÈñìÁØ©ÈÅ∏ÁãÄÊÖãÂÅúÁïôÁöÑÂïèÈ°å„ÄÇ',
                ]
            },
            'V12.5': {
                title: 'V12.5 Êó•ÊñáÂçÄÂ§ßÊîπÁâà',
                date: '2025-12-16',
                features: [
                    '„ÄêUIÊõ¥Êñ∞„ÄëÊó•ÊñáÂçÄÂçáÁ¥öÁÇ∫„ÄåÂàÜÈ†ÅÂºè„ÄçË®≠Ë®à„ÄÇ',
                ]
            },
            'V12.4': {
                title: 'V12.4 Á≥ªÁµ±ÂÑ™Âåñ',
                date: '2025-12-12',
                features: [
                    '„ÄêÊû∂ÊßãÊõ¥Êñ∞„ÄëÂæåÁ´ØË≥áÊñôÂ∫´ËΩâÁßª„ÄÇ',
                    '„ÄêÊïàËÉΩÂÑ™Âåñ„ÄëÂ§ßÂπÖÈôç‰ΩéË≥áÊñôÂÇ≥Ëº∏ÈáèÔºåÊèêÂçáËºâÂÖ•ÈÄüÂ∫¶„ÄÇ',
                ]
            },
            'V12.3': {
                title: 'V12.3 ÊôÇÈï∑È°ØÁ§∫',
                date: '2025-12-08',
                features: [
                    'Êñ∞Â¢ûÈ°ØÁ§∫ÂΩ±ÁâáÊôÇÈï∑',
                ]
            },
            'V12.2': {
                title: 'V12.2 UIÂÑ™Âåñ',
                date: '2025-12-07',
                features: [
                    '‰øÆÂæ©‰∫ÜÂÖ¨ÂëäÊàñÊõ¥Êñ∞Êó•Ë™åÈÅéÈï∑ÊôÇÁÑ°Ê≥ïÊç≤ÂãïÁöÑÂïèÈ°å„ÄÇ',
                ]
            },
            'V12.1': {
                title: 'V12.1 ÁàÜËÇùÊéíË°åÊ¶úÔºÅ',
                date: '2025-12-05',
                features: [
                    ' Êñ∞Â¢û„Äå30Â§©ÁàÜËÇùÊåáÊï∏ÊéíË°åÊ¶ú„ÄçÔºÅ',
                    ' ÈªûÊìäÂè≥‰∏ãËßíüèÜÊü•ÁúãÁÉ§ËÇâMANÂÄëÁöÑÁàÜËÇùÁ®ãÂ∫¶„ÄÇ',
                ]
            },
            'V12.0': {
                title: 'V12.0 Ëá™ÂãïÊêúÁ¥¢ÔºÅ',
                date: '2025-12-04',
                features: [
                    '„ÄêÂäüËÉΩÂ¢ûÂº∑„ÄëÁèæÂú®ÊúÉÁî±Á≥ªÁµ±Ëá™ÂãïÊé¢Á¥¢Êñ∞È†ªÈÅì„ÄÇ',
                ]
            },
            'V11.1': {
                title: 'V11.1 BUG‰øÆÂæ©',
                date: '2025-08-23',
                features: ['„ÄêBUG‰øÆÂæ©„Äë‰øÆÂæ©„ÄåÂè™ÁúãÂΩ±Áâá„ÄçÂàÜÈ°ûÂ§±ÊïàÂïèÈ°å',]
            },
            'V11.0': {
                title: 'V11.0 Êó•ÊñáÁ≤æËèØÊîØÊè¥',
                date: '2025-08-19',
                features: [
                    '„ÄêÈáçÂ§ßÊõ¥Êñ∞„ÄëÊñ∞Â¢û„ÄåÊó•ÊñáÁ≤æËèØ„ÄçÈ†ÅÈù¢ÔºåÂèØÂú®È†ÇÈÉ®Ëá™Áî±ÂàáÊèõÔºÅ',
                    '„ÄêÈáçÂ§ßÊõ¥Êñ∞„ÄëÊñ∞Â¢û„ÄåÂêåÂÖÉÈÖç‰ø°„ÄçÂèØÊü•Áúã„ÄåÂêåÂ†¥Áõ¥Êí≠„Äç‰πãÂâ™ËºØÔºÅ',
                ]
            },
            'V10.0': {
                title: 'V10.0 ÊïàËÉΩÂçáÁ¥öÔºÅ',
                date: '2025-07-21',
                features: [
                    '„ÄêÊû∂ÊßãÂçáÁ¥ö„ÄëÈ†ÅÈù¢ËºâÂÖ•ÈÄüÂ∫¶ÊèêÂçá 90%ÔºÅ',
                    '„ÄêÁÑ°Á∏´È´îÈ©ó„ÄëÂàÜÈ°ûÈÅéÁ®ã‰∏≠ÁØ©ÈÅ∏ÊåâÈàïÊúÉÈ°ØÁ§∫„ÄåÂàÜÈ°û‰∏≠„ÄçÔºåÂÆåÊàêÂæåËá™ÂãïËß£ÈéñÔºåÁÑ°ÈúÄÊâãÂãïÈáçÊï¥„ÄÇ',
                    '„ÄêËá™ÂãïÊõ¥Êñ∞„ÄëÁèæÂú®ÂïüÂãïÊáâÁî®Á®ãÂºèÊôÇÔºåÊúÉËá™ÂãïÂú®ËÉåÊôØÊ™¢Êü•ÊòØÂê¶ÊúâÊñ∞ÁâàÊú¨ÔºåÈúÄË¶ÅÊôÇÊâçÊúÉÊèêÁ§∫ÊÇ®Êõ¥Êñ∞„ÄÇ',
                ]
            },
        };

        // VSPO ÊàêÂì°Ë≥áÊñô (ËàáÊÇ®ÂéüÂÖàÁõ∏Âêå)
        const vspoJPMembers = [{ "name_jp": "Ëä±ËäΩ„Åô„Åø„Çå", "filter_keyword": "Ëä±ËäΩ„Åô„Åø„Çå", "color": "#b0c4de" }, { "name_jp": "Ëä±ËäΩ„Å™„Åö„Å™", "filter_keyword": "Ëä±ËäΩ„Å™„Åö„Å™", "color": "#fabedc" }, { "name_jp": "Â∞èÈõÄ„Å®„Å®", "filter_keyword": "Â∞èÈõÄ„Å®„Å®", "color": "#f5eb4a" }, { "name_jp": "‰∏Ä„ÉéÁÄ¨„ÅÜ„Çã„ÅØ", "filter_keyword": "‰∏Ä„ÉéÁÄ¨„ÅÜ„Çã„ÅØ", "color": "#4182fa" }, { "name_jp": "ËÉ°Ê°É„ÅÆ„ÅÇ", "filter_keyword": "ËÉ°Ê°É„ÅÆ„ÅÇ", "color": "#ffdbfe" }, { "name_jp": "ÂÖéÂí≤„Éü„Éü", "filter_keyword": "ÂÖéÂí≤„Éü„Éü", "color": "#c7b2d6" }, { "name_jp": "Á©∫ÊæÑ„Çª„Éä", "filter_keyword": "Á©∫ÊæÑ„Çª„Éä", "color": "#ffffff" }, { "name_jp": "Ê©ò„Å≤„Å™„ÅÆ", "filter_keyword": "Ê©ò„Å≤„Å™„ÅÆ", "color": "#fa96c8" }, { "name_jp": "Ëã±„É™„Çµ", "filter_keyword": "Ëã±„É™„Çµ", "color": "#d1de79" }, { "name_jp": "Â¶ÇÊúà„Çå„Çì", "filter_keyword": "Â¶ÇÊúà„Çå„Çì", "color": "#be2152" }, { "name_jp": "Á•ûÊàê„Åç„ÇÖ„Å¥", "filter_keyword": "Á•ûÊàê„Åç„ÇÖ„Å¥", "color": "#ffd23c" }, { "name_jp": "ÂÖ´Èõ≤„Åπ„Å´", "filter_keyword": "ÂÖ´Èõ≤„Åπ„Å´", "color": "#85cab3" }, { "name_jp": "ËóçÊ≤¢„Ç®„Éû", "filter_keyword": "ËóçÊ≤¢„Ç®„Éû", "color": "#b4f1f9" }, { "name_jp": "Á¥´ÂÆÆ„Çã„Å™", "filter_keyword": "Á¥´ÂÆÆ„Çã„Å™", "color": "#d6adff" }, { "name_jp": "Áå´Ê±∞„Å§„Å™", "filter_keyword": "Áå´Ê±∞„Å§„Å™", "color": "#ff3652" }, { "name_jp": "ÁôΩÊ≥¢„Çâ„ÇÄ„Å≠", "filter_keyword": "ÁôΩÊ≥¢„Çâ„ÇÄ„Å≠", "color": "#8eced9" }, { "name_jp": "Â∞èÊ£Æ„ÇÅ„Å®", "filter_keyword": "Â∞èÊ£Æ„ÇÅ„Å®", "color": "#fba03f" }, { "name_jp": "Â§¢Èáé„ÅÇ„Åã„Çä", "filter_keyword": "Â§¢Èáé„ÅÇ„Åã„Çä", "color": "#ff998d" }, { "name_jp": "Â§ú‰πÉ„Åè„Çç„ÇÄ", "filter_keyword": "Â§ú‰πÉ„Åè„Çç„ÇÄ", "color": "#909ec8" }, { "name_jp": "Á¥°Êú®„Åì„Åã„Åí", "filter_keyword": "Á¥°Êú®„Åì„Åã„Åí", "color": "#5195e1" }, { "name_jp": "ÂçÉÁáà„ÇÜ„ÅÜ„Å≤", "filter_keyword": "ÂçÉÁáà„ÇÜ„ÅÜ„Å≤", "color": "#ed784a" }, { "name_jp": "Ëù∂Â±ã„ÅØ„Å™„Å≥", "filter_keyword": "Ëù∂Â±ã„ÅØ„Å™„Å≥", "color": "#ea5506" }, { "name_jp": "ÁîòÁµê„ÇÇ„Åã", "filter_keyword": "ÁîòÁµê„ÇÇ„Åã", "color": "#eca0aa" }, { "name_jp": "ÈäÄÂüé„Çµ„Ç§„Éç", "filter_keyword": "ÈäÄÂüé„Çµ„Ç§„Éç", "color": "#58535E", "forceWhiteText": true }, { "name_jp": "ÈæçÂ∑ª„Å°„Åõ", "filter_keyword": "ÈæçÂ∑ª„Å°„Åõ", "color": "#BEFF77" }];
        const otherMemberGroups = { "VSPO! EN": [{ "name_jp": "Remia Aotsuki", "filter_keyword": "Remia", "color": "#398FB2", "forceWhiteText": true }, { "name_jp": "Arya Kuroha", "filter_keyword": "Arya", "color": "#000000", "forceWhiteText": true }, { "name_jp": "Jira Jisaki", "filter_keyword": "Jira", "color": "#606D3D", "forceWhiteText": true }, { "name_jp": "Narin Mikure", "filter_keyword": "Narin", "color": "#F3A6EF", "forceWhiteText": true }, { "name_jp": "Riko Solari", "filter_keyword": "Riko", "color": "#9373D7", "forceWhiteText": true }, { "name_jp": "Eris Suzukami", "filter_keyword": "Eris", "color": "#E9F3FD" }], "VSPO! CN": [{ "name_jp": "Â∞èÈíàÂΩ©", "filter_keyword": "Â∞èÈáùÂΩ©", "color": "#FE688D", "forceWhiteText": true }, { "name_jp": "ÁôΩÂí≤Èú≤ÁêÜ", "filter_keyword": "ÁôΩÂí≤Èú≤ÁêÜ", "color": "#E9E5E6", "forceWhiteText": true }, { "name_jp": "Â∏ïÂ¶É", "filter_keyword": "Â∏ïÂ¶É", "color": "#9F0019", "forceWhiteText": true }, { "name_jp": "ÂçÉÈÉÅÈÉÅ", "filter_keyword": "ÂçÉÈÉÅÈÉÅ", "color": "#8986C0", "forceWhiteText": true }] };
        const allMembers = [...vspoJPMembers, ...Object.values(otherMemberGroups).flat()];

        // --- ÈªëÂêçÂñÆ & Modal Áõ∏ÈóúÂáΩÂºè (Ëàá‰πãÂâçÁõ∏Âêå) ---
        function getBlacklist() { try { const stored = localStorage.getItem(BLACKLIST_KEY); return stored ? JSON.parse(stored) : []; } catch (e) { console.error("ËÆÄÂèñÈªëÂêçÂñÆÂ§±Êïó:", e); return []; } }
        function saveBlacklist(blacklist) { try { localStorage.setItem(BLACKLIST_KEY, JSON.stringify(blacklist)); } catch (e) { console.error("ÂÑ≤Â≠òÈªëÂêçÂñÆÂ§±Êïó:", e); } }
        function addToBlacklist(channel) { const currentBlacklist = getBlacklist(); if (!currentBlacklist.some(item => item.id === channel.id)) { const newBlacklist = [...currentBlacklist, channel]; saveBlacklist(newBlacklist); state.blacklist = newBlacklist; render(); showBlacklistModal(); } }
        function removeFromBlacklist(channelId) { const currentBlacklist = getBlacklist(); const newBlacklist = currentBlacklist.filter(item => item.id !== channelId); saveBlacklist(newBlacklist); state.blacklist = newBlacklist; render(); showBlacklistModal(); }
        function showBlacklistModal() {
            const existingModal = document.getElementById('blacklist-modal');
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'blacklist-modal';
            modalOverlay.className = 'modal-overlay visible';
            const currentBlacklist = getBlacklist();
            const allChannels = [...new Map(state.allVideos.map(v => [v.channelId, { id: v.channelId, name: v.channelTitle }])).values()].sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant'));
            const channelsToBlock = allChannels.filter(channel => !currentBlacklist.some(b => b.id === channel.id));
            let blockedListHTML = '<p class="text-gray-400 text-sm">ÁõÆÂâçÊ≤íÊúâÂ∑≤Â∞ÅÈéñ„ÅÆÈ†ªÈÅì„ÄÇ</p>';
            if (currentBlacklist.length > 0) {
                blockedListHTML = currentBlacklist.map(channel => `<div class="flex items-center justify-between p-2 bg-gray-700 rounded-md"><span class="truncate">${channel.name}</span><button class="unblock-btn text-red-400 hover:text-red-300 font-semibold text-sm" data-channel-id="${channel.id}">Ëß£Èô§Â∞ÅÈéñ</button></div>`).join('');
            }
            modalOverlay.innerHTML = `<div class="modal-content"><h3 class="text-2xl font-bold text-red-400 mb-4">ÁÆ°ÁêÜÂÄã‰∫∫ÈªëÂêçÂñÆ</h3><div class="mb-6"><h4 class="font-semibold mb-2 text-gray-300">Â∑≤Â∞ÅÈéñÊ∏ÖÂñÆ</h4><div class="space-y-2 max-h-48 overflow-y-auto p-2 bg-gray-900 rounded-lg">${blockedListHTML}</div></div><div class="border-t border-gray-600 pt-6"><h4 class="font-semibold mb-2 text-gray-300">Êñ∞Â¢ûÂ∞ÅÈéñ</h4><div class="flex space-x-2"><select id="channel-to-block-select" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-400"><option value="">-- Ë´ãÈÅ∏ÊìáË¶ÅÂ∞ÅÈéñÁöÑÈ†ªÈÅì --</option>${channelsToBlock.map(c => `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`).join('')}</select><button id="add-to-blacklist-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex-shrink-0">Â∞ÅÈéñ</button></div></div><button id="close-blacklist-modal-btn" class="mt-8 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">ÈóúÈñâ</button></div>`;
            document.body.appendChild(modalOverlay);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay || e.target.id === 'close-blacklist-modal-btn' || e.target.closest('#close-blacklist-modal-btn')) { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); } });
            document.getElementById('add-to-blacklist-btn').addEventListener('click', () => { const select = document.getElementById('channel-to-block-select'); const channelId = select.value; if (channelId) { const selectedOption = select.options[select.selectedIndex]; const channelName = selectedOption.dataset.name; addToBlacklist({ id: channelId, name: channelName }); } });
            document.querySelectorAll('.unblock-btn').forEach(btn => { btn.addEventListener('click', (e) => { const channelId = e.currentTarget.dataset.channelId; removeFromBlacklist(channelId); }); });
        }
        function showUpdateModal(title, message, showDownloadButton = false) {
            const existingModal = document.getElementById('update-modal');
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'update-modal';
            modalOverlay.className = 'modal-overlay';
            let downloadButtonHTML = '';
            if (showDownloadButton) { const releaseUrl = "https://github.com/renachiouo/vspo_clip_collector/releases"; if (navigator.userAgent.toLowerCase().includes('wv')) { downloadButtonHTML = `<div class="mt-6 p-3 bg-gray-900 rounded-lg"><p class="text-sm text-gray-400 mb-2">Ë´ãË§áË£Ω‰ª•‰∏ãÁ∂≤ÂùÄÔºå‰∏¶Âú®ÊÇ®ÁöÑÊâãÊ©üÁÄèË¶ΩÂô®‰∏≠ÈñãÂïü‰ª•‰∏ãËºâÊõ¥Êñ∞Ôºö</p><input type="text" readonly value="${releaseUrl}" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none select-all"></div>`; } else { downloadButtonHTML = `<a href="${releaseUrl}" target="_blank" rel="noopener noreferrer" class="mt-6 block w-full text-center px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition-colors">ÂâçÂæÄ‰∏ãËºâÈ†ÅÈù¢</a>`; } }
            modalOverlay.innerHTML = `<div class="modal-content"><h3 class="text-2xl font-bold text-cyan-400 mb-4">${title}</h3><p class="text-gray-300">${message}</p>${downloadButtonHTML}<button id="close-modal-btn" class="mt-4 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">ÈóúÈñâ</button></div>`;
            document.body.appendChild(modalOverlay);
            setTimeout(() => modalOverlay.classList.add('visible'), 10);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay || e.target.id === 'close-modal-btn' || e.target.closest('#close-modal-btn')) { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); } });
            const urlInput = modalOverlay.querySelector('input[type="text"]'); if (urlInput) { urlInput.addEventListener('click', () => urlInput.select()); }
        }
        function showVersionUpdateModal(versionsToShow) {
            const existingModal = document.getElementById('version-update-modal');
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'version-update-modal';
            modalOverlay.className = 'modal-overlay';
            let allFeaturesHTML = '';
            if (Array.isArray(versionsToShow)) {
                versionsToShow.forEach((version, index) => {
                    const log = UPDATE_LOGS[version]; if (!log) return;
                    const featuresHTML = log.features.map(feature => `<li class="flex items-start"><svg class="w-5 h-5 mr-2 text-green-400 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>${feature}</span></li>`).join('');
                    allFeaturesHTML += `${index > 0 ? '<hr class="border-gray-600 my-4">' : ''}<div class="text-center mb-4"><h4 class="text-xl font-bold text-green-400">${log.title}</h4><p class="text-xs text-gray-500">ÁôºÂ∏ÉÊó•Êúü: ${log.date}</p></div><ul class="space-y-3 text-gray-300">${featuresHTML}</ul>`;
                });
            }
            modalOverlay.innerHTML = `<div class="modal-content" style="max-height: 80vh; overflow-y: auto; display: flex; flex-direction: column;"><div>${allFeaturesHTML}</div><button id="close-version-modal-btn" class="mt-8 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors flex-shrink-0">Êàë‰∫ÜËß£‰∫Ü</button></div>`;
            document.body.appendChild(modalOverlay);
            setTimeout(() => modalOverlay.classList.add('visible'), 10);
            const closeModal = () => { modalOverlay.classList.remove('visible'); localStorage.setItem(LAST_SEEN_VERSION_KEY, CURRENT_APP_VERSION); setTimeout(() => modalOverlay.remove(), 300); };
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay || e.target.id === 'close-version-modal-btn' || e.target.closest('#close-version-modal-btn')) { closeModal(); } });
        }

        // Helper for global access (onclick)
        window.showLatestUpdateLogs = () => {
            const versions = Object.keys(UPDATE_LOGS).sort((a, b) => parseFloat(b.slice(1)) - parseFloat(a.slice(1)));
            showVersionUpdateModal(versions);
        };

        window.toggleCNFilterDropdown = (e) => {
            if (e) e.stopPropagation();
            state.isFilterDropdownOpen = !state.isFilterDropdownOpen;
            render();
        };

        window.selectCNFilter = (type) => {
            state.activeVideoTypeFilter = type;
            state.currentPage = 1;
            state.isFilterDropdownOpen = false;
            render();
        };

        // Window Event Listeners
        window.addEventListener('click', () => {
            if (state.isFilterDropdownOpen) {
                state.isFilterDropdownOpen = false;
                render();
            }
        });



        async function showRelatedClipsModal(videoId) {
            const modalId = 'related-clips-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) existingModal.remove();
            const modalOverlay = document.createElement('div');
            modalOverlay.id = modalId;
            modalOverlay.className = 'modal-overlay visible';
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '1400px';
            modalContent.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-teal-400">ÂêåÂ†¥Áõ¥Êí≠ÊâÄÊúâÂâ™ËºØ</h3>
                <button id="close-related-clips-modal-btn" class="p-2 rounded-full hover:bg-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="related-clips-container" class="max-h-[75vh] overflow-y-auto p-1">
                <div class="grid gap-4" style="grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));">
                    ${Array.from({ length: 4 }).map(() => createSkeleton('card').outerHTML).join('')}
                </div>
            </div>`;
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
            const closeModal = () => { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); };
            modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
            document.getElementById('close-related-clips-modal-btn').addEventListener('click', closeModal);



            try {
                // Force cache bust with timestamp
                const data = await fetchApi('get-related-clips', { params: { id: videoId, _t: Date.now() } });
                const container = document.getElementById('related-clips-container');
                if (data.videos && data.videos.length > 0) {
                    const grid = document.createElement('div');
                    grid.className = 'grid gap-4';
                    grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(260px, 1fr))';
                    data.videos.forEach(video => grid.appendChild(createVideoCard(video, true)));
                    container.innerHTML = '';
                    container.appendChild(grid);
                } else {
                    container.innerHTML = `<p class="text-center text-gray-400 p-8">Êâæ‰∏çÂà∞ÂÖ∂‰ªñÁõ∏ÈóúÂâ™ËºØ„ÄÇ</p>`;
                }
            } catch (error) {
                console.error("Áç≤ÂèñÁõ∏ÈóúÂâ™ËºØÂ§±Êïó:", error);
                document.getElementById('related-clips-container').innerHTML = createErrorDisplay(error.message);
            }
        }

        // --- START: Admin UI Êñ∞Â¢ûÂáΩÂºè ---
        async function showAdminUI(password, activeTab = 'pending_jp') {
            const modalId = 'admin-ui-modal';
            let modalOverlay = document.getElementById(modalId);
            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.id = modalId;
                modalOverlay.className = 'modal-overlay';
                document.body.appendChild(modalOverlay);
                const closeModal = () => { modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300); };
                modalOverlay.addEventListener('click', e => { if (e.target === modalOverlay) closeModal(); });
            }

            modalOverlay.innerHTML = `<div class="modal-content admin-modal-content">
            <h3 class="text-2xl font-bold text-indigo-400 mb-4">ÁÆ°ÁêÜÂì°ÂæåÂè∞</h3>
            <div class="flex-grow flex items-center justify-center">
                <div class="spinner text-indigo-400" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
                <p class="ml-4 text-lg text-gray-400">Ê≠£Âú®ËºâÂÖ•ÂàóË°®Ë≥áÊñô...</p>
            </div>
            <button id="close-admin-modal-btn" class="mt-4 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">ÈóúÈñâ</button>
        </div>`;
            modalOverlay.querySelector('#close-admin-modal-btn').addEventListener('click', () => {
                modalOverlay.classList.remove('visible'); setTimeout(() => modalOverlay.remove(), 300);
            });

            setTimeout(() => modalOverlay.classList.add('visible'), 10);

            try {
                // Modified: fetchApi now returns { bilibili_error: boolean, ...lists }
                const listsData = await fetchApi('admin/lists', { params: { password } });

                let alertHTML = '';
                if (listsData.bilibili_error) {
                    alertHTML = `
                    <div class="mb-4 p-3 bg-red-900/30 border border-red-500/50 rounded-lg flex items-center gap-3 text-red-200">
                        <div class="text-xl">‚ö†Ô∏è</div>
                        <div class="flex-grow">
                            <div class="font-bold">Ê≥®ÊÑèÔºöBILIBILI_SESSDATA Â∑≤Â§±Êïà</div>
                            <div class="text-xs opacity-80">Ë´ãÊõ¥Êñ∞ÂæåÁ´Ø .env Ë®≠ÂÆöÔºåÂê¶ÂâáÁÑ°Ê≥ïÂêåÊ≠• Bilibili Â≠òÊ™î„ÄÇ</div>
                        </div>
                    </div>`;
                }

                modalOverlay.innerHTML = createAdminModalHTML(listsData, password, activeTab, alertHTML);
                setupAdminModalEventListeners(password);
            } catch (error) {
                console.error('ËºâÂÖ•ÁÆ°ÁêÜÂàóË°®Â§±Êïó:', error);
                modalOverlay.querySelector('.modal-content').innerHTML = `
                <h3 class="text-2xl font-bold text-red-500 mb-4">ÈåØË™§</h3>
                <p class="text-gray-300">ÁÑ°Ê≥ïËºâÂÖ•ÁÆ°ÁêÜÂàóË°®Ë≥áÊñô„ÄÇË´ãÊ™¢Êü•ÊÇ®ÁöÑÂØÜÁ¢ºÊàñÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ</p>
                <p class="mt-2 text-sm text-gray-500 bg-gray-800 p-2 rounded">${error.message}</p>
                 <button onclick="this.closest('.modal-overlay').remove()" class="mt-4 block w-full text-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors">ÈóúÈñâ</button>
            `;
            }
        }

        function createAdminModalHTML(listsData, password, activeTab = 'pending_jp', alertHTML = '') {
            const createListItems = (list, type) => {
                if (!list || list.length === 0) {
                    return '<p class="text-gray-500 text-center py-8">ÈÄôÂÄãÂàóË°®ÊòØÁ©∫ÁöÑ„ÄÇ</p>';
                }
                return list.map(channel => `
                <div class="admin-list-item">
                    <a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-4 flex-grow min-w-0 hover:opacity-80 transition-opacity group text-decoration-none">
                        <img src="${channel.avatar}" alt="${channel.name}">
                        <div class="channel-name">
                            <span class="name group-hover:text-indigo-400 transition-colors">${channel.name}</span>
                            <span class="id">${channel.id}</span>
                        </div>
                    </a>
                    <div class="ml-auto flex-shrink-0 flex gap-2">
                        ${type === 'pending' ? `
                            <button class="admin-btn admin-btn-approve" data-action="approve_jp" data-channel-id="${channel.id}">Ê†∏ÂáÜ</button>
                            <button class="admin-btn admin-btn-reject" data-action="reject_jp" data-channel-id="${channel.id}">Âê¶Ê±∫</button>
                        ` : ''}
                        ${type === 'whitelist_jp' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="jp" data-channel-id="${channel.id}">Âà™Èô§</button>` : ''}
                        ${type === 'whitelist_cn' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="cn" data-channel-id="${channel.id}">Âà™Èô§</button>` : ''}
                        ${type === 'blacklist_cn' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="blacklist_cn" data-channel-id="${channel.id}">Ëß£Èô§Â∞ÅÈéñ</button>` : ''}
                        ${type === 'blacklist_jp' ? `<button class="admin-btn admin-btn-delete" data-action="delete" data-list-type="blacklist_jp" data-channel-id="${channel.id}">Ëß£Èô§Â∞ÅÈéñ</button>` : ''}
                    </div>
                </div>
            `).join('');
            };

            return `
            <div class="modal-content admin-modal-content">
                <div class="flex justify-between items-center mb-4 flex-shrink-0">
                    <h3 class="text-2xl font-bold text-indigo-400">ÁÆ°ÁêÜÂì°ÂæåÂè∞</h3>
                    <div class="flex gap-2">
                         <button class="admin-btn-refresh bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors" data-lang="cn">Á´ãÂç≥Êõ¥Êñ∞‰∏≠ÊñáË≥áÊñô</button>
                         <button class="admin-btn-refresh bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm transition-colors" data-lang="jp">Á´ãÂç≥Êõ¥Êñ∞Êó•ÊñáË≥áÊñô</button>
                         <button class="admin-btn-trigger-live bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors flex items-center gap-1"><span class="animate-pulse">üî¥</span> Ê™¢Êü•Áõ¥Êí≠ÁãÄÊÖã</button>
                        <button id="close-admin-modal-btn" class="p-2 rounded-full hover:bg-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </div>
                </div>
                <div class="admin-tabs overflow-x-auto">
                    <button class="admin-tab-btn ${activeTab === 'pending_jp' ? 'active' : ''} whitespace-nowrap" data-tab="pending_jp">ÂæÖÂØ©Ê†∏Êó•Êñá <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-yellow-500/20 text-yellow-300">${listsData.pending_jp?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'whitelist_jp' ? 'active' : ''} whitespace-nowrap" data-tab="whitelist_jp">Êó•ÊñáÁôΩÂêçÂñÆ <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-blue-500/20 text-blue-300">${listsData.whitelist_jp?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'whitelist_cn' ? 'active' : ''} whitespace-nowrap" data-tab="whitelist_cn">‰∏≠ÊñáÁôΩÂêçÂñÆ <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-green-500/20 text-green-300">${listsData.whitelist_cn?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'blacklist_cn' ? 'active' : ''} whitespace-nowrap" data-tab="blacklist_cn">‰∏≠ÊñáÈªëÂêçÂñÆ <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-500/20 text-red-300">${listsData.blacklist_cn?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'blacklist_jp' ? 'active' : ''} whitespace-nowrap" data-tab="blacklist_jp">Êó•ÊñáÈªëÂêçÂñÆ <span class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-500/20 text-red-300">${listsData.blacklist_jp?.length || 0}</span></button>
                    <button class="admin-tab-btn ${activeTab === 'backfill' ? 'active' : ''} whitespace-nowrap" data-tab="backfill">Ë≥áÊñôÂõûÂ°´</button>
                    <button class="admin-tab-btn ${activeTab === 'video_blacklist' ? 'active' : ''} whitespace-nowrap" data-tab="video_blacklist">ÂΩ±ÁâáÈªëÂêçÂñÆ</button>
                    <button class="admin-tab-btn ${activeTab === 'announcement' ? 'active' : ''} whitespace-nowrap" data-tab="announcement">ÂÖ¨ÂëäÁÆ°ÁêÜ</button>
                    <button class="admin-tab-btn ${activeTab === 'admin_logs' ? 'active' : ''} whitespace-nowrap" data-tab="admin_logs">Êìç‰ΩúÊó•Ë™å</button>
                    <button class="admin-tab-btn ${activeTab === 'api_status' ? 'active' : ''} whitespace-nowrap" data-tab="api_status">API ÁãÄÊÖã</button>
                </div>
                <div class="flex-grow min-h-0 overflow-y-auto">
                    <div id="tab-pending_jp" class="admin-tab-content ${activeTab === 'pending_jp' ? 'active' : ''} space-y-2">${createListItems(listsData.pending_jp, 'pending')}</div>
                    <div id="tab-whitelist_jp" class="admin-tab-content ${activeTab === 'whitelist_jp' ? 'active' : ''} space-y-2">
                        <div class="admin-add-form"><input type="text" id="add-jp-input" placeholder="Ëº∏ÂÖ•Ë¶ÅÊñ∞Â¢ûÁöÑÈ†ªÈÅì ID..."><button class="admin-btn admin-btn-add" data-action="add" data-list-type="jp" data-input-id="add-jp-input">ÊâãÂãïÊñ∞Â¢û</button></div>
                        ${createListItems(listsData.whitelist_jp, 'whitelist_jp')}
                    </div>
                    <div id="tab-whitelist_cn" class="admin-tab-content ${activeTab === 'whitelist_cn' ? 'active' : ''} space-y-2">
                        <div class="admin-add-form"><input type="text" id="add-cn-input" placeholder="Ëº∏ÂÖ•Ë¶ÅÊñ∞Â¢ûÁöÑÈ†ªÈÅì ID..."><button class="admin-btn admin-btn-add" data-action="add" data-list-type="cn" data-input-id="add-cn-input">ÊâãÂãïÊñ∞Â¢û</button></div>
                        ${createListItems(listsData.whitelist_cn, 'whitelist_cn')}
                    </div>
                    <div id="tab-blacklist_cn" class="admin-tab-content ${activeTab === 'blacklist_cn' ? 'active' : ''} space-y-2">
                         <div class="admin-add-form"><input type="text" id="add-blacklist-cn-input" placeholder="Ëº∏ÂÖ•Ë¶ÅÂ∞ÅÈéñÁöÑÈ†ªÈÅì ID..."><button class="admin-btn admin-btn-add bg-red-600 hover:bg-red-700" data-action="add" data-list-type="blacklist_cn" data-input-id="add-blacklist-cn-input">ÊâãÂãïÂ∞ÅÈéñ</button></div>
                        ${createListItems(listsData.blacklist_cn, 'blacklist_cn')}
                    </div>
                    <div id="tab-blacklist_jp" class="admin-tab-content ${activeTab === 'blacklist_jp' ? 'active' : ''} space-y-2">
                         <div class="admin-add-form"><input type="text" id="add-blacklist-jp-input" placeholder="Ëº∏ÂÖ•Ë¶ÅÂ∞ÅÈéñÁöÑÈ†ªÈÅì ID..."><button class="admin-btn admin-btn-add bg-red-600 hover:bg-red-700" data-action="add" data-list-type="blacklist_jp" data-input-id="add-blacklist-jp-input">ÊâãÂãïÂ∞ÅÈéñ</button></div>
                        ${createListItems(listsData.blacklist_jp, 'blacklist_jp')}
                    </div>
                    <div id="tab-backfill" class="admin-tab-content ${activeTab === 'backfill' ? 'active' : ''} space-y-4">

                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-indigo-400 mb-4">Ê≠∑Âè≤Ë≥áÊñôÂõûÂ°´</h4>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">ÈñãÂßãÊó•Êúü</label>
                                        <input type="date" id="backfill-start-date" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-400 mb-1">ÁµêÊùüÊó•Êúü</label>
                                        <input type="date" id="backfill-end-date" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">ÁõÆÊ®ôË™ûË®Ä</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="backfill-lang" value="cn" checked class="text-indigo-500 focus:ring-indigo-500">
                                            <span class="text-gray-300">‰∏≠Êñá (VSPO‰∏≠Êñá, VSPOÁ≤æËèØ...)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="backfill-lang" value="jp" class="text-indigo-500 focus:ring-indigo-500">
                                            <span class="text-gray-300">Êó•Êñá („Å∂„ÅÑ„Åô„ÅΩ Âàá„ÇäÊäú„Åç...)</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">ÈóúÈçµÂ≠ó (ÂèØË§áÈÅ∏ÔºåË´ãË¨πÊÖéÈÅ∏Êìá‰ª•ÁØÄÁúÅ Quota)</label>
                                    <div id="backfill-keywords-container" class="grid grid-cols-2 gap-2 bg-gray-700 p-2 rounded border border-gray-600">
                                        <!-- JS will populate this -->
                                    </div>
                                </div>
                                <div class="pt-2">
                                    <button id="start-backfill-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors">ÈñãÂßãÂõûÂ°´‰ªªÂãô</button>
                                </div>
                                <div id="backfill-log" class="mt-4 p-2 bg-black rounded text-xs font-mono text-green-400 h-32 overflow-y-auto hidden"></div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-video_blacklist" class="admin-tab-content ${activeTab === 'video_blacklist' ? 'active' : ''} space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-indigo-400 mb-4">ÂΩ±ÁâáÈªëÂêçÂñÆÁÆ°ÁêÜ</h4>
                            <div class="admin-add-form mb-4">
                                <input type="text" id="add-video-blacklist-input" placeholder="Ëº∏ÂÖ•Ë¶ÅÂ∞ÅÈéñÁöÑÂΩ±Áâá ID..." class="flex-grow bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <button class="admin-btn-add bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-semibold" id="btn-add-video-blacklist">Êñ∞Â¢ûÂ∞ÅÈéñ</button>
                            </div>
                            <div id="video-blacklist-container" class="space-y-2">
                                <p class="text-gray-500 text-center py-4">ËºâÂÖ•‰∏≠...</p>
                            </div>
                        </div>
                    </div>
                    <div id="tab-announcement" class="admin-tab-content ${activeTab === 'announcement' ? 'active' : ''} space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-indigo-400 mb-4">ÁôºÂ∏ÉÊñ∞ÂÖ¨Âëä</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">ÂÖ¨ÂëäÂÖßÂÆπ</label>
                                    <textarea id="announcement-content" rows="3" class="w-full bg-gray-700 text-white p-2 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ëº∏ÂÖ•ÂÖ¨ÂëäÂÖßÂÆπ...">${listsData.announcement?.content || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">ÂÖ¨ÂëäÈ°ûÂûã</label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="announcement-type" value="info" ${!listsData.announcement?.type || listsData.announcement?.type === 'info' ? 'checked' : ''} class="text-blue-500 focus:ring-blue-500">
                                            <span class="text-blue-300">‰∏ÄËà¨ (Info)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="announcement-type" value="warning" ${listsData.announcement?.type === 'warning' ? 'checked' : ''} class="text-yellow-500 focus:ring-yellow-500">
                                            <span class="text-yellow-300">Ê≥®ÊÑè (Warning)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" name="announcement-type" value="critical" ${listsData.announcement?.type === 'critical' ? 'checked' : ''} class="text-red-500 focus:ring-red-500">
                                            <span class="text-red-300">Á∑äÊÄ• (Critical)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="announcement-active" class="sr-only peer" ${listsData.announcement?.active ? 'checked' : ''}>
                                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                        <span class="ml-3 text-sm font-medium text-gray-300">ÂïüÁî®ÂÖ¨Âëä</span>
                                    </label>
                                </div>
                                <div class="pt-2">
                                    <button id="save-announcement-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition-colors">ÂÑ≤Â≠òË®≠ÂÆö</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-admin_logs" class="admin-tab-content ${activeTab === 'admin_logs' ? 'active' : ''} space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-indigo-400 mb-4">ÁÆ°ÁêÜÂì°Êìç‰ΩúÊó•Ë™å (Áî±ËøëÂà∞ÈÅ†)</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-gray-400">
                                    <thead class="bg-gray-700 text-gray-200 uppercase">
                                        <tr>
                                            <th class="px-4 py-2">ÊôÇÈñì</th>
                                            <th class="px-4 py-2">Âãï‰Ωú</th>
                                            <th class="px-4 py-2">Ë©≥Á¥∞Ë≥áË®ä</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-logs-table-body" class="divide-y divide-gray-700">
                                        <tr><td colspan="3" class="px-4 py-4 text-center">ÈªûÊìä‰∏äÊñπÊ®ôÁ±§‰ª•ÈáçÊñ∞Êï¥ÁêÜÊó•Ë™å...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="tab-api_status" class="admin-tab-content ${activeTab === 'api_status' ? 'active' : ''} space-y-4">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h4 class="text-lg font-semibold text-indigo-400 mb-4 flex justify-between items-center">
                                 API ÈÖçÈ°çÁãÄÊÖã
                                 <div class="flex items-center space-x-2 text-sm">
                                    <label for="quota-date-select" class="text-gray-400">Êó•Êúü:</label>
                                    <select id="quota-date-select" class="bg-gray-700 text-white border border-gray-600 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                        <!-- populated dynamically -->
                                    </select>
                                 </div>
                            </h4>
                            
                            <div id="api-status-loading" class="text-center py-8 text-indigo-300 animate-pulse">Ê≠£Âú®ËºâÂÖ•ÈÖçÈ°çÊï∏Êìö...</div>
                            <div id="api-status-error" class="hidden text-center py-8 text-red-400"></div>
                            
                            <div id="api-status-content" class="hidden space-y-6">
                                <!-- 1. Overview Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                     <div class="bg-gray-700/50 p-4 rounded border border-gray-600 flex flex-col items-center justify-center">
                                        <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold">‰ªäÊó•Á∏Ω‰ΩøÁî®Èáè</span>
                                        <div class="mt-2 flex items-baseline gap-1">
                                            <span id="quota-total-used" class="text-3xl font-bold text-white">--</span>
                                            <span class="text-gray-500 text-sm">/ ~130,000</span>
                                        </div>
                                        <div class="w-full bg-gray-600 rounded-full h-1.5 mt-2 overflow-hidden">
                                            <div id="quota-progress-bar" class="bg-blue-500 h-1.5 rounded-full" style="width: 0%"></div>
                                        </div>
                                     </div>
                                     <div class="bg-gray-700/50 p-4 rounded border border-gray-600 flex flex-col items-center justify-center">
                                        <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold">Áï∂Ââç‰ΩøÁî®ÁöÑ Key</span>
                                        <div class="mt-2 flex flex-col items-center">
                                            <span id="quota-active-key" class="text-3xl font-bold text-green-400 font-mono">--</span>
                                            <span class="text-gray-500 text-xs mt-1">Key Á∑®Ëôü (0-12)</span>
                                        </div>
                                     </div>
                                     <div class="bg-gray-700/50 p-4 rounded border border-gray-600 flex flex-col items-center justify-center">
                                        <span class="text-gray-400 text-xs uppercase tracking-wider font-semibold">Ë≥áÊñôÊó•Êúü (PT)</span>
                                        <span id="quota-date-display" class="text-xl font-bold text-indigo-300 mt-2 font-mono">--</span>
                                         <span class="text-gray-500 text-xs mt-1">Â§™Âπ≥Ê¥ãÊôÇÈñì (UTC-8)</span>
                                         <div id="quota-local-date-display" class="mt-2 text-[10px] text-gray-400 bg-black/20 px-2 py-1 rounded border border-gray-600/50">
                                            Êú¨Âú∞: --
                                         </div>
                                     </div>
                                </div>

                                <!-- 2. Key Status Grid -->
                                <div>
                                    <div class="flex justify-between items-end mb-2">
                                        <h5 class="text-sm text-gray-300 font-semibold">API Key ÂÅ•Â∫∑ÁãÄÊÖã <span class="text-xs text-gray-500 font-normal ml-1">(ÈªûÊìäÊü•ÁúãË©≥ÊÉÖ)</span></h5>
                                        <div class="flex gap-3 text-[10px] text-gray-400">
                                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> ÂÆâÂÖ®/‰ΩøÁî®‰∏≠</span>
                                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> È´òË≤†Ëºâ</span>
                                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> ËÄóÁõ°</span>
                                            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full border border-white bg-transparent"></span> Áï∂Ââç</span>
                                        </div>
                                    </div>
                                    <div id="quota-keys-grid" class="grid grid-cols-4 sm:grid-cols-7 gap-2">
                                        <!-- Keys 0-12 blocks injected here -->
                                    </div>
                                </div>

                                <!-- 3. Usage Breakdown Table -->
                                <div>
                                    <h5 class="text-sm text-gray-300 font-semibold mb-2">Ë©≥Á¥∞‰ΩøÁî®ÊòéÁ¥∞</h5>
                                    <div class="overflow-x-auto bg-gray-900/30 rounded-lg border border-gray-700/50">
                                        <table class="w-full text-left text-sm text-gray-400">
                                            <thead class="bg-gray-700/50 text-gray-300 uppercase text-[10px] tracking-wider font-semibold">
                                                <tr>
                                                    <th class="px-3 py-2 w-16 text-center">Key</th>
                                                    <th class="px-3 py-2 text-right">Á∏Ω‰ΩøÁî®Èáè</th>
                                                    <th class="px-3 py-2 text-right text-indigo-300 w-24">Ê∂àËÄóÁéá</th>
                                                    <th class="px-3 py-2 text-right w-24">ÊêúÂ∞ã (100)</th>
                                                    <th class="px-3 py-2 text-right w-24">ÂΩ±Áâá (1)</th>
                                                    <th class="px-3 py-2 text-right">ÂÖ∂‰ªñ (1)</th>
                                                </tr>
                                            </thead>
                                            <tbody id="quota-breakdown-body" class="divide-y divide-gray-700/50 font-mono text-xs">
                                                 <!-- Rows populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                 <div class="text-[10px] text-gray-600 italic text-center border-t border-gray-700 pt-2 mt-2">
                                    * Êï∏ÊìöÂü∫ÊñºÊú¨Âú∞Êé®ÁÆóÔºåÂØ¶Èöõ Google Console ‰ΩøÁî®ÈáèÂèØËÉΩÁï•Êúâ‰∏çÂêå„ÄÇ<br>
                                    ÊêúÂ∞ãÊàêÊú¨: 100 ÂñÆ‰Ωç„ÄÇÂÖ∂‰ªñ (ÂΩ±ÁâáË©≥ÊÉÖÁ≠â): 1 ÂñÆ‰Ωç„ÄÇ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function setupAdminModalEventListeners(password) {
            const modal = document.getElementById('admin-ui-modal');
            if (!modal) return;

            modal.querySelector('#close-admin-modal-btn').addEventListener('click', () => {
                modal.classList.remove('visible');
                setTimeout(() => modal.remove(), 300);
            });

            modal.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.querySelector('.admin-tab-btn.active').classList.remove('active');
                    modal.querySelector('.admin-tab-content.active').classList.remove('active');
                    btn.classList.add('active');
                    modal.querySelector(`#tab-${btn.dataset.tab}`).classList.add('active');
                    if (btn.dataset.tab === 'admin_logs') {
                        loadAdminLogs(password);
                    }
                });
            });

            modal.querySelectorAll('.admin-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const { action, listType, channelId, inputId } = e.currentTarget.dataset;
                    let finalChannelId = channelId;
                    if (action === 'add') {
                        const input = document.getElementById(inputId);
                        finalChannelId = input.value.trim();
                        if (!finalChannelId) { alert('È†ªÈÅì ID ‰∏çËÉΩÁÇ∫Á©∫ÔºÅ'); return; }
                    }

                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂ∞çÈ†ªÈÅì ${finalChannelId} Âü∑Ë°å„Äå${action}„ÄçÊìç‰ΩúÂóéÔºü`)) return;

                    await performAdminAction(action, finalChannelId, listType, password);
                });
            });

            modal.querySelectorAll('.admin-btn-refresh').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const lang = e.currentTarget.dataset.lang;
                    const langText = lang === 'cn' ? '‰∏≠Êñá' : 'Êó•Êñá';
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÁ´ãÂç≥Âº∑Âà∂Êõ¥Êñ∞${langText}Ë≥áÊñôÂóéÔºüÈÄôÂèØËÉΩÈúÄË¶ÅÂπæÂàÜÈêòÁöÑÊôÇÈñì„ÄÇ`)) return;

                    const originalText = btn.innerText;
                    btn.innerText = 'Êõ¥Êñ∞‰∏≠...';
                    btn.disabled = true;

                    try {
                        await fetchApi('youtube', {
                            params: { force_refresh: 'true', lang: lang, password: password }
                        });
                        alert(`${langText}Ë≥áÊñôÊõ¥Êñ∞Ë´ãÊ±ÇÂ∑≤ÁôºÈÄÅ‰∏¶ÂÆåÊàêÔºÅ`);
                    } catch (error) {
                        console.error(`Êõ¥Êñ∞Â§±Êïó:`, error);
                        alert(`Êõ¥Êñ∞Â§±Êïó: ${error.message}`);
                    } finally {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                });
            });

            // Trigger Live Check Button
            const triggerLiveBtn = modal.querySelector('.admin-btn-trigger-live');
            if (triggerLiveBtn) {
                triggerLiveBtn.addEventListener('click', async () => {
                    if (!confirm('Á¢∫ÂÆöË¶ÅÁ´ãÂç≥Ëß∏ÁôºÁõ¥Êí≠ÁãÄÊÖãÊ™¢Êü•ÂóéÔºü')) return;
                    const originalText = triggerLiveBtn.innerHTML;
                    triggerLiveBtn.innerText = 'Ê™¢Êü•‰∏≠...';
                    triggerLiveBtn.disabled = true;
                    try {
                        await fetchApi('admin/manage', {
                            method: 'POST',
                            body: { action: 'trigger_live_check', password }
                        });
                        alert('Áõ¥Êí≠ÁãÄÊÖãÊ™¢Êü•Â∑≤Ëß∏ÁôºÔºåË´ãÁ®çÂæåÊü•ÁúãÈ¶ñÈ†Å„ÄÇ');
                    } catch (error) {
                        alert(`Ê™¢Êü•Â§±Êïó: ${error.message}`);
                    } finally {
                        triggerLiveBtn.innerHTML = originalText;
                        triggerLiveBtn.disabled = false;
                    }
                });
            }

            // ÂÖ¨ÂëäÂÑ≤Â≠òÊåâÈàï‰∫ã‰ª∂
            const saveAnnouncementBtn = modal.querySelector('#save-announcement-btn');
            if (saveAnnouncementBtn) {
                saveAnnouncementBtn.addEventListener('click', async () => {
                    const content = modal.querySelector('#announcement-content').value.trim();
                    const type = modal.querySelector('input[name="announcement-type"]:checked').value;
                    const active = modal.querySelector('#announcement-active').checked;

                    if (!content && active) {
                        alert('ÂïüÁî®ÂÖ¨ÂëäÊôÇÔºåÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫ÔºÅ');
                        return;
                    }

                    const originalText = saveAnnouncementBtn.innerText;
                    saveAnnouncementBtn.innerText = 'ÂÑ≤Â≠ò‰∏≠...';
                    saveAnnouncementBtn.disabled = true;

                    try {
                        await performAdminAction('update_announcement', null, null, password, { content, type, active });
                        alert('ÂÖ¨ÂëäË®≠ÂÆöÂ∑≤ÂÑ≤Â≠òÔºÅ');
                    } catch (error) {
                        alert(`ÂÑ≤Â≠òÂ§±Êïó: ${error.message}`);
                    } finally {
                        saveAnnouncementBtn.innerText = originalText;
                        saveAnnouncementBtn.disabled = false;
                    }
                });
            }

            // ÂΩ±ÁâáÈªëÂêçÂñÆÈÇèËºØ
            const videoBlacklistTabBtn = modal.querySelector('.admin-tab-btn[data-tab="video_blacklist"]');
            if (videoBlacklistTabBtn) {
                const container = modal.querySelector('#video-blacklist-container');
                const addBtn = modal.querySelector('#btn-add-video-blacklist');
                const input = modal.querySelector('#add-video-blacklist-input');

                const loadVideoBlacklist = async () => {
                    container.innerHTML = '<p class="text-gray-500 text-center py-4">ËºâÂÖ•‰∏≠...</p>';
                    try {
                        const res = await fetchApi('admin/manage', {
                            method: 'POST',
                            body: { action: 'get_video_blacklist', password }
                        });
                        if (res.blacklist && res.blacklist.length > 0) {
                            container.innerHTML = res.blacklist.map(id => `
                                <div class="flex items-center justify-between bg-gray-700 p-2 rounded">
                                    <div class="flex items-center gap-2 overflow-hidden">
                                        <span class="text-gray-300 font-mono text-sm truncate">${id}</span>
                                        <a href="https://www.youtube.com/watch?v=${id}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs">Open</a>
                                    </div>
                                    <button class="text-red-400 hover:text-red-300 text-sm font-semibold px-2 btn-remove-video-blacklist" data-id="${id}">ÁßªÈô§</button>
                                </div>
                            `).join('');

                            container.querySelectorAll('.btn-remove-video-blacklist').forEach(btn => {
                                btn.addEventListener('click', async (e) => {
                                    const videoId = e.currentTarget.dataset.id;
                                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂ∞áÂΩ±Áâá ${videoId} ÂæûÈªëÂêçÂñÆÁßªÈô§ÂóéÔºü`)) return;
                                    try {
                                        await fetchApi('admin/manage', {
                                            method: 'POST',
                                            body: { action: 'remove_video_blacklist', videoId, password }
                                        });
                                        loadVideoBlacklist();
                                    } catch (err) {
                                        alert(`ÁßªÈô§Â§±Êïó: ${err.message}`);
                                    }
                                });
                            });
                        } else {
                            container.innerHTML = '<p class="text-gray-500 text-center py-4">ÁõÆÂâçÊ≤íÊúâÈªëÂêçÂñÆÂΩ±Áâá„ÄÇ</p>';
                        }
                    } catch (error) {
                        container.innerHTML = `<p class="text-red-500 text-center py-4">ËºâÂÖ•Â§±Êïó: ${error.message}</p>`;
                    }
                };

                // Initial load if tab is active, or when tab is clicked
                if (videoBlacklistTabBtn.classList.contains('active')) loadVideoBlacklist();
                videoBlacklistTabBtn.addEventListener('click', loadVideoBlacklist);

                addBtn.addEventListener('click', async () => {
                    const videoId = input.value.trim();
                    if (!videoId) { alert('Ë´ãËº∏ÂÖ•ÂΩ±Áâá ID'); return; }
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂ∞áÂΩ±Áâá ${videoId} Âä†ÂÖ•ÈªëÂêçÂñÆÂóéÔºü\nÈÄôÂ∞áÊúÉÂæûË≥áÊñôÂ∫´‰∏≠ÁßªÈô§Ê≠§ÂΩ±Áâá„ÄÇ`)) return;

                    const originalText = addBtn.innerText;
                    addBtn.innerText = 'ËôïÁêÜ‰∏≠...';
                    addBtn.disabled = true;

                    try {
                        await fetchApi('admin/manage', {
                            method: 'POST',
                            body: { action: 'add_video_blacklist', videoId, password }
                        });
                        input.value = '';
                        alert('Â∑≤Âä†ÂÖ•ÈªëÂêçÂñÆ');
                        loadVideoBlacklist();
                    } catch (error) {
                        alert(`Âä†ÂÖ•Â§±Êïó: ${error.message}`);
                    } finally {
                        addBtn.innerText = originalText;
                        addBtn.disabled = false;
                    }
                });
            }

            // ÂõûÂ°´ÂäüËÉΩÈÇèËºØ
            const backfillTabBtn = modal.querySelector('.admin-tab-btn[data-tab="backfill"]');
            if (backfillTabBtn) {
                const keywordsContainer = modal.querySelector('#backfill-keywords-container');
                const cnKeywords = ["VSPO‰∏≠Êñá", "VSPO‰∏≠ÊñáÁ≤æËèØ", "VSPOÁ≤æËèØ", "VSPO‰∏≠ÊñáÂâ™ËºØ", "VSPOÂâ™ËºØ", "„Å∂„ÅÑ„Åô„ÅΩ„Å£ÔºÅË®±Ë´æÁï™Âè∑"];
                const jpKeywords = ["„Å∂„ÅÑ„Åô„ÅΩ Âàá„ÇäÊäú„Åç", "„Å∂„ÅÑ„Åô„ÅΩ„Å£ÔºÅË®±Ë´æÁï™Âè∑"];

                const updateKeywords = () => {
                    const lang = modal.querySelector('input[name="backfill-lang"]:checked').value;
                    const keywords = lang === 'cn' ? cnKeywords : jpKeywords;
                    keywordsContainer.innerHTML = keywords.map(k => `
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" value="${k}" checked class="text-indigo-500 focus:ring-indigo-500">
                            <span class="text-gray-300 text-sm">${k}</span>
                        </label>
                    `).join('');
                };

                modal.querySelectorAll('input[name="backfill-lang"]').forEach(radio => {
                    radio.addEventListener('change', updateKeywords);
                });
                updateKeywords(); // Initialize

                const startBackfillBtn = modal.querySelector('#start-backfill-btn');
                const logDiv = modal.querySelector('#backfill-log');

                startBackfillBtn.addEventListener('click', async () => {
                    const startDateStr = modal.querySelector('#backfill-start-date').value;
                    const endDateStr = modal.querySelector('#backfill-end-date').value;
                    const lang = modal.querySelector('input[name="backfill-lang"]:checked').value;
                    const selectedKeywords = Array.from(modal.querySelectorAll('#backfill-keywords-container input:checked')).map(cb => cb.value);

                    if (!startDateStr || !endDateStr) { alert('Ë´ãÈÅ∏ÊìáÈñãÂßãËàáÁµêÊùüÊó•Êúü'); return; }
                    if (selectedKeywords.length === 0) { alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÈóúÈçµÂ≠ó'); return; }

                    const startDate = new Date(startDateStr);
                    const endDate = new Date(endDateStr);
                    if (startDate > endDate) { alert('ÈñãÂßãÊó•Êúü‰∏çËÉΩÊôöÊñºÁµêÊùüÊó•Êúü'); return; }

                    if (!confirm(`Á¢∫ÂÆöË¶ÅÈñãÂßãÂõûÂ°´ÂóéÔºü\nÊó•Êúü: ${startDateStr} ~ ${endDateStr}\nË™ûË®Ä: ${lang}\nÈóúÈçµÂ≠ó: ${selectedKeywords.join(', ')}\n\nÈÄôÂ∞áÊúÉÊ∂àËÄóÂ§ßÈáè YouTube API QuotaÔºåË´ãÁ¢∫Ë™çÔºÅ`)) return;

                    startBackfillBtn.disabled = true;
                    startBackfillBtn.innerText = 'ÂõûÂ°´ÈÄ≤Ë°å‰∏≠...';
                    logDiv.classList.remove('hidden');
                    logDiv.innerHTML = '--- ‰ªªÂãôÈñãÂßã ---\n';

                    const log = (msg) => {
                        logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
                        logDiv.scrollTop = logDiv.scrollHeight;
                    };

                    let currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        const dateStr = currentDate.toISOString().split('T')[0];
                        log(`Ê≠£Âú®ËôïÁêÜ: ${dateStr}...`);

                        try {
                            const res = await fetchApi('admin/manage', {
                                method: 'POST',
                                body: { action: 'backfill', date: dateStr, lang, keywords: selectedKeywords, password }
                            });
                            log(`ÂÆåÊàê: ${dateStr} - Êñ∞Â¢û/Êõ¥Êñ∞ ${res.count} ÈÉ®ÂΩ±Áâá`);
                        } catch (err) {
                            log(`ÈåØË™§: ${dateStr} - ${err.message}`);
                        }

                        currentDate.setDate(currentDate.getDate() + 1);
                        // Á∞°ÂñÆÁöÑÂª∂ÈÅ≤‰ª•ÈÅøÂÖçÈÅéÊñºÂØÜÈõÜÁöÑË´ãÊ±Ç (ÈõñÁÑ∂ÊòØÂ∫èÂàóÂü∑Ë°å)
                        await new Promise(r => setTimeout(r, 1000));
                    }

                    log('--- ‰ªªÂãôÁµêÊùü ---');
                    startBackfillBtn.disabled = false;
                    startBackfillBtn.innerText = 'ÈñãÂßãÂõûÂ°´‰ªªÂãô';
                    alert('ÂõûÂ°´‰ªªÂãôÂ∑≤ÂÆåÊàêÔºåË´ãÊü•ÁúãÊó•Ë™åÁ¢∫Ë™çÁµêÊûú„ÄÇ');
                });




            }

            // ÁÆ°ÁêÜÊó•Ë™åÈÇèËºØ
            const adminLogsTabBtn = modal.querySelector('.admin-tab-btn[data-tab="admin_logs"]');
            if (adminLogsTabBtn) {
                // Initial load if tab is active, or when tab is clicked
                if (adminLogsTabBtn.classList.contains('active')) loadAdminLogs(password);
                adminLogsTabBtn.addEventListener('click', () => loadAdminLogs(password));
            }

            // API Status Tab Logic
            const apiStatusTabBtn = modal.querySelector('.admin-tab-btn[data-tab="api_status"]');
            if (apiStatusTabBtn) {
                // Initialize Date Picker once (last 7 days from today based on browser, but backend handles PT)
                const dateSelect = modal.querySelector('#quota-date-select');
                if (dateSelect) {
                    const today = new Date();
                    // Generate last 8 days to match retention
                    for (let i = 0; i < 8; i++) {
                        const d = new Date(today);
                        d.setDate(d.getDate() - i);
                        const dateStr = d.toISOString().split('T')[0];
                        const opt = document.createElement('option');
                        opt.value = dateStr;
                        opt.text = (i === 0 ? `‰ªäÊó• (${dateStr})` : dateStr);
                        dateSelect.appendChild(opt);
                    }
                    dateSelect.addEventListener('change', () => loadApiStatus(password, dateSelect.value));
                }

                if (apiStatusTabBtn.classList.contains('active')) loadApiStatus(password);
                apiStatusTabBtn.addEventListener('click', () => loadApiStatus(password));
            }
        }



        async function loadApiStatus(password, dateOverride = null) {
            const container = document.getElementById('tab-api_status');
            const loadingDiv = document.getElementById('api-status-loading');
            const contentDiv = document.getElementById('api-status-content');
            const errorDiv = document.getElementById('api-status-error');

            if (!container) return;

            loadingDiv.classList.remove('hidden');
            contentDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            errorDiv.innerText = '';

            const dateSelect = document.getElementById('quota-date-select');
            const targetDate = dateOverride || (dateSelect ? dateSelect.value : null);

            try {
                // Fetch Data
                const params = { password };
                if (targetDate) params.date = targetDate;

                // Reuse fetchApi, accessing local backend path
                // Note: /api/quota is public in backend code, but we can pass password if needed later.
                // It is currently public, so password isn't strictly checked by backend for just reading, 
                // but good to keep pattern. 
                // The fetchApi wrapper appends params to URL.
                const res = await fetchApi('quota', { params });

                if (!res.success) throw new Error(res.error || 'ÁÑ°Ê≥ïÁç≤ÂèñÈÖçÈ°çÊï∏Êìö');

                // Render Overview
                const totalUsed = res.totalUsed || 0;
                document.getElementById('quota-total-used').innerText = totalUsed.toLocaleString();
                document.getElementById('quota-total-used').className = `text-3xl font-bold ${totalUsed > 100000 ? 'text-red-500' : totalUsed > 80000 ? 'text-yellow-400' : 'text-white'}`;

                const percent = Math.min(100, (totalUsed / 130000) * 100);
                document.getElementById('quota-progress-bar').style.width = `${percent}%`;
                document.getElementById('quota-progress-bar').className = `h-1.5 rounded-full ${percent > 90 ? 'bg-red-500' : percent > 70 ? 'bg-yellow-500' : 'bg-blue-500'}`;

                document.getElementById('quota-active-key').innerText = (res.currentKeyIndex !== undefined) ? `Key ${res.currentKeyIndex}` : 'N/A';
                document.getElementById('quota-date-display').innerText = res.date;

                // Calculate and display local time range
                if (res.date) {
                    try {
                        // Assuming PT is UTC-8 (PST Standard Time) for simplicity as per current usage
                        // "2025-12-27" PT starts at 2025-12-27 00:00:00 UTC-08:00
                        // Which is 2025-12-27 08:00:00 UTC

                        const ptDateParts = res.date.split('-');
                        const year = parseInt(ptDateParts[0]);
                        const month = parseInt(ptDateParts[1]) - 1;
                        const day = parseInt(ptDateParts[2]);

                        // Construct UTC date assuming PT midnight is +8 hours in UTC
                        const utcStart = new Date(Date.UTC(year, month, day, 8, 0, 0));
                        const utcEnd = new Date(Date.UTC(year, month, day + 1, 8, 0, 0));

                        const fmt = new Intl.DateTimeFormat(undefined, {
                            month: 'numeric', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: false
                        });

                        const localStart = fmt.format(utcStart);
                        const localEnd = fmt.format(utcEnd);

                        document.getElementById('quota-local-date-display').innerText = `Êú¨Âú∞: ${localStart} - ${localEnd}`;
                    } catch (err) {
                        console.warn('Date conversion error:', err);
                        document.getElementById('quota-local-date-display').innerText = 'Êú¨Âú∞: ËΩâÊèõÂ§±Êïó';
                    }
                }

                // Render Grid & Table
                const gridContainer = document.getElementById('quota-keys-grid');
                const tbody = document.getElementById('quota-breakdown-body');
                gridContainer.innerHTML = '';
                tbody.innerHTML = '';

                const activeKeyIdx = res.currentKeyIndex || 0;

                // Prepare total usage for each key
                const breakdown = res.breakdown || {};

                for (let i = 0; i < 13; i++) {
                    const keyData = breakdown[`key_${i}`] || { total: 0, details: {} };
                    const keyTotal = keyData.total || 0;
                    const isCurrent = (i === activeKeyIdx && dateOverride === null);

                    // Grid Item
                    const gridItem = document.createElement('div');
                    // Color Logic
                    let bgClass = 'bg-gray-700/80';
                    let textClass = 'text-green-400';

                    if (keyTotal > 9800) { bgClass = 'bg-red-900/50 border-red-500/50'; textClass = 'text-red-300'; }
                    else if (keyTotal > 8000) { bgClass = 'bg-yellow-900/50 border-yellow-500/50'; textClass = 'text-yellow-300'; }
                    else if (keyTotal > 0) {
                        if (isCurrent) { bgClass = 'bg-green-900/30 border-green-500'; textClass = 'text-green-300'; }
                    } else {
                        textClass = 'text-gray-500'; // Idle
                    }

                    // Current Key Border override
                    const borderClass = (i === activeKeyIdx) ? 'border-2 border-white shadow-[0_0_10px_rgba(255,255,255,0.3)]' : 'border border-transparent hover:border-gray-500';

                    gridItem.className = `${bgClass} ${borderClass} p-2 rounded flex flex-col items-center justify-center transition-all cursor-default h-16`;
                    gridItem.innerHTML = `
                        <span class="text-[10px] text-gray-400 uppercase">Key ${i}</span>
                        <span class="font-mono font-bold ${textClass} text-sm">${keyTotal.toLocaleString()}</span>
                     `;
                    gridContainer.appendChild(gridItem);

                    // Table Row
                    if (keyTotal > 0) {
                        const details = keyData.details || {};
                        const searchCount = details['search'] || 0;
                        const videosCount = (details['videos'] || 0) + (details['playlistItems'] || 0); // rough grouping
                        const othersCount = keyTotal - searchCount - videosCount; // remainder

                        const tr = document.createElement('tr');
                        tr.className = (i === activeKeyIdx) ? 'bg-indigo-900/20' : '';
                        tr.innerHTML = `
                            <td class="px-3 py-2 text-center font-mono text-gray-300 ${i === activeKeyIdx ? 'font-bold text-white' : ''}">${i}</td>
                            <td class="px-3 py-2 text-right font-mono text-white">${keyTotal.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right font-mono text-indigo-300">${((keyTotal / 10000) * 100).toFixed(1)}%</td>
                            <td class="px-3 py-2 text-right font-mono text-gray-400">${searchCount.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right font-mono text-gray-400">${videosCount.toLocaleString()}</td>
                            <td class="px-3 py-2 text-right font-mono text-gray-500">${othersCount.toLocaleString()}</td>
                         `;
                        tbody.appendChild(tr);
                    }
                }

                if (tbody.children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500 italic">No usage data for this date.</td></tr>';
                }

                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');

            } catch (e) {
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                errorDiv.innerText = `ËºâÂÖ•Êï∏ÊìöÈåØË™§: ${e.message}`;
            }
        }

        async function loadAdminLogs(password) {
            const tbody = document.getElementById('admin-logs-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center">Ê≠£Âú®ËºâÂÖ•Êó•Ë™å...</td></tr>';
            try {
                const data = await fetchApi('admin/manage', {
                    method: 'POST',
                    body: { action: 'get_admin_logs', password }
                });
                if (data.logs && data.logs.length > 0) {
                    tbody.innerHTML = data.logs.map(log => `
                        <tr>
                            <td class="px-4 py-2 whitespace-nowrap">${new Date(log.timestamp).toLocaleString()}</td>
                            <td class="px-4 py-2 text-indigo-300 font-mono">${log.action}</td>
                            <td class="px-4 py-2 text-xs font-mono text-gray-400 break-all">${typeof log.details === 'object' ? JSON.stringify(log.details) : log.details}</td>
                        </tr>
                     `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center">ÁõÆÂâçÊ≤íÊúâÊó•Ë™åÁ¥ÄÈåÑ„ÄÇ</td></tr>';
                }
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="3" class="px-4 py-4 text-center text-red-400">ÁÑ°Ê≥ïËºâÂÖ•Êó•Ë™å: ${e.message}</td></tr>`;
            }
        }

        async function performAdminAction(action, channelId, listType, password, extraData = {}) {
            try {
                // 1. Âú®Êìç‰ΩúÂâçÂÖàÁç≤ÂèñÁï∂ÂâçÊ¥ªË∫çÁöÑ Tab
                const activeTabBtn = document.querySelector('.admin-tab-btn.active');
                const currentTab = activeTabBtn ? activeTabBtn.dataset.tab : 'pending_jp';

                await fetchApi('admin/manage', {
                    method: 'POST',
                    body: { action, channelId, listType, password, ...extraData }
                });

                // Â¶ÇÊûúÊòØÂÖ¨ÂëäÊõ¥Êñ∞Ôºå‰∏çÈúÄË¶ÅÈáçÊñ∞ËºâÂÖ•ÂàóË°®
                if (action !== 'update_announcement') {
                    // 2. ÈáçÊñ∞ËºâÂÖ• UIÔºå‰∏¶ÂÇ≥ÂÖ• currentTab ‰ª•‰øùÊåÅÂàÜÈ†ÅÁãÄÊÖã
                    await showAdminUI(password, currentTab);
                }
            } catch (error) {
                console.error(`ÁÆ°ÁêÜÊìç‰ΩúÂ§±Êïó (${action}):`, error);
                alert(`Êìç‰ΩúÂ§±Êïó: ${error.message}`);
                throw error; // ÈáçÊñ∞ÊããÂá∫ÈåØË™§‰ª•‰æø‰∏äÂ±§ËôïÁêÜ
            }
        }
        // --- END: Admin UI Êñ∞Â¢ûÂáΩÂºè ---

        async function fetchApi(endpoint, options = {}) {
            const url = new URL(`${API_BASE_URL}/${endpoint}`);
            const defaultParams = { version: CURRENT_APP_VERSION };
            const allParams = { ...defaultParams, ...options.params };
            Object.keys(allParams).forEach(key => url.searchParams.append(key, allParams[key]));

            // ‰øÆÊîπÔºöËÆì POST Ë´ãÊ±Ç‰πüËÉΩÊîúÂ∏∂ password
            const body = options.body ? JSON.stringify(options.body) : null;
            const headers = { 'Content-Type': 'application/json', ...options.headers };

            // Êñ∞Â¢û timeout ÈÇèËºØ (È†êË®≠ 30 ÁßíÔºåÈÅ©Êáâ Vercel Cold Start)
            const controller = new AbortController();
            const timeout = options.timeout || 30000;
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: headers,
                    body: body,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json().catch(() => ({ error: `Ë´ãÊ±ÇÂ§±ÊïóÔºåÁãÄÊÖãÁ¢º: ${response.status}` }));
                if (!response.ok) {
                    throw new Error(data.message || data.error || `Request failed with status ${response.status}`);
                }
                return data;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`Ë´ãÊ±ÇÈÄæÊôÇ (${timeout / 1000}Áßí)Ôºå‰º∫ÊúçÂô®ÂèØËÉΩÊ≠£Âú®ÂñöÈÜí‰∏≠ÔºåË´ãÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢„ÄÇ`);
                }
                throw error;
            }
        }

        async function performUpdateCheck(isManual = false) {
            if (isManual) { showUpdateModal('Ê™¢Êü•Êõ¥Êñ∞‰∏≠...', 'Ê≠£Âú®Âæû GitHub Áç≤ÂèñÊúÄÊñ∞ÁâàÊú¨Ë≥áË®äÔºåË´ãÁ®çÂÄô...'); }
            try {
                const response = await fetch('https://api.github.com/repos/renachiouo/vspo_clip_collector/commits?per_page=1');
                if (!response.ok) throw new Error(`GitHub API Ë´ãÊ±ÇÂ§±Êïó (${response.status})`);
                const data = await response.json();
                const latestCommitMessage = data[0]?.commit?.message || '';
                const versionMatch = latestCommitMessage.match(/V(\d+\.\d+(\.\d+)?)/);
                const latestVersion = versionMatch ? `V${versionMatch[1]}` : null;
                if (!latestVersion) throw new Error('ÁÑ°Ê≥ïÂæûÊúÄÊñ∞ÁöÑ commit ‰∏≠Ëß£ÊûêÁâàÊú¨Ëôü„ÄÇ');
                const isNewer = parseFloat(latestVersion.slice(1)) > parseFloat(CURRENT_APP_VERSION.slice(1));
                if (isNewer) {
                    showUpdateModal('ÁôºÁèæÊñ∞ÁâàÊú¨ÔºÅ', `ÁõÆÂâçÊúÄÊñ∞ÁâàÊú¨ÁÇ∫ <strong>${latestVersion}</strong>ÔºåÊÇ®‰ΩøÁî®ÁöÑÁâàÊú¨ÁÇ∫ ${CURRENT_APP_VERSION}„ÄÇ<br><br>Âª∫Ë≠∞Êõ¥Êñ∞‰ª•Áç≤ÂèñÊúÄÊñ∞ÁöÑÂäüËÉΩËàá‰øÆÊ≠£„ÄÇ`, true);
                } else if (isManual) {
                    showUpdateModal('Ê™¢Êü•ÂÆåÊàê', `ÊÇ®ÁõÆÂâç‰ΩøÁî®ÁöÑÂ∑≤ÊòØÊúÄÊñ∞ÁâàÊú¨ (${CURRENT_APP_VERSION})„ÄÇ`);
                }
            } catch (error) {
                console.error('Ê™¢Êü•Êõ¥Êñ∞ÊôÇÁôºÁîüÈåØË™§:', error);
                if (isManual) { showUpdateModal('Ê™¢Êü•Â§±Êïó', `ÁÑ°Ê≥ïÂÆåÊàêÊõ¥Êñ∞Ê™¢Êü•ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ<br>ÈåØË™§Ë®äÊÅØ: ${error.message}`); }
            }
        }

        function createErrorDisplay(error) {
            let errorMessage = error;
            let errorHint = "Ë´ãÊ™¢Êü•‰ª£ÁêÜ‰º∫ÊúçÂô®ÊòØÂê¶Ê≠£Â∏∏ÈÅã‰ΩúÔºåÊàñÁ®çÂæåÂÜçË©¶„ÄÇ";
            if (error && error.toLowerCase().includes('quota')) {
                errorMessage = "API ÊØèÊó•ÈÖçÈ°çÂ∑≤Áî®Áõ°";
                errorHint = "Ë´ãÁ≠âÂæÖÂè∞ÁÅ£ÊôÇÈñì‰∏ãÂçà 4 ÈªûÂæåÔºåÈÖçÈ°çÂ∞áÊúÉËá™ÂãïÈáçÁΩÆ„ÄÇ";
            }
            return `<div class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-center flex flex-col items-center gap-2"><div class="flex items-center justify-center gap-2"><strong class="font-bold">ÁôºÁîüÈåØË™§ÔºÅ</strong><span class="block sm:inline">${errorMessage}</span></div><p class="text-sm mt-1">${errorHint}</p><button onclick="window.location.reload()" class="mt-2 px-4 py-2 bg-red-700 hover:bg-red-600 text-white rounded-md text-sm transition-colors duration-200 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢</button></div>`;
        }


        const formatDuration = (duration) => {
            if (!duration) return '';
            const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
            if (!match) return '';
            const hours = (match[1] || '').replace('H', '');
            const minutes = (match[2] || '').replace('M', '') || '0';
            const seconds = (match[3] || '').replace('S', '') || '0';

            const paddedSec = seconds.padStart(2, '0');
            if (hours) {
                const paddedMin = minutes.padStart(2, '0');
                return `${hours}:${paddedMin}:${paddedSec}`;
            }
            return `${minutes}:${paddedSec}`;
        };
        const parseDuration = formatDuration; // Alias for modal usage

        function createVideoCard(video, showChannel = true) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}Ëê¨` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'Âπ¥': 31536000, 'ÂÄãÊúà': 2592000, 'Â§©': 86400, 'Â∞èÊôÇ': 3600, 'ÂàÜÈêò': 60 };
                for (let unit in intervals) { if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}Ââç`; }
                return "ÂâõÂâõ";
            };

            const card = document.createElement('div');
            card.className = "video-card group bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-400/30 transition-shadow duration-300 flex flex-col";

            const channelLink = showChannel ? `<a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-2"><img src="${video.channelAvatarUrl}" class="w-6 h-6 rounded-full bg-gray-700"><p class="text-sm text-gray-400 hover:text-white transition-colors truncate">${video.channelTitle}</p></a>` : '';

            let relatedClipsButton = '';
            if (video.originalStreamInfo) {
                relatedClipsButton = `<button class="related-clips-btn p-2 rounded-full bg-teal-500/20 hover:bg-teal-500/40 transition-colors" title="Êü•ÁúãÂêåÂ†¥Áõ¥Êí≠ÊâÄÊúâÂâ™ËºØ"><span class="text-lg">üé¨</span></button>`;
            }

            const videoUrl = (video.videoType === 'short') ? `https://www.youtube.com/shorts/${video.id}` : `https://www.youtube.com/watch?v=${video.id}`;

            card.innerHTML = `
            <a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="video-thumbnail-container block w-full bg-gray-700 overflow-hidden relative">
                <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';">
            </a>
            ${video.duration ? `
            <div class="duration-line-container">
                <div class="duration-line-accent"></div>
                <span class="duration-text-c">${formatDuration(video.duration)}</span>
            </div>` : ''}
            <div class="p-4 flex flex-col flex-grow">
                <a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="flex-grow">
                    <h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3>
                </a>
                ${channelLink}
                <div class="flex justify-between items-center text-sm text-gray-400 mt-3 pt-3 border-t border-gray-700">
                    <span class="truncate">${formatNumber(video.viewCount)} Ê¨°ËßÄÁúã</span>
                    <div class="flex items-center gap-x-2">
                        ${relatedClipsButton}
                        <span class="flex-shrink-0" title="${new Date(video.publishedAt).toLocaleString('zh-TW')}">${timeAgo(video.publishedAt)}</span>
                    </div>
                </div>
            </div>`;

            if (video.originalStreamInfo) {
                card.querySelector('.related-clips-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showRelatedClipsModal(video.id);
                });
            }
            return card;
        }

        function createVideoListItem(video) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}Ëê¨` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'Âπ¥': 31536000, 'ÂÄãÊúà': 2592000, 'Â§©': 86400, 'Â∞èÊôÇ': 3600, 'ÂàÜÈêò': 60 };
                for (let unit in intervals) { if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}Ââç`; }
                return "ÂâõÂâõ";
            };
            const item = document.createElement('div');
            item.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors duration-200";

            let relatedClipsButton = '';
            if (video.originalStreamInfo) {
                relatedClipsButton = `<button class="related-clips-btn ml-auto p-2 rounded-full bg-teal-500/20 hover:bg-teal-500/40 transition-colors" title="Êü•ÁúãÂêåÂ†¥Áõ¥Êí≠ÊâÄÊúâÂâ™ËºØ"><span class="text-lg">üé¨</span></button>`;
            }

            const videoUrl = (video.videoType === 'short') ? `https://www.youtube.com/shorts/${video.id}` : `https://www.youtube.com/watch?v=${video.id}`;

            item.innerHTML = `
            <a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 w-32 aspect-video bg-gray-700 rounded-md overflow-hidden">
                <img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/128x72/1a202c/e53e3e?text=Error';">
            </a>
            <div class="flex-1 min-w-0">
                <a href="${videoUrl}" target="_blank" rel="noopener noreferrer">
                    <h3 class="font-semibold text-gray-100 truncate hover:text-cyan-400">${video.title}</h3>
                </a>
                <a href="https://www.youtube.com/channel/${video.channelId}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 mt-1">
                    <img src="${video.channelAvatarUrl}" class="w-5 h-5 rounded-full bg-gray-700">
                    <p class="text-sm text-gray-400 hover:text-white truncate">${video.channelTitle}</p>
                </a>
                <div class="flex justify-between items-center text-xs text-gray-500 mt-2">
                    <span>${formatNumber(video.viewCount)} Ê¨°ËßÄÁúã</span>
                    <span title="${new Date(video.publishedAt).toLocaleString('zh-TW')}">${timeAgo(video.publishedAt)}</span>
                </div>
            </div>
            ${relatedClipsButton}`;

            if (video.originalStreamInfo) {
                item.querySelector('.related-clips-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showRelatedClipsModal(video.id);
                });
            }
            return item;
        }

        function createChannelGridCard(channel) {
            const formatNumber = (num) => (typeof num !== 'number') ? 'N/A' : num >= 10000 ? `${(num / 10000).toFixed(1)}Ëê¨` : num.toLocaleString();
            const timeAgo = (dateStr) => {
                const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000);
                const intervals = { 'Âπ¥': 31536000, 'ÂÄãÊúà': 2592000, 'Â§©': 86400, 'Â∞èÊôÇ': 3600, 'ÂàÜÈêò': 60 };
                for (let unit in intervals) { if (seconds / intervals[unit] > 1) return `${Math.floor(seconds / intervals[unit])} ${unit}Ââç`; }
                return "ÂâõÂâõ";
            };
            const card = document.createElement('div');
            card.className = "group rounded-lg overflow-hidden shadow-lg hover:shadow-purple-400/30 transition-shadow duration-300 relative";
            card.style.backgroundImage = `url('${channel.avatarUrl}')`;
            card.style.backgroundSize = 'cover';
            card.style.backgroundPosition = 'center';
            const video = channel.latestVideo;

            let relatedClipsButton = '';
            if (video.originalStreamInfo) {
                relatedClipsButton = `<button class="related-clips-btn p-2 rounded-full bg-teal-500/20 hover:bg-teal-500/40 transition-colors" title="Êü•ÁúãÂêåÂ†¥Áõ¥Êí≠ÊâÄÊúâÂâ™ËºØ"><span class="text-lg">üé¨</span></button>`;
            }

            const videoUrl = (video.videoType === 'short') ? `https://www.youtube.com/shorts/${video.id}` : `https://www.youtube.com/watch?v=${video.id}`;

            card.innerHTML = `<div class="absolute inset-0 bg-gray-900/70 backdrop-blur"></div><div class="relative z-10 flex flex-col h-full"><div class="p-4"><div class="flex items-center space-x-3"><a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0"><img src="${channel.avatarUrl}" alt="${channel.name}" class="w-12 h-12 rounded-full bg-gray-700 border-2 border-white/20"></a><div class="flex-1 min-w-0"><a href="https://www.youtube.com/channel/${channel.id}" target="_blank" rel="noopener noreferrer"><p class="text-lg font-bold text-purple-300 truncate">${channel.name}</p></a><p class="text-sm text-gray-300">${formatNumber(channel.subscriberCount)} ‰ΩçË®ÇÈñ±ËÄÖ</p></div><button class="channel-filter-btn flex-shrink-0 p-2 rounded-full bg-white/10 hover:bg-white/20 transition-colors" data-channel-id="${channel.id}" data-channel-name="${channel.name}" title="ÁØ©ÈÅ∏Ê≠§È†ªÈÅì"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-purple-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 12.414V17a1 1 0 01-1.447.894l-3-2A1 1 0 017 15V12.414L3.293 6.707A1 1 0 013 6V3z" clip-rule="evenodd" /></svg></button></div></div><div class="px-4 text-sm text-gray-400">ÊúÄÊñ∞ÂΩ±Áâá:</div><a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="block w-full aspect-video bg-gray-700/50 overflow-hidden mt-2 relative"><img src="${video.thumbnail}" alt="${video.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/480x360/1a202c/e53e3e?text=Image+Error';"></a>${video.duration ? `<div class="duration-line-container"><div class="duration-line-accent"></div><span class="duration-text-c">${formatDuration(video.duration)}</span></div>` : ''}<div class="p-4 flex flex-col flex-grow mt-auto"><a href="${videoUrl}" target="_blank" rel="noopener noreferrer" class="flex-grow"><h3 class="font-bold text-lg text-gray-100 leading-tight hover:text-cyan-400 transition-colors">${video.title}</h3></a><div class="flex justify-between items-center text-sm text-gray-300 mt-3 pt-3 border-t border-gray-500/50"><span>${formatNumber(video.viewCount)} Ê¨°ËßÄÁúã</span><div class="flex items-center gap-x-2">${relatedClipsButton}<span title="${new Date(video.publishedAt).toLocaleString('zh-TW')}">${timeAgo(video.publishedAt)}</span></div></div></div></div>`;


            if (video.originalStreamInfo) {
                card.querySelector('.related-clips-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showRelatedClipsModal(video.id);
                });
            }
            return card;
        }

        function isColorLight(hexColor) {
            if (!hexColor) return false;
            const color = (hexColor.charAt(0) === '#') ? hexColor.substring(1, 7) : hexColor;
            if (color.length < 6) return false;
            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            return (r * 0.299 + g * 0.587 + b * 0.114) > 186;
        }

        function createMemberFilterListHTML(jpMembers, otherGroups, activeFilter) {
            const listContainer = document.createElement('div');
            listContainer.className = 'flex flex-row space-x-2 md:flex-col md:space-y-2 md:space-x-0 overflow-x-auto md:overflow-y-auto no-scrollbar pb-2 md:pb-0';
            listContainer.id = 'member-filter-list-container';
            const allBtn = document.createElement('button');
            allBtn.className = `filter-btn flex-shrink-0 ${activeFilter === 'all' ? 'active' : ''}`;
            allBtn.dataset.filter = 'all';
            allBtn.textContent = 'È°ØÁ§∫ÂÖ®ÈÉ®';
            listContainer.appendChild(allBtn);
            const createMemberButton = (member) => {
                const btn = document.createElement('button');
                const isActive = activeFilter === member.filter_keyword;
                btn.className = `filter-btn flex-shrink-0 ${isActive ? 'active' : ''}`;
                btn.dataset.filter = member.filter_keyword;
                btn.style.backgroundColor = member.color;
                if (member.forceWhiteText) { btn.style.color = '#FFFFFF'; } else { btn.style.color = isColorLight(member.color) ? '#1f2937' : '#f9fafb'; }
                btn.textContent = member.name_jp;
                return btn;
            };
            jpMembers.forEach(member => listContainer.appendChild(createMemberButton(member)));
            for (const groupName in otherGroups) {
                const divider = document.createElement('div');
                divider.className = 'text-xs text-gray-500 pt-2 pb-1 pl-2 md:pt-3 md:pb-1 whitespace-nowrap';
                divider.textContent = groupName;
                listContainer.appendChild(divider);
                otherGroups[groupName].forEach(member => listContainer.appendChild(createMemberButton(member)));
            }

            // Restore scroll position
            if (state.memberFilterScrollLeft > 0 || state.memberFilterScrollTop > 0) {
                setTimeout(() => {
                    listContainer.scrollLeft = state.memberFilterScrollLeft;
                    listContainer.scrollTop = state.memberFilterScrollTop;
                }, 0);
            }

            // Capture scroll for persistence
            listContainer.onscroll = () => {
                state.memberFilterScrollLeft = listContainer.scrollLeft;
                state.memberFilterScrollTop = listContainer.scrollTop;
            };

            return listContainer;
        }

        function createSkeleton(type) {
            const skeleton = document.createElement('div');
            if (type === 'card') {
                skeleton.className = "bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col animate-pulse";
                skeleton.innerHTML = `<div class="w-full aspect-video bg-gray-700"></div><div class="p-4"><div class="h-4 bg-gray-700 rounded w-3/4 mb-4"></div><div class="h-4 bg-gray-700 rounded w-1/2"></div></div>`;
            } else if (type === 'list') {
                skeleton.className = "flex items-center space-x-4 p-3 bg-gray-800 rounded-lg animate-pulse";
                skeleton.innerHTML = `<div class="w-32 h-[72px] bg-gray-700 rounded-md"></div><div class="flex-1 space-y-2"><div class="h-4 bg-gray-700 rounded w-5/6"></div><div class="h-4 bg-gray-700 rounded w-1/3"></div><div class="h-3 bg-gray-700 rounded w-1/2"></div></div>`;
            }
            return skeleton;
        }

        function createPaginationControls(totalPages, currentPage) {
            const container = document.createElement('div');
            container.className = 'flex justify-center items-center space-x-1 md:space-x-2 mt-8';
            const createBtn = (text, page, isDisabled = false, isActive = false) => {
                const btn = document.createElement('button');
                btn.className = `pagination-btn ${isActive ? 'active' : ''}`;
                btn.textContent = text;
                btn.dataset.page = page;
                if (isDisabled) btn.disabled = true;
                return btn;
            };
            const createEllipsis = () => { const span = document.createElement('span'); span.className = 'pagination-ellipsis'; span.textContent = '...'; return span; };
            container.appendChild(createBtn('‚Äπ', currentPage - 1, currentPage === 1));
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) { container.appendChild(createBtn(i, i, false, i === currentPage)); }
            } else {
                const pages = new Set([1, totalPages, currentPage, currentPage - 1, currentPage + 1]);
                const sortedPages = Array.from(pages).filter(p => p > 0 && p <= totalPages).sort((a, b) => a - b);
                let lastPage = 0;
                for (const page of sortedPages) {
                    if (lastPage !== 0 && page - lastPage > 1) { container.appendChild(createEllipsis()); }
                    container.appendChild(createBtn(page, page, false, page === currentPage));
                    lastPage = page;
                }
            }
            container.appendChild(createBtn('‚Ä∫', currentPage + 1, currentPage === totalPages));
            return container;
        }

        /* --- NEW: Member & Modal Logic --- */
        async function fetchMembers() {
            if (state.memberList.length > 0) return; // Cache check
            try {
                const res = await fetchApi('members');
                if (res.success) {
                    state.memberList = res.members;
                }
            } catch (e) {
                console.error("ÁÑ°Ê≥ïËºâÂÖ•ÊàêÂì°ÂàóË°®", e);
            }
        }

        async function openStreamModal(streamId) {
            // 1. Create Modal if not exists
            let modal = document.getElementById('stream-detail-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'stream-detail-modal';
                modal.className = 'stream-modal-overlay';
                modal.onclick = (e) => { if (e.target === modal) closeStreamModal(); };
                modal.innerHTML = `
                    <div class="stream-modal-content">
                        <div class="modal-header">
                            <button class="modal-close-btn" onclick="closeStreamModal()">‚úï</button>
                            <div id="modal-stream-info" class="flex gap-4">
                                <!-- Stream Info Injected Here -->
                            </div>
                        </div>
                        <div class="modal-body">
                            <!-- Tabs -->
                            <div class="flex gap-4 border-b border-gray-700 mb-4 pb-2">
                                <button onclick="switchModalTab('cn')" id="tab-cn" class="text-cyan-400 font-bold border-b-2 border-cyan-400 pb-1">‰∏≠ÊñáÁ≤æËèØ</button>
                                <button onclick="switchModalTab('jp')" id="tab-jp" class="text-gray-400 hover:text-gray-200 pb-1 transition-colors">Êó•ÊñáÁ≤æËèØ</button>
                            </div>
                            <div id="modal-clip-list" class="clip-grid">
                                <!-- Clips Injected Here -->
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // 2. Show Modal & Loading
            modal.style.display = 'flex';
            document.getElementById('modal-clip-list').innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">ËºâÂÖ•‰∏≠...</div>';

            // 3. Fetch Data
            try {
                const res = await fetchApi('stream-details', { params: { id: streamId } });
                if (res.success) {
                    console.log("[DEBUG] openStreamModal clips:", res.clips);
                    renderModalContent(res.stream, res.clips);
                } else {
                    document.getElementById('modal-clip-list').innerHTML = '<div class="col-span-full text-center py-10 text-red-400">ÁÑ°Ê≥ïËÆÄÂèñÁõ¥Êí≠Ë≥áË®ä</div>';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('modal-clip-list').innerHTML = '<div class="col-span-full text-center py-10 text-red-400">ÁôºÁîüÈåØË™§</div>';
            }
        }

        function closeStreamModal() {
            const modal = document.getElementById('stream-detail-modal');
            if (modal) modal.style.display = 'none';
        }
        // Brace removed
        window.closeStreamModal = closeStreamModal; // Expose global
        window.openStreamModal = openStreamModal; // Expose global

        let currentModalClips = [];
        function renderModalContent(stream, clips) {
            currentModalClips = clips;
            // console.log("Processed Modal Clips:", currentModalClips);

            // Render Header
            const headerHtml = `
                <img src="${stream.thumbnail}" class="w-32 h-auto rounded-lg shadow-lg aspect-video object-cover bg-gray-800">
                <div class="flex-1 min-w-0">
                    <div class="text-xs text-cyan-400 mb-1">${new Date(stream.startTime).toLocaleString('zh-TW')}</div>
                    <h3 class="text-xl font-bold text-white mb-2 leading-tight">${stream.title}</h3>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-300">üì∫ ${stream.channelTitle}</span>
                        <span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full">ÂÖ± ${clips.length} ÈÉ®ÂΩ±Áâá</span>
                    </div>
                        ${stream.status === 'live' ? '<span class="px-2 py-0.5 bg-red-600 text-white text-xs rounded">LIVE</span>' : ''}
                    </div>
                </div>
            `;
            document.getElementById('modal-stream-info').innerHTML = headerHtml;

            // Default Tab: CN
            switchModalTab('cn');
        }

        function switchModalTab(lang) {
            // Update Tab Styles
            const tabCn = document.getElementById('tab-cn');
            const tabJp = document.getElementById('tab-jp');
            if (lang === 'cn') {
                tabCn.className = "text-cyan-400 font-bold border-b-2 border-cyan-400 pb-1";
                tabJp.className = "text-gray-400 hover:text-gray-200 pb-1 transition-colors";
            } else {
                tabJp.className = "text-cyan-400 font-bold border-b-2 border-cyan-400 pb-1";
                tabCn.className = "text-gray-400 hover:text-gray-200 pb-1 transition-colors";
            }

            // Filter Clips
            const filteredClips = currentModalClips.filter(c => c.source === lang);
            const listContainer = document.getElementById('modal-clip-list');

            if (filteredClips.length === 0) {
                listContainer.innerHTML = `<div class="col-span-full text-center py-12 text-gray-500 flex flex-col items-center">
                    <div class="text-4xl mb-2">üéûÔ∏è</div>
                    <div>Êö´ÁÑ°${lang === 'cn' ? '‰∏≠Êñá' : 'Êó•Êñá'}Á≤æËèØ</div>
                </div>`;
                return;
            }

            // Render Grid
            listContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4";
            listContainer.innerHTML = ''; // Clear

            filteredClips.forEach(clip => {
                // Map API field names to createVideoCard format
                const adaptedClip = {
                    ...clip,
                    channelTitle: clip.channelTitle || clip.channelName || 'Êú™Áü•È†ªÈÅì',
                    channelAvatarUrl: clip.channelAvatarUrl || clip.avatarUrl || '',
                    channelId: clip.channelId || '',
                    viewCount: typeof clip.viewCount === 'number' ? clip.viewCount : 0
                };
                const card = createVideoCard(adaptedClip, true);
                listContainer.appendChild(card);
            });
        }
        window.switchModalTab = switchModalTab; // Expose global
        async function loadStreams(page = 1) {
            state.isLoadingStreams = true;
            state.streamPagination.page = page;
            render(); // Show loading state in stream view

            // Ensure members are loaded
            if (state.memberList.length === 0) fetchMembers().then(() => render());

            try {
                const apiParams = {
                    endpoint: 'streams',
                    page,
                    limit: 20,
                    _t: Date.now()
                };
                if (state.activeStreamFilter !== 'all') {
                    apiParams.platform = state.activeStreamFilter;
                }
                if (state.activeMemberFilterId) {
                    apiParams.memberId = state.activeMemberFilterId;
                }
                const res = await fetchApi('youtube', { params: apiParams });

                if (res.success) {
                    state.streamData = res.streams || [];
                    state.streamPagination = res.pagination;
                    if (res.lastSync) state.lastYouTubeSync = new Date(res.lastSync);
                }

            } catch (e) {
                console.error("ËºâÂÖ•Áõ¥Êí≠Â≠òÊ™îÂ§±Êïó:", e);
                // Optionally set error state
            } finally {
                state.isLoadingStreams = false;
                render();
            }
        }

        function createStreamCard(stream) {
            // [ENHANCED] Bidirectional Sync with Live Status Bar
            // Ensures stream archive cards reflect real-time live status from the live bar
            if (state.liveStreams && state.liveStreams.length > 0) {
                // Check if this stream's member is currently live on the same platform
                const matchingLive = state.liveStreams.find(ls =>
                    ls.memberName === stream.memberName &&
                    ls.platform === stream.platform &&
                    (ls.status === 'live' || ls.status === 'upcoming')
                );

                if (matchingLive) {
                    // Forward Sync: Member is live, check if this is the current stream
                    const vodTime = new Date(stream.startTime).getTime();
                    const liveTime = new Date(matchingLive.startTime).getTime();

                    // Match by startTime (within 5 minutes tolerance)
                    // This prevents older archives from the same member on the same day being marked as Live
                    const isTimeMatched = Math.abs(vodTime - liveTime) < 5 * 60 * 1000;

                    if (isTimeMatched) {
                        stream.status = matchingLive.status; // Sync status (live/upcoming)
                        // Use the Live Thumbnail (which works) instead of potentially broken VOD thumbnail
                        if (matchingLive.thumbnailUrl && stream.platform !== 'youtube') {
                            stream.thumbnail = matchingLive.thumbnailUrl;
                        }
                    }
                } else if (stream.status === 'live') {
                    // Reverse Sync: Stream shows 'live' but member is NOT in live bar
                    // This means the stream has ended, correct the status
                    stream.status = 'ended';
                }
            } else if (stream.status === 'live' && state.liveStreams && state.liveStreams.length === 0) {
                // Edge case: live bar is empty but stream shows 'live' - stream has ended
                stream.status = 'ended';
            }

            const card = document.createElement('div');

            // Platform Styles (Moved up for Border Logic)
            let platformColor = 'text-red-400';
            let platformBg = 'bg-red-600';
            let platformBorder = 'border-red-500'; // Default Red
            if (stream.platform === 'twitch') {
                platformColor = 'text-purple-400';
                platformBg = 'bg-purple-600';
                platformBorder = 'border-purple-500';
            } else if (stream.platform === 'bilibili') {
                platformColor = 'text-sky-400';
                platformBg = 'bg-sky-600';
                platformBorder = 'border-sky-500';
            }

            // Border Logic
            let borderClass = 'border border-gray-700'; // Default
            let extraClasses = '';
            if (stream.status === 'live') {
                borderClass = `border-2 ${platformBorder} shadow-[0_0_15px_rgba(0,0,0,0.5)]`; // Use Platform Color for Live
                extraClasses = 'is-live'; // Adds pulsing animation
            } else if (stream.hasClips) {
                borderClass = 'border-2 border-emerald-400/80 shadow-[0_0_10px_rgba(52,211,153,0.3)]'; // Green if clips exist
            }

            card.className = `stream-card bg-gray-800 rounded-lg overflow-hidden shadow-lg hover:shadow-cyan-400/20 transition-all duration-300 flex flex-col ${borderClass} ${extraClasses}`;
            // card.onclick = () => openStreamModal(stream._id); // REMOVED: Moved to button

            // Video URL Logic (Moved here for clarity)
            // NO-OP: Platform styles already defined above

            const timeStr = new Date(stream.startTime).toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false });

            // Duration Logic
            let durationStr = '';

            // 1. Try pre-stored duration (Twitch/Bilibili/YouTube ISO)
            if (stream.duration) {
                if (typeof stream.duration === 'number') {
                    // Seconds (Bilibili sometimes)
                    const hours = Math.floor(stream.duration / 3600);
                    const minutes = Math.floor((stream.duration % 3600) / 60);
                    const seconds = Math.floor(stream.duration % 60);
                    durationStr = hours > 0
                        ? `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
                        : `${minutes}:${String(seconds).padStart(2, '0')}`;
                } else if (typeof stream.duration === 'string') {
                    if (stream.duration.startsWith('PT')) {
                        // YouTube ISO 8601 (PT1H2M3S)
                        durationStr = formatDuration(stream.duration);
                    } else {
                        // Twitch (3h30m10s) or Bilibili (MM:SS) - Display directly or simple cleanup
                        // Twitch format "1h30m" is readable, Bilibili "10:00" is readable.
                        durationStr = stream.duration.replace('h', ':').replace('m', ':').replace('s', '');
                        // Fix simple replace artifacts if needed (e.g. 1:30: -> 1:30)
                        if (durationStr.endsWith(':')) durationStr = durationStr.slice(0, -1);
                    }
                }
            }

            // 2. Fallback to Calculation (YouTube Archives if duration missing)
            if (!durationStr && stream.status !== 'live' && stream.startTime && stream.endTime) {
                const start = new Date(stream.startTime);
                const end = new Date(stream.endTime);
                const diff = end - start;
                if (diff > 0) {
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    durationStr = hours > 0
                        ? `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
                        : `${minutes}:${String(seconds).padStart(2, '0')}`;
                }
            }

            // LIVE Badge (Prominent)
            let liveBadgeHtml = '';
            if (stream.status === 'live') {
                liveBadgeHtml = `<span class="live-badge absolute top-2 left-2"><span class="live-dot"></span>Áõ¥Êí≠‰∏≠</span>`;
            }

            // "No Clips" / "Clip Prohibited" Badge
            let tagsHtml = '';
            if (stream.isClipProhibited) {
                tagsHtml += `<span class="absolute top-2 right-2 bg-red-900/80 text-red-200 text-xs px-2 py-1 rounded border border-red-500/50 backdrop-blur z-20 font-bold">üö´ Á¶ÅÊ≠¢Ââ™ËºØ</span>`;
            }

            // "Has Clips" Badge (Based on DB lookup) - Only show if NOT live (live takes precedence on left)
            if (stream.hasClips && stream.status !== 'live') {
                tagsHtml += `<span class="absolute top-2 left-2 bg-teal-500/90 text-white text-xs px-2 py-1 rounded border border-teal-400/50 backdrop-blur z-20 font-bold shadow-lg shadow-teal-500/20">‚ú® ÊúâÂâ™ËºØ</span>`;
            } else if (stream.hasClips && stream.status === 'live') {
                // If live AND has clips, show clips badge on the right side (below prohibited if exists)
                tagsHtml += `<span class="absolute top-10 left-2 bg-teal-500/90 text-white text-xs px-2 py-1 rounded border border-teal-400/50 backdrop-blur z-20 font-bold shadow-lg shadow-teal-500/20">‚ú® ÊúâÂâ™ËºØ</span>`;
            }

            let videoUrl = stream.url;
            if (!videoUrl) {
                videoUrl = stream.platform === 'twitch' ? `https://www.twitch.tv/videos/${stream.streamId}` :
                    stream.platform === 'bilibili' ?
                        (stream.status === 'live' ? `https://live.bilibili.com/${stream.streamId}` : `https://www.bilibili.com/video/${stream.streamId}`) :
                        `https://www.youtube.com/watch?v=${stream.streamId}`;
            }

            // Twitch Processing Thumbnail Fix
            if (stream.thumbnail && stream.thumbnail.includes('404_processing')) {
                stream.thumbnail = 'https://placehold.co/640x360/6441a5/ffffff?text=Processing...';
            }

            card.innerHTML = `
                <div class="relative w-full aspect-video bg-gray-900 overflow-hidden">
                    <a href="${videoUrl}" target="_blank" class="block w-full h-full">
                        <img src="${stream.thumbnail}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 opacity-90 group-hover:opacity-100" onerror="this.src='https://placehold.co/480x360/1a202c/e53e3e?text=No+Image'">
                    </a>
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent opacity-80 pointer-events-none"></div>
                    ${liveBadgeHtml}
                    ${tagsHtml}
                    ${durationStr ? `<div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs font-bold px-1.5 py-0.5 rounded backdrop-blur border border-white/10 shadow-sm font-mono tracking-wide">${durationStr}</div>` : ''}
                </div>
                
                <div class="p-4 flex flex-col flex-grow relative">
                     <div class="flex items-start justify-between gap-2 mb-2">
                        <h3 class="font-bold text-gray-100 leading-snug hover:text-cyan-400 transition-colors line-clamp-2">
                            <a href="${videoUrl}" target="_blank">${stream.title}</a>
                        </h3>
                     </div>
                     
                     <div class="mt-auto flex flex-col gap-3 pt-3 border-t border-gray-700/50">
                        <!-- User Action Row -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <span class="text-xs text-gray-400 font-mono bg-gray-700/50 px-1.5 py-0.5 rounded flex-shrink-0">${stream.memberName}</span>
                                <span class="text-[11px] text-gray-500 truncate" title="${timeStr}">${timeStr}</span>
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0">
                                <div class="w-2 h-2 rounded-full ${platformBg}"></div>
                                <span class="text-xs uppercase font-bold tracking-wider ${platformColor}">${stream.platform}</span>
                            </div>
                        </div>

                        <!-- Clip Button -->
                        <button class="w-full py-1.5 ${stream.hasClips ? 'bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-gray-700 hover:bg-cyan-600 text-gray-300 hover:text-white'} rounded text-sm font-bold transition-colors flex items-center justify-center gap-2" onclick="openStreamModal('${stream._id}')">
                            <span>${stream.hasClips ? '‚ú®' : 'üé¨'}</span> ${stream.hasClips ? 'Êü•ÁúãÁ≤æËèØ' : 'Â∞öÁÑ°Á≤æËèØ'}
                        </button>
                     </div>
                </div>
            `;
            return card;
        }

        function renderStoriesFilter() {
            // Wrapper with scroll arrows
            const wrapper = document.createElement('div');
            wrapper.className = "stories-wrapper";

            // Left scroll button
            const leftBtn = document.createElement('button');
            leftBtn.className = "stories-scroll-btn left";
            leftBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15,18 9,12 15,6"/></svg>`;
            wrapper.appendChild(leftBtn);

            // Stories container
            const container = document.createElement('div');
            container.className = "stories-container";

            // "All" Bubble
            const allItem = document.createElement('div');
            allItem.className = `story-item ${!state.activeMemberFilterId ? 'active' : ''}`;
            allItem.onclick = () => {
                if (state.activeMemberFilterId) {
                    state.activeMemberFilterId = null;
                    loadStreams(1);
                }
            };
            allItem.innerHTML = `
                <div class="story-ring flex items-center justify-center bg-gray-800">
                     <img src="https://vspo.jp/wp-content/themes/s/favicon.ico" class="w-10 h-10 object-contain">
                </div>
                <span class="story-name">ÂÖ®ÈÉ®ÊàêÂì°</span>
            `;
            container.appendChild(allItem);

            // Members
            state.memberList.forEach(m => {
                const item = document.createElement('div');
                item.className = `story-item ${state.activeMemberFilterId === m.id ? 'active' : ''}`;
                item.onclick = () => {
                    if (state.activeMemberFilterId !== m.id) {
                        state.activeMemberFilterId = m.id;
                        loadStreams(1);
                    }
                };

                const avatar = m.avatarUrl || 'https://placehold.co/64x64/1f2937/9ca3af?text=?';

                item.innerHTML = `
                    <div class="story-ring">
                        <img src="${avatar}" class="story-avatar">
                    </div>
                    <span class="story-name">${m.name}</span>
                `;
                container.appendChild(item);
            });

            wrapper.appendChild(container);

            // Right scroll button
            const rightBtn = document.createElement('button');
            rightBtn.className = "stories-scroll-btn right";
            rightBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"/></svg>`;
            wrapper.appendChild(rightBtn);

            // Update arrow visibility based on scroll position
            const updateArrows = () => {
                const canScrollLeft = container.scrollLeft > 10;
                const canScrollRight = container.scrollLeft < container.scrollWidth - container.clientWidth - 10;
                leftBtn.classList.toggle('visible', canScrollLeft);
                rightBtn.classList.toggle('visible', canScrollRight);
            };

            // Scroll button click handlers
            leftBtn.onclick = () => { container.scrollBy({ left: -200, behavior: 'smooth' }); };
            rightBtn.onclick = () => { container.scrollBy({ left: 200, behavior: 'smooth' }); };

            // Restore scroll position
            if (state.storiesScrollLeft > 0) {
                // Use setTimeout to ensure it happens after it's in the DOM
                setTimeout(() => {
                    container.scrollLeft = state.storiesScrollLeft;
                    updateArrows();
                }, 0);
            }

            container.addEventListener('scroll', updateArrows);
            // Initial check after render
            setTimeout(updateArrows, 100);

            // Enable Mouse Wheel & Drag Scrolling
            enableHorizontalScroll(container);

            return wrapper;
        }

        function enableHorizontalScroll(element) {
            // Mouse Wheel (Vertical -> Horizontal)
            element.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    element.scrollLeft += e.deltaY;
                }
            }, { passive: false });

            // Drag to Scroll
            let isDown = false;
            let startX;
            let scrollLeft;

            element.addEventListener('mousedown', (e) => {
                isDown = true;
                element.classList.add('active'); // Optional: for cursor style
                startX = e.pageX - element.offsetLeft;
                scrollLeft = element.scrollLeft;
            });

            // Capture scroll for persistence
            element.addEventListener('scroll', () => {
                state.storiesScrollLeft = element.scrollLeft;
            });
            element.addEventListener('mouseleave', () => { isDown = false; });
            element.addEventListener('mouseup', () => { isDown = false; });
            element.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - element.offsetLeft;
                const walk = (x - startX) * 2; // Scroll-fast
                element.scrollLeft = scrollLeft - walk;
            });
        }

        function createStreamViewElement() {
            const container = document.createElement('div');
            container.className = "animate-fade-in";

            // 0. Stories Filter (Members)
            container.appendChild(renderStoriesFilter());

            // 1. Filters (Platform)
            const filterContainer = document.createElement('div');
            filterContainer.className = "flex space-x-2 mb-6 overflow-x-auto pb-2 no-scrollbar";
            const filters = [
                { id: 'all', label: 'ÂÖ®ÈÉ®' },
                { id: 'youtube', label: 'YouTube' },
                { id: 'twitch', label: 'Twitch' },
                { id: 'bilibili', label: 'Bilibili' }
            ];
            filters.forEach(f => {
                const btn = document.createElement('button');
                const isActive = state.activeStreamFilter === f.id;
                btn.className = `px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${isActive ? 'bg-white text-gray-900 shadow-lg shadow-white/20' : 'bg-gray-800 border border-gray-600 text-gray-300 hover:bg-gray-700 hover:border-gray-500 hover:text-white'}`;
                btn.textContent = f.label;
                btn.onclick = () => {
                    if (state.activeStreamFilter !== f.id) {
                        state.activeStreamFilter = f.id;
                        loadStreams(1);
                    }
                };
                filterContainer.appendChild(btn);
            });
            container.appendChild(filterContainer);

            // 2. Content
            if (state.isLoadingStreams) {
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";
                for (let i = 0; i < 8; i++) grid.appendChild(createSkeleton('card'));
                container.appendChild(grid);
            } else if (!state.streamData || state.streamData.length === 0) {
                const noMsg = document.createElement('div');
                noMsg.className = "text-center text-gray-400 py-20 bg-gray-800/30 rounded-lg";
                noMsg.innerHTML = '<p class="text-xl mb-2">Ê≤íÊúâÊâæÂà∞Áõ¥Êí≠Â≠òÊ™î (-Œπ_- )</p>';
                container.appendChild(noMsg);
            } else {
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";
                state.streamData.forEach(stream => {
                    grid.appendChild(createStreamCard(stream));
                });
                container.appendChild(grid);

                // 3. Pagination
                if (state.streamPagination.totalPages > 1) {
                    const pagContainer = document.createElement('div');
                    pagContainer.className = "flex justify-center items-center space-x-2 mt-8 flex-wrap gap-y-2";
                    const { page, totalPages } = state.streamPagination;

                    const createPageBtn = (p, label, disabled = false, active = false) => {
                        const btn = document.createElement('button');
                        btn.className = `w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center transition-all duration-200 \${active ? 'bg-cyan-600 text-white font-bold shadow-lg shadow-cyan-500/30' : 'bg-gray-700 text-gray-400 hover:bg-gray-600 hover:text-white'}`;
                        if (disabled) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
                        btn.textContent = label || p;
                        if (!disabled && !active) btn.onclick = () => { loadStreams(p); window.scrollTo({ top: 0, behavior: 'smooth' }); };
                        return btn;
                    };

                    pagContainer.appendChild(createPageBtn(page - 1, '‚Äπ', page === 1));

                    // Simple Logic: 1 ... prev curr next ... total
                    if (page > 3) {
                        pagContainer.appendChild(createPageBtn(1, '1'));
                        pagContainer.appendChild(document.createTextNode('...'));
                    }
                    if (page > 1 && page <= 3) { // Close to start
                        for (let i = 1; i < page; i++) pagContainer.appendChild(createPageBtn(i, i));
                    } else if (page > 3) {
                        pagContainer.appendChild(createPageBtn(page - 1, page - 1));
                    }

                    pagContainer.appendChild(createPageBtn(page, page, false, true));

                    if (page < totalPages - 2) {
                        pagContainer.appendChild(createPageBtn(page + 1, page + 1));
                        pagContainer.appendChild(document.createTextNode('...'));
                        pagContainer.appendChild(createPageBtn(totalPages, totalPages));
                    } else {
                        for (let i = page + 1; i <= totalPages; i++) pagContainer.appendChild(createPageBtn(i, i));
                    }

                    pagContainer.appendChild(createPageBtn(page + 1, '‚Ä∫', page === totalPages));
                    container.appendChild(pagContainer);
                }
            }

            return container;
        }

        function render(onRenderComplete) {
            const { allVideos, isLoading, isClassifying, lastUpdated, apiError, totalVisits, todayVisits, activeView, activeVideoTypeFilter, currentPage, itemsPerPage, activeMemberFilter, activeChannelFilter, blacklist, isFilterDropdownOpen, activeLanguage } = state;

            appContainer.innerHTML = '';

            // --- Global State for Live Preview ---
            if (!window.livePreviewState) {
                window.livePreviewState = {
                    card: null,
                    timer: null,
                    currentUrl: '',
                    delay: 400
                };
            }

            // 1. Helper to create HTML (Global)
            window.createLiveBarContentHTML = function (showLoading, showStreams, liveStreams) {
                if (showLoading) {
                    return `
                    <div class="bg-gray-800/60 backdrop-blur border border-yellow-500/30 rounded-xl p-3 flex items-center justify-center relative shadow-lg shadow-yellow-900/10 h-[72px]">
                         <div class="flex items-center space-x-3">
                            <svg class="animate-spin h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="font-bold text-yellow-400 tracking-wider text-sm">Ê≠£Âú®Êõ¥Êñ∞Áõ¥Êí≠ÁãÄÊÖã...</span>
                        </div>
                    </div>`;
                } else {
                    return `
                    <div class="bg-gray-800/60 backdrop-blur border border-red-500/30 rounded-xl p-3 flex items-center overflow-hidden relative shadow-lg shadow-red-900/10">
                        <div class="flex-shrink-0 flex items-center pr-4 border-r border-gray-700 mr-4 z-10 bg-transparent">
                            <span class="relative flex h-3 w-3 mr-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                            <div class="flex flex-col">
                                <span class="font-bold text-red-400 tracking-wider text-sm">LIVE NOW</span>
                                <span class="text-[10px] text-gray-500 font-mono leading-none mt-0.5" title="‰∏äÊ¨°Ê™¢Êü•ÊôÇÈñì">
                                    ${(() => {
                            if (!state.liveLastUpdated) return '';
                            const date = new Date(state.liveLastUpdated);
                            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                        })()}
                                </span>
                            </div>
                        </div>
                        
                        <div class="relative flex-grow min-w-0 group/scroll">
                             <!-- Left Navigation Arrow -->
                            <button id="scroll-left" class="absolute left-0 top-1/2 -translate-y-1/2 z-20 bg-black/50 hover:bg-black/80 text-white rounded-full p-1 opacity-0 pointer-events-none transition-all duration-300 transform -translate-x-2 group-hover/scroll:translate-x-0 backdrop-blur-sm border border-white/10 shadow-lg" aria-label="Scroll Left">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>

                            <div id="live-stream-bar" class="live-stream-container flex items-center gap-6 overflow-x-auto overflow-y-hidden mask-gradient-right pb-2 pt-2 pl-1 scroll-smooth">
                                ${liveStreams.map(s => `
                                    <a href="${s.url}" 
                                       target="_blank" 
                                       rel="noopener noreferrer" 
                                       class="group relative flex-shrink-0 transition-transform hover:scale-105" 
                                       title="${s.memberName}${s.platform === 'twitch' ? ' (Twitch)' : s.platform === 'bilibili' ? ' (Bilibili)' : ''}"
                                       data-platform="${s.platform}"
                                       data-thumbnail="${s.thumbnailUrl || ''}"
                                       data-title="${s.title?.replace(/"/g, '&quot;') || ''}"
                                       data-name="${s.memberName}"
                                       data-status="${s.status || 'live'}"
                                       data-starttime="${s.startTime || ''}"
                                    >
                                        <div class="relative">
                                            ${s.status === 'upcoming' ? '' : `<div class="absolute -inset-1 bg-gradient-to-tr ${s.platform === 'twitch' ? 'from-purple-600 to-purple-400' : s.platform === 'bilibili' ? 'from-sky-500 to-sky-400' : 'from-red-600 to-red-400'} rounded-full opacity-75 group-hover:opacity-100 blur-[2px] animate-pulse"></div>`}
                                            <img src="${s.avatarUrl}" alt="${s.memberName}" referrerpolicy="no-referrer" class="w-12 h-12 rounded-full border-2 ${s.status === 'upcoming' ? 'border-gray-500 grayscale opacity-80' : s.platform === 'twitch' ? 'border-purple-500' : s.platform === 'bilibili' ? 'border-sky-500' : 'border-red-500'} relative z-10 bg-gray-900 object-cover">
                                            
                                            ${s.status === 'upcoming'
                                ? (() => {
                                    const date = new Date(s.startTime);
                                    const timeStr = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                                    // Only show MM/DD if not today? For compactness, just HH:MM might be better, but user asked for date too.
                                    // Let's use condensed format for the tiny bubbles.
                                    return `<div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-gray-700 text-gray-200 text-[8px] font-bold px-1 py-0.5 rounded z-20 shadow-sm whitespace-nowrap border border-gray-500">${timeStr}</div>`;
                                })()
                                : `<div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 ${s.platform === 'bilibili' ? 'bg-sky-600' : 'bg-red-600'} text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full z-20 shadow-sm whitespace-nowrap border-2 border-gray-900">LIVE</div>`
                            }
                                        </div>
                                    </a>
                                `).join('')}
                            </div>

                             <!-- Right Navigation Arrow -->
                            <button id="scroll-right" class="absolute right-0 top-1/2 -translate-y-1/2 z-20 bg-black/50 hover:bg-black/80 text-white rounded-full p-1 opacity-0 pointer-events-none transition-all duration-300 transform translate-x-2 group-hover/scroll:translate-x-0 backdrop-blur-sm border border-white/10 shadow-lg" aria-label="Scroll Right">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                    </div>`;
                }
            };

            // 2. Helper to attach listeners (Global)
            window.attachLiveBarListeners = function (liveBarEl) {
                const container = liveBarEl.querySelector('.live-stream-container');
                const btnLeft = liveBarEl.querySelector('#scroll-left');
                const btnRight = liveBarEl.querySelector('#scroll-right');

                if (container && btnLeft && btnRight) {
                    // Scroll Wheel Logic
                    container.addEventListener('wheel', (e) => {
                        if (e.deltaY !== 0) {
                            e.preventDefault();
                            container.scrollLeft += e.deltaY;
                        }
                    }, { passive: false });

                    // Arrow Click Logic
                    const scrollAmount = 300;
                    btnLeft.addEventListener('click', () => container.scrollBy({ left: -scrollAmount, behavior: 'smooth' }));
                    btnRight.addEventListener('click', () => container.scrollBy({ left: scrollAmount, behavior: 'smooth' }));

                    // Update Indicators State
                    const updateIndicators = () => {
                        const isScrollable = container.scrollWidth > container.clientWidth;
                        const atStart = container.scrollLeft <= 0;
                        const atEnd = container.scrollLeft + container.clientWidth >= container.scrollWidth - 1;

                        if (!atStart && isScrollable) {
                            btnLeft.classList.remove('opacity-0', 'pointer-events-none', '-translate-x-2');
                            btnLeft.classList.add('opacity-100', 'pointer-events-auto', 'translate-x-0');
                        } else {
                            btnLeft.classList.add('opacity-0', 'pointer-events-none', '-translate-x-2');
                            btnLeft.classList.remove('opacity-100', 'pointer-events-auto', 'translate-x-0');
                        }

                        if (!atEnd && isScrollable) {
                            btnRight.classList.remove('opacity-0', 'pointer-events-none', 'translate-x-2');
                            btnRight.classList.add('opacity-100', 'pointer-events-auto', 'translate-x-0');
                        } else {
                            btnRight.classList.add('opacity-0', 'pointer-events-none', 'translate-x-2');
                            btnRight.classList.remove('opacity-100', 'pointer-events-auto', 'translate-x-0');
                        }
                    };

                    updateIndicators();
                    container.addEventListener('scroll', updateIndicators);
                    window.addEventListener('resize', updateIndicators);
                    liveBarEl.addEventListener('mouseenter', updateIndicators);

                    // --- GLOBAL HOVER PREVIEW LOGIC ---
                    let previewCard = document.getElementById('live-preview-card');
                    if (!previewCard) {
                        previewCard = document.createElement('div');
                        previewCard.id = 'live-preview-card';
                        previewCard.className = 'fixed z-50 pointer-events-none opacity-0 transition-opacity duration-300 ease-out hidden w-64 rounded-xl overflow-hidden shadow-2xl bg-gray-900/95 backdrop-blur border border-white/10 flex flex-col font-sans cursor-pointer';
                        document.body.appendChild(previewCard);
                    }
                    window.livePreviewState.card = previewCard;

                    const showCard = (target) => {
                        const platform = target.dataset.platform;
                        const thumbnail = target.dataset.thumbnail;
                        const title = target.dataset.title || 'ÁÑ°Ê®ôÈ°å';
                        const name = target.dataset.name;
                        window.livePreviewState.currentUrl = target.href; // Update URL globally

                        if ((platform !== 'youtube' && platform !== 'twitch' && platform !== 'bilibili') || !thumbnail) {
                            return;
                        }

                        let platformColor = 'text-red-400';
                        let platformBadgeBg = 'bg-red-600';
                        let platformName = 'YouTube';

                        if (platform === 'twitch') {
                            platformColor = 'text-purple-400';
                            platformBadgeBg = 'bg-purple-600';
                            platformName = 'Twitch';
                        } else if (platform === 'bilibili') {
                            platformColor = 'text-sky-400';
                            platformBadgeBg = 'bg-sky-600';
                            platformName = 'Bilibili';
                        }

                        // Determine Badge & Status
                        let statusBadgeHtml = '';
                        if (target.dataset.status === 'upcoming' && target.dataset.starttime) {
                            const date = new Date(target.dataset.starttime);
                            const month = date.getMonth() + 1;
                            const day = date.getDate();
                            const time = date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                            const dateStr = `${month}/${day} ${time}`;

                            statusBadgeHtml = `
                                <div class="absolute bottom-2 right-2 bg-gray-600/90 text-white text-[10px] px-1.5 py-0.5 rounded font-bold flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-yellow-400"></span>
                                    Âç≥Â∞áÈñãÂßã ${dateStr}
                                </div>`;

                            // Dim the thumbnail slightly for upcoming
                            platformColor = 'text-gray-400';
                        } else {
                            statusBadgeHtml = `<div class="absolute bottom-2 right-2 ${platformBadgeBg} text-white text-[10px] px-1.5 py-0.5 rounded font-bold">LIVE</div>`;
                        }

                        previewCard.innerHTML = `
                             <div class="w-full aspect-video bg-gray-800 relative overflow-hidden">
                                 <img src="${thumbnail}" class="w-full h-full object-cover ${target.dataset.status === 'upcoming' ? 'grayscale opacity-80' : ''}" alt="Thumbnail" referrerpolicy="no-referrer">
                                 <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                                 ${statusBadgeHtml}
                             </div>
                             <div class="p-3">
                                 <h3 class="text-white text-xs font-bold leading-tight line-clamp-2 mb-1.5">${title}</h3>
                                 <div class="flex items-center text-gray-400 text-[10px]">
                                     <span class="truncate max-w-[120px]">${name}</span>
                                     <span class="mx-1">‚Ä¢</span>
                                     <span class="${platformColor}">${platformName}</span>
                                 </div>
                             </div>
                         `;

                        const rect = target.getBoundingClientRect();
                        const cardWidth = 256;
                        let left = rect.left + (rect.width / 2) - (cardWidth / 2);
                        let top = rect.bottom + 12;

                        if (left < 10) left = 10;
                        if (left + cardWidth > window.innerWidth - 10) left = window.innerWidth - cardWidth - 10;
                        if (top + 200 > window.innerHeight) top = rect.top - 200 - 12;

                        previewCard.style.transition = 'none';
                        previewCard.style.left = `${left}px`;
                        previewCard.style.top = `${top}px`;
                        previewCard.classList.remove('hidden');
                        previewCard.classList.add('pointer-events-auto');
                        previewCard.classList.remove('pointer-events-none');
                        void previewCard.offsetWidth;
                        previewCard.style.transition = '';
                        requestAnimationFrame(() => {
                            previewCard.classList.remove('opacity-0', 'translate-y-2');
                            previewCard.classList.add('opacity-100', 'translate-y-0');
                        });
                    };

                    const hideCard = () => {
                        // console.log("[Debug] hideCard called");
                        if (window.livePreviewState.timer) clearTimeout(window.livePreviewState.timer);
                        previewCard.classList.add('opacity-0', 'translate-y-2');
                        previewCard.classList.remove('opacity-100', 'translate-y-0');
                        previewCard.classList.remove('pointer-events-auto');
                        previewCard.classList.add('pointer-events-none');
                        setTimeout(() => {
                            if (previewCard.classList.contains('opacity-0')) previewCard.classList.add('hidden');
                        }, 300);
                    };

                    // Global Click Listener (Attached Once)
                    if (!previewCard.hasAttribute('data-listener-attached')) {
                        const handleCardNavigate = (e) => {
                            e.stopPropagation();
                            e.preventDefault();
                            if (window.livePreviewState.currentUrl) {
                                window.open(window.livePreviewState.currentUrl, '_blank');
                            }
                        };
                        previewCard.onclick = handleCardNavigate;
                        previewCard.ontouchstart = handleCardNavigate;
                        previewCard.setAttribute('data-listener-attached', 'true');
                    }

                    // Attach hover listeners
                    // Attach behavior listeners (Desktop Hover + Mobile Tap)
                    const isTouchDevice = () => ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

                    container.querySelectorAll('a').forEach(link => {
                        // Desktop Hover Logic
                        link.addEventListener('mouseenter', (e) => {
                            if (isTouchDevice()) return; // Ignore mouseenter on touch devices
                            const target = e.currentTarget;
                            if (window.livePreviewState.timer) clearTimeout(window.livePreviewState.timer);
                            window.livePreviewState.timer = setTimeout(() => showCard(target), window.livePreviewState.delay);
                        });

                        link.addEventListener('mouseleave', () => {
                            if (isTouchDevice()) return;
                            if (window.livePreviewState.timer) clearTimeout(window.livePreviewState.timer);
                            hideCard();
                        });

                        // Smart Click/Tap Logic
                        link.addEventListener('click', (e) => {
                            if (isTouchDevice()) {
                                // If card is NOT showing for this link, prevent nav and show card
                                // Optimization: check if card is hidden or if currentUrl matches
                                const isCardVisible = !previewCard.classList.contains('hidden') && !previewCard.classList.contains('opacity-0');
                                const isSameLink = window.livePreviewState.currentUrl === e.currentTarget.href;

                                if (!isCardVisible || !isSameLink) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    showCard(e.currentTarget);
                                }
                                // If card IS visible AND it's the same link, allow default (navigate)
                            }
                            // On desktop, click always navigates (default behavior)
                        });
                    });

                    // Global Scroll Hide (Once)
                    if (!window.globalScrollHideAttached) {
                        window.addEventListener('scroll', hideCard, { passive: true });
                        // Click outside logic
                        document.addEventListener('click', (e) => {
                            const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
                            if (isTouch) {
                                if (!container.contains(e.target) && !previewCard.contains(e.target)) {
                                    hideCard();
                                }
                            }
                        });
                        window.globalScrollHideAttached = true;
                    }
                }
            };



            const header = document.createElement('header');
            header.className = "text-center pt-8 mb-4";
            const titleText = activeLanguage === 'cn' ? 'VSPO‰∏≠ÊñáÁ≤æËèØÊî∂ÈõÜËôï' : 'VSPOÊó•ÊñáÁ≤æËèØÊî∂ÈõÜËôï';
            document.title = `„Çå„Å™„Å°ÁöÑ${titleText}`;
            header.innerHTML = `
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-cyan-400 flex justify-center items-baseline flex-wrap gap-x-3 px-4">
                <span><span class="secret-trigger" data-char="„Çå">„Çå</span><span class="secret-trigger" data-char="„Å™">„Å™</span><span class="secret-trigger" data-char="„Å°">„Å°</span>ÁöÑ${titleText}</span>
                <span class="text-lg align-middle text-gray-500 whitespace-nowrap hover:text-cyan-400 cursor-pointer transition-colors" onclick="showLatestUpdateLogs()" title="ÈªûÊìäÊü•ÁúãÊõ¥Êñ∞Êó•Ë™å">${CURRENT_APP_VERSION}</span>
            </h1>
            <div id="lang-switcher" class="mt-6 flex justify-center items-center space-x-4">
                <button data-mode="cn" class="lang-switcher-btn ${state.activeMode === 'cn' ? 'active' : ''}">‰∏≠ÊñáÁ≤æËèØ</button>
                <button data-mode="jp" class="lang-switcher-btn ${state.activeMode === 'jp' ? 'active' : ''}">Êó•ÊñáÁ≤æËèØ</button>
                <button data-mode="streams" class="lang-switcher-btn ${state.activeMode === 'streams' ? 'active' : ''}">Áõ¥Êí≠Â≠òÊ™î</button>
            </div>`;





            // [Context-Aware Timestamp Logic]
            // If in Streams mode, prioritize showing the Archive Sync Time
            // precise sync time is more relevant than generic frontend fetch time here.
            let timeDisplayHtml = '';
            if (state.activeMode === 'streams' && state.lastYouTubeSync) {
                const syncTimeStr = state.lastYouTubeSync.toLocaleString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                timeDisplayHtml = `<span class="whitespace-nowrap flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>Áõ¥Êí≠Â≠òÊ™îÂêåÊ≠•: <span class="font-mono text-emerald-300">${syncTimeStr}</span></span>`;
            } else if (lastUpdated) {
                timeDisplayHtml = `<span class="whitespace-nowrap">Ë≥áÊñôÊôÇÈñì: ${lastUpdated.toLocaleTimeString('zh-TW', { hour12: false })}</span>`;
            }

            const topBar = document.createElement('div');
            topBar.className = "sticky top-0 z-20 bg-gray-900/80 backdrop-blur-sm py-4 mb-8";
            topBar.innerHTML = `
            <div class="container mx-auto px-4 text-center text-sm text-gray-500 flex flex-col items-center space-y-2">
                <div class="flex justify-center items-center space-x-4 flex-wrap gap-y-2">
                    <span class="whitespace-nowrap">üëÄ Á∏Ω‰∫∫Ê¨°: <span class="font-semibold text-teal-400">${totalVisits.toLocaleString()}</span></span>
                    <span class="whitespace-nowrap">‚òÄÔ∏è ‰ªäÊó•‰∫∫Ê¨°: <span class="font-semibold text-amber-400">${todayVisits.toLocaleString()}</span></span>
                    ${timeDisplayHtml}
                </div>
                <div class="flex justify-center items-center space-x-4 flex-wrap gap-y-2">
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdPXcKRZdp6KgVcw_yiXhDy979wrl3y42knIh5fIjP1tGUZBQ/viewform?usp=sharing&ouid=104059498550822009260" target="_blank" rel="noopener noreferrer" class="whitespace-nowrap font-semibold text-indigo-400 hover:text-indigo-300 transition-colors duration-200 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>ÂõûÂ†±ÈÅ∫ÊºèÈ†ªÈÅì/ÂΩ±Áâá</a>
                    <button id="manage-blacklist-btn" class="whitespace-nowrap font-semibold text-red-400 hover:text-red-300 transition-colors duration-200 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.367zM14.89 13.477a6 6 0 01-8.367-8.367l8.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd" /></svg>ÁÆ°ÁêÜÂÄã‰∫∫ÈªëÂêçÂñÆ</button>
                    <button id="check-update-btn" class="whitespace-nowrap font-semibold text-cyan-400 hover:text-cyan-300 transition-colors duration-200 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zM9 13a1 1 0 112 0 1 1 0 01-2 0z" clip-rule="evenodd" /></svg>Ê™¢Êü•Êõ¥Êñ∞</button>
                </div>
            </div>`;


            let liveBarEl = null;

            // Check if live data is stale (> 15 mins)
            const isLiveStale = (Date.now() - (state.liveLastUpdated || 0)) > 900000;



            const showLoading = state.isUpdatingLive && isLiveStale;
            const showStreams = (state.liveStreams && state.liveStreams.length > 0) && !showLoading;

            if (showLoading || showStreams) {
                liveBarEl = document.createElement('div');
                liveBarEl.id = "live-status-bar-container";
                liveBarEl.className = "container mx-auto px-4 mb-8 -mt-4 animate-fade-in";

                let contentHTML = createLiveBarContentHTML(showLoading, showStreams, state.liveStreams);
                liveBarEl.innerHTML = contentHTML;

                // Add JS only if not loading
                if (!showLoading) {
                    setTimeout(() => {
                        attachLiveBarListeners(liveBarEl);
                    }, 0);
                }
            }

            const isStreamsMode = state.activeMode === 'streams';
            const mainGrid = document.createElement('div');

            // Adjust Grid Layout based on mode
            if (isStreamsMode) {
                mainGrid.className = "container mx-auto px-4"; // Full width
            } else {
                mainGrid.className = "container mx-auto px-4 grid grid-cols-1 md:grid-cols-[12rem_minmax(0,1fr)] gap-8";
            }

            const filterSection = document.createElement('aside');
            filterSection.className = "md:col-start-1";

            // Only add filters if NOT in streams mode
            if (!isStreamsMode) {
                const filterContainer = document.createElement('div');
                filterContainer.className = "bg-gray-800/50 p-4 rounded-lg md:sticky md:top-28 md:flex md:flex-col md:max-h-[calc(100vh-9rem)]";
                filterContainer.innerHTML = `<h3 class="text-xl font-bold mb-4 text-gray-300 border-b border-gray-600 pb-2">ÊàêÂì°ÁØ©ÈÅ∏</h3>`;
                filterContainer.appendChild(createMemberFilterListHTML(vspoJPMembers, otherMemberGroups, activeMemberFilter));
                filterSection.appendChild(filterContainer);
                mainGrid.appendChild(filterSection); // Only append if logic allows
            } else {
                // In stream mode, we skip appending filterSection to mainGrid
            }

            const rightContent = document.createElement('main');
            if (isStreamsMode) {
                rightContent.className = "min-w-0";
            } else {
                rightContent.className = "md:col-start-2 min-w-0";
            }

            // Removed duplicate rightContent declaration

            if (isLoading) {
                const videoSkeletons = Array.from({ length: 12 }).map(() => createSkeleton('card').outerHTML).join('');
                rightContent.innerHTML = `<section style="min-height: 720px;"><div class="flex items-center justify-between mb-6"><div class="h-8 bg-gray-700 rounded w-1/3 animate-pulse"></div><div class="h-8 bg-gray-700 rounded w-1/4 animate-pulse"></div></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">${videoSkeletons}</div></section>`;
            } else if (apiError) {
                rightContent.innerHTML = createErrorDisplay(apiError);
            } else if (state.activeMode === 'streams') {
                // ============================================================
                // STREAMS MODE (Top Level)
                // ============================================================
                const videosSection = document.createElement('section');
                videosSection.id = 'streams-section';

                const headerDiv = document.createElement('div');
                headerDiv.className = "mb-6 flex items-center";
                headerDiv.innerHTML = `<h2 class="text-3xl font-bold border-l-4 border-cyan-400 pl-4">ÊàêÂì°Áõ¥Êí≠Â≠òÊ™î</h2>`;
                videosSection.appendChild(headerDiv);

                videosSection.appendChild(createStreamViewElement());
                rightContent.appendChild(videosSection);

            } else {
                const visibleVideos = allVideos.filter(video => !blacklist.some(b => b.id === video.channelId));
                console.log(`[Rentner Debug]All: ${allVideos.length}, Visible(Blacklist check): ${visibleVideos.length} `);
                let baseFilteredVideos;
                if (activeChannelFilter) { baseFilteredVideos = visibleVideos.filter(video => video.channelId === activeChannelFilter.id); }
                else if (activeMemberFilter !== 'all') { const filterKeyword = activeMemberFilter.toLowerCase(); baseFilteredVideos = visibleVideos.filter(video => (video.searchableText || '').includes(filterKeyword)); }
                else { baseFilteredVideos = visibleVideos; }
                console.log(`[Render Debug] Base Filtered(Member / Channel): ${baseFilteredVideos.length} `);
                let filteredVideos;
                if (!isClassifying && activeVideoTypeFilter !== 'all') { filteredVideos = baseFilteredVideos.filter(v => v.videoType === activeVideoTypeFilter); }
                else { filteredVideos = baseFilteredVideos; }
                console.log(`[Render Debug] Final Filtered(Type): ${filteredVideos.length} `);
                const videosForChannelList = baseFilteredVideos;
                if (filteredVideos.length === 0 && (activeMemberFilter !== 'all' || activeChannelFilter || activeVideoTypeFilter !== 'all')) {
                    const filterName = activeChannelFilter ? activeChannelFilter.name : activeMemberFilter;
                    let message = `Êâæ‰∏çÂà∞ÈóúÊñº„Äå${filterName}„ÄçÁöÑÂΩ±Áâá„ÄÇ`;
                    if (activeVideoTypeFilter !== 'all') { message = `Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑ ${activeVideoTypeFilter === 'short' ? 'Shorts Áü≠Áâá' : '‰∏ÄËà¨ÂΩ±Áâá'}„ÄÇ`; }
                    rightContent.innerHTML = `<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-lg">${message}</p>`;
                } else {


                    if (state.activeLanguage === 'cn') {
                        // ============================================================
                        // CN MODE: LEGACY SPLIT LAYOUT (Video Top + Channel Bottom)
                        // ============================================================

                        const videosSection = document.createElement('section');
                        videosSection.id = 'videos-section';

                        // Header (Title + Filters)
                        const videosHeader = document.createElement('div');
                        videosHeader.className = "flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4";
                        const titleHTML = `<div class="flex items-center"><h2 class="text-3xl font-bold border-l-4 border-cyan-400 pl-4">Á≤æËèØÂΩ±Áâá</h2><div class="tooltip ml-2"><button class="text-sm bg-gray-600 text-gray-300 rounded-full w-5 h-5 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="Ë™™Êòé">?</button><div class="tooltiptext"><p class="font-semibold mb-2">Ë™™ÊòéÔºö</p><p>1. ‰º∫ÊúçÂô®Âø´ÂèñÊØè 20 ÂàÜÈêòÊõ¥Êñ∞‰∏ÄÊ¨°</p><p>2. ÁÇ∫ÈóúÈçµÂ≠óÊêúÂ∞ãÔºåÊïÖÂèØËÉΩÂá∫ÁèæÔºö</p><div class="pl-4"><p>a. Âê´VSPOÈóúÈçµÂ≠óÁöÑÈùûVSPOÁÉ§ËÇâ</p><p>b. Âê´‰∏≠ÊñáÈóúÈçµÂ≠óÁöÑÂ§ñÊñáÂâ™ËºØ</p><p class="mt-2">Êúâ‰ª•‰∏äÊÉÖÂΩ¢Ë´ãËá≥È†ÅÈ¶ñÂõûÂ†±ËôïÂõûÂ†±</p></div></div></div></div>`;

                        // Legacy Filter Controls (Latest 12 Button)
                        const filterControlsHTML = (() => {
                            const latestButtonText = window.innerWidth < 1280 ? 'ÊúÄÊñ∞10ÈÉ®' : 'ÊúÄÊñ∞12ÈÉ®';
                            const viewModeButtons = `<div class="flex space-x-2 overflow-x-auto no-scrollbar pb-1"><button id="view-latest-btn" class="tab-btn ${activeView === 'latest' ? 'active' : ''}">${latestButtonText}</button><button id="view-all-btn" class="tab-btn ${activeView === 'all' ? 'active' : ''}">‰∏ÄÂÄãÊúàÂÖß</button></div>`;

                            // Desktop Type Buttons
                            const desktopTypeButtons = `<div class="flex space-x-2 mr-4"><button class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'all' ? 'active' : ''}" data-type="all" ${isClassifying ? 'disabled' : ''}>ÂÖ®ÈÉ®</button><button class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'video' ? 'active' : ''}" data-type="video" ${isClassifying ? 'disabled' : ''}>Âè™ÁúãÂΩ±Áâá</button><button class="tab-btn type-filter-btn ${activeVideoTypeFilter === 'short' ? 'active' : ''}" data-type="short" ${isClassifying ? 'disabled' : ''}>Âè™ÁúãShorts</button></div>`;

                            // Mobile Dropdown
                            const currentTypeLabel = activeVideoTypeFilter === 'all' ? 'ÂÖ®ÈÉ®' : activeVideoTypeFilter === 'video' ? 'Âè™ÁúãÂΩ±Áâá' : 'Âè™ÁúãShorts';
                            const mobileDropdown = `
                                <div class="relative inline-block text-left md:hidden">
                                    <button onclick="toggleCNFilterDropdown(event)" id="cn-filter-dropdown-btn" type="button" class="tab-btn inline-flex justify-center w-full shadow-sm bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-indigo-500" ${isClassifying ? 'disabled' : ''}>
                                        ${currentTypeLabel}
                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div id="cn-filter-dropdown-menu" class="origin-top-left absolute left-0 mt-2 w-32 rounded-md shadow-lg bg-gray-700 ring-1 ring-black ring-opacity-5 z-20 ${state.isFilterDropdownOpen ? '' : 'hidden'}">
                                        <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="cn-filter-dropdown-btn">
                                            <button onclick="selectCNFilter('all')" data-type="all" class="type-filter-btn w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-600 hover:text-white ${activeVideoTypeFilter === 'all' ? 'bg-gray-600 text-white' : ''}" role="menuitem">ÂÖ®ÈÉ®</button>
                                            <button onclick="selectCNFilter('video')" data-type="video" class="type-filter-btn w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-600 hover:text-white ${activeVideoTypeFilter === 'video' ? 'bg-gray-600 text-white' : ''}" role="menuitem">Âè™ÁúãÂΩ±Áâá</button>
                                            <button onclick="selectCNFilter('short')" data-type="short" class="type-filter-btn w-full text-left px-4 py-2 text-sm text-gray-300 hover:bg-gray-600 hover:text-white ${activeVideoTypeFilter === 'short' ? 'bg-gray-600 text-white' : ''}" role="menuitem">Âè™ÁúãShorts</button>
                                        </div>
                                    </div>
                                </div>`;

                            return `<div class="flex w-full md:w-auto items-center justify-between md:justify-start md:space-x-4">
                                <div class="hidden md:block">${desktopTypeButtons}</div>
                                <div class="md:hidden">${mobileDropdown}</div>
                                <div class="md:border-l-2 border-gray-600 md:pl-4">${viewModeButtons}</div>
                            </div>`;
                        })();
                        videosHeader.innerHTML = `${titleHTML} <div class="w-full md:w-auto flex-shrink-0">${filterControlsHTML}</div>`;

                        // --- Restore Channel Filter Badge for CN Mode ---
                        if (activeChannelFilter) {
                            const badgeContainer = document.createElement('div');
                            badgeContainer.className = "mb-4 animate-fade-in";
                            badgeContainer.innerHTML = `
                                <div class="inline-flex items-center space-x-2 bg-purple-900/80 text-purple-200 px-4 py-2 rounded-lg border border-purple-500/30">
                                    <span>Ê≠£Âú®ÁØ©ÈÅ∏Ôºö<strong class="text-white">${activeChannelFilter.name}</strong></span>
                                    <button id="cn-clear-filter-btn" class="hover:bg-purple-800 rounded-full p-1 transition-colors text-gray-300 hover:text-white" title="Ê∏ÖÈô§ÁØ©ÈÅ∏">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>`;
                            videosSection.appendChild(badgeContainer);

                            setTimeout(() => {
                                document.getElementById('cn-clear-filter-btn')?.addEventListener('click', () => {
                                    state.activeChannelFilter = null;
                                    render();
                                });
                            }, 0);
                        }

                        videosSection.appendChild(videosHeader);

                        // Video Grid OR Stream View
                        // Removed Stream View Logic from here (now top level)

                        {
                            const viewContainer = document.createElement('div');
                            viewContainer.style.minHeight = '720px';
                            if (activeVideoTypeFilter === 'short') { viewContainer.classList.add('view-mode-shorts-only'); }
                            const videosToDisplay = filteredVideos; // Uses legacy filtering logic (state.activeVideoTypeFilter etc but CN doesn't have type tabs usually?)

                            if (activeView === 'latest') {
                                const grid = document.createElement('div');
                                const gridClasses = activeVideoTypeFilter === 'short'
                                    ? 'grid gap-4 grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5'
                                    : 'grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';
                                grid.className = gridClasses;
                                const sliceCount = window.innerWidth < 1280 ? 10 : 12;
                                videosToDisplay.slice(0, sliceCount).forEach(video => grid.appendChild(createVideoCard(video)));
                                viewContainer.appendChild(grid);
                            } else {
                                const listContainer = document.createElement('div');
                                listContainer.className = 'space-y-3';
                                const totalPages = Math.ceil(videosToDisplay.length / itemsPerPage);
                                const startIndex = (currentPage - 1) * itemsPerPage;
                                const paginatedVideos = videosToDisplay.slice(startIndex, startIndex + itemsPerPage);
                                paginatedVideos.forEach(video => listContainer.appendChild(createVideoListItem(video)));
                                viewContainer.appendChild(listContainer);
                                if (totalPages > 1) { viewContainer.appendChild(createPaginationControls(totalPages, currentPage)); }
                            }
                            videosSection.appendChild(viewContainer);
                            rightContent.appendChild(videosSection);
                        }

                        // Channel List (Bottom) - Only show if not streams

                        const channelListSection = document.createElement('section');
                        const channelListHeader = document.createElement('div');
                        channelListHeader.className = 'flex items-baseline mb-6 gap-x-3 mt-12';

                        if (activeMemberFilter !== 'all') {
                            const member = allMembers.find(m => m.filter_keyword === activeMemberFilter);
                            const memberColor = member ? member.color : '#fbbf24';
                            channelListHeader.innerHTML = `<h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4">‰∏ÄÂÄãÊúàÂÖßÁôºÂ∏ÉÈÅé<span style="color: ${memberColor}">${member ? member.name_jp : activeMemberFilter}</span>Ââ™ËºØÁöÑÈ†ªÈÅì</h2>`;
                        } else {
                            channelListHeader.innerHTML = `<h2 class="text-3xl font-bold border-l-4 border-purple-400 pl-4">Á≤æËèØÈ†ªÈÅìÂàóË°®</h2><p class="text-gray-500 text-sm">ÂÉÖÂàóÂá∫30Â§©ÂÖßÊúâÁôºÂ∏ÉÊñ∞ÂΩ±Áâá‰πãÈ†ªÈÅì</p>`;
                        }
                        channelListSection.appendChild(channelListHeader);

                        // Calculate channel stats
                        const channels = {};
                        baseFilteredVideos.forEach(video => { if (!channels[video.channelId]) { channels[video.channelId] = { id: video.channelId, name: video.channelTitle, subscriberCount: video.subscriberCount, latestVideo: video, avatarUrl: video.channelAvatarUrl }; } });
                        const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        const channelData = Object.values(channels).filter(channel => new Date(channel.latestVideo.publishedAt) > thirtyDaysAgo).sort((a, b) => new Date(b.latestVideo.publishedAt) - new Date(a.latestVideo.publishedAt));

                        if (channelData.length > 0) {
                            const channelListGrid = document.createElement('div');
                            channelListGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
                            channelData.forEach(channel => channelListGrid.appendChild(createChannelGridCard(channel)));
                            channelListSection.appendChild(channelListGrid);
                        } else if (activeMemberFilter !== 'all') {
                            channelListSection.innerHTML += `<p class="text-center text-gray-400 p-8 bg-gray-800 rounded-lg">Êâæ‰∏çÂà∞‰∏ÄÂÄãÊúàÂÖßÁôºÂ∏ÉÈÅé„Äå${activeMemberFilter}„ÄçÂâ™ËºØÁöÑÈ†ªÈÅì„ÄÇ</p>`;
                        }
                        rightContent.appendChild(channelListSection);



                    } else {
                        // ============================================================
                        // JP MODE: TAB LAYOUT (All / Video / Short / Channels)
                        // ============================================================

                        // Tab Navigation (Replacing Title Header)
                        const tabContainer = document.createElement('div');
                        tabContainer.className = "mb-6 border-b border-gray-700 flex flex-col md:flex-row md:items-center justify-between gap-4 pb-2";

                        const tabsWrapper = document.createElement('div');
                        tabsWrapper.className = "flex flex-nowrap md:flex-wrap gap-1 md:gap-2 overflow-x-auto no-scrollbar w-full md:w-auto";

                        const isLock = isClassifying;
                        const spinner = `<div class="spinner inline-block ml-1 w-3 h-3 border-2 border-gray-400 border-t-white rounded-full animate-spin"></div>`;

                        const createTabBtn = (id, label, locked = false) => {
                            const btn = document.createElement('button');
                            const isActive = state.activeTab === id;
                            // Square styling (rounded-none or sm)
                            // Reduced padding for mobile (px-3) vs desktop (md:px-6) to fit 4 items.
                            btn.className = `whitespace-nowrap flex-shrink-0 px-3 md:px-6 py-2 text-sm font-bold tracking-wide transition-all duration-200 border-b-2 ${isActive ? 'border-cyan-400 text-cyan-400 bg-gray-800/50' : 'border-transparent text-gray-400 hover:text-gray-200 hover:bg-gray-800/30'}`;

                            if (locked) {
                                btn.disabled = true;
                                btn.classList.add('opacity-50', 'cursor-not-allowed');
                                btn.innerHTML = `${label} ${spinner}`;
                            } else {
                                btn.textContent = label;
                                btn.onclick = () => {
                                    state.activeTab = id;
                                    if (id === 'streams') {
                                        loadStreams(1);
                                    } else {
                                        state.visibleCount = 24;
                                        render();
                                    }
                                };
                            }
                            return btn;
                        };

                        tabsWrapper.appendChild(createTabBtn('all', 'ÂÖ®ÈÉ®ÂΩ±Áâá'));
                        tabsWrapper.appendChild(createTabBtn('video', 'Âè™ÁúãÂΩ±Áâá', isLock));
                        tabsWrapper.appendChild(createTabBtn('short', 'Âè™ÁúãShorts', isLock));
                        tabsWrapper.appendChild(createTabBtn('channels', 'Á≤æËèØÈ†ªÈÅìÂàóË°®'));
                        // Removed streams tab

                        tabContainer.appendChild(tabsWrapper);

                        // JP Channel Filter Banner (Right Side)
                        if (activeChannelFilter) {
                            const filterBadge = document.createElement('div');
                            filterBadge.className = "flex items-center space-x-2 bg-purple-900/80 text-purple-200 px-3 py-1.5 rounded-lg border border-purple-500/30 animate-fade-in";
                            filterBadge.innerHTML = `
                                <span class="text-xs md:text-sm">Ê≠£Âú®ÁØ©ÈÅ∏Ôºö<strong class="text-white">${activeChannelFilter.name}</strong></span>
                                <button id="jp-clear-filter-btn" class="hover:bg-purple-800 rounded-full p-0.5 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            `;
                            // Add click listener immediately since element is created here
                            // But we usually delegate or add after append. 
                            // Adding to container first.
                            filterBadge.querySelector('button').onclick = (e) => {
                                e.stopPropagation();
                                state.activeChannelFilter = null;
                                render();
                            };
                            tabContainer.appendChild(filterBadge);
                        }

                        rightContent.appendChild(tabContainer);

                        // Content Area
                        // Content Area
                        const contentSection = document.createElement('section');
                        contentSection.style.minHeight = '720px';

                        // Apply Channel Filter content filtering (JP Mode)
                        if (state.activeTab === 'channels') {
                            // ... JP Channel Grid Logic (Same as before) ...
                            const channelListSection = document.createElement('div');
                            // Show count?
                            const channelStatus = document.createElement('div');
                            channelStatus.className = 'mb-4 text-sm text-gray-400 text-right';
                            channelStatus.textContent = `È°ØÁ§∫ ${activeMemberFilter !== 'all' ? 'ÁØ©ÈÅ∏Âæå' : 'ÊâÄÊúâ'} È†ªÈÅì`;
                            // channelListSection.appendChild(channelStatus); // Optional

                            const channelGrid = document.createElement('div');
                            channelGrid.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6";

                            const uniqueChannelIds = new Set(baseFilteredVideos.map(v => v.channelId));
                            const channelsToDisplay = [];
                            const processedChannels = new Set();
                            baseFilteredVideos.forEach(video => {
                                if (!processedChannels.has(video.channelId)) {
                                    processedChannels.add(video.channelId);
                                    channelsToDisplay.push({ id: video.channelId, name: video.channelTitle, avatarUrl: video.channelAvatarUrl, subscriberCount: video.subscriberCount, latestVideo: video });
                                }
                            });
                            channelsToDisplay.forEach(channel => channelGrid.appendChild(createChannelGridCard(channel)));
                            if (channelsToDisplay.length === 0) channelGrid.innerHTML = `< p class="col-span-full text-center text-gray-500 py-8" > Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÈ†ªÈÅì„ÄÇ</p > `;
                            channelListSection.appendChild(channelGrid);
                            contentSection.appendChild(channelListSection);

                        } else {
                            // ... JP Video Grid Logic (Infinite Scroll) ...
                            let finalVideos = filteredVideos;
                            if (state.activeTab === 'video') finalVideos = finalVideos.filter(v => v.videoType === 'video');
                            if (state.activeTab === 'short') finalVideos = finalVideos.filter(v => v.videoType === 'short');

                            if (finalVideos.length === 0) {
                                contentSection.innerHTML = `<div class="text-center text-gray-400 py-20 bg-gray-800/30 rounded-lg"><p class="text-xl mb-2">Ê≤íÊúâÊâæÂà∞ÂΩ±Áâá (-Œπ_- )</p><p class="text-sm">Ë©¶ËëóÂàáÊèõÁØ©ÈÅ∏Ê¢ù‰ª∂ÁúãÁúãÔºü</p></div>`;
                            } else {
                                const grid = document.createElement('div');
                                const isShortsView = state.activeTab === 'short' || (state.activeVideoTypeFilter === 'short' && state.activeTab === 'all');
                                let gridClasses = 'grid gap-6 ';
                                if (isShortsView) { gridClasses += 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 view-mode-shorts-only'; }
                                else { gridClasses += 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4'; }
                                grid.className = gridClasses;

                                const videosToShow = finalVideos.slice(0, state.visibleCount);
                                videosToShow.forEach(video => grid.appendChild(createVideoCard(video)));

                                if (state.visibleCount < finalVideos.length) {
                                    const sentinel = document.createElement('div');
                                    sentinel.className = 'col-span-full py-8 flex justify-center';
                                    sentinel.innerHTML = `<div class="spinner w-8 h-8 border-4 border-gray-600 border-t-cyan-400 rounded-full animate-spin"></div>`;
                                    grid.appendChild(sentinel);
                                }
                                contentSection.appendChild(grid);
                            }
                        }
                        rightContent.appendChild(contentSection);
                    }
                }
            }
            mainGrid.appendChild(filterSection);
            mainGrid.appendChild(rightContent);
            appContainer.appendChild(header);
            appContainer.appendChild(topBar);
            if (liveBarEl) appContainer.appendChild(liveBarEl);
            appContainer.appendChild(mainGrid);
            setupEventListeners();
            if (onRenderComplete) onRenderComplete();
        }

        // NEW FUNCTION: Only update live bar area without re-render full page
        function updateLiveBarOnly() {
            const isLiveStale = (Date.now() - (state.liveLastUpdated || 0)) > 900000;
            const showLoading = state.isUpdatingLive && isLiveStale;
            const showStreams = (state.liveStreams && state.liveStreams.length > 0) && !showLoading;

            const existingBar = document.getElementById("live-status-bar-container");

            if (!showLoading && !showStreams) {
                // Should be hidden
                if (existingBar) existingBar.remove();
                return;
            }

            // If bar exists, update content. If not, we might need a full render OR try to insert it (Tricky)
            // Easier approach: If structure changes drastically (no bar -> bar), just do simple insert if topbar exists
            if (existingBar) {
                const contentHTML = createLiveBarContentHTML(showLoading, showStreams, state.liveStreams);
                if (existingBar.innerHTML !== contentHTML) { // Only touch DOM if changed
                    existingBar.innerHTML = contentHTML;
                    if (!showLoading) {
                        setTimeout(() => attachLiveBarListeners(existingBar), 0);
                    }
                }
            } else {
                // Bar doesn't exist but needs to show. Insert it after TopBar
                // This is a rare case (0 streams -> 1 stream update). 
                // We can just call render() here safely as user is likely at top or it's a major change
                // OR we insert it manually. Let's try inserting manually for smoothness
                const topBar = appContainer.querySelector('.sticky.top-0'); // Approximate selector
                if (topBar) {
                    const newBar = document.createElement('div');
                    newBar.id = "live-status-bar-container";
                    newBar.className = "container mx-auto px-4 mb-8 -mt-4 animate-fade-in";
                    newBar.innerHTML = createLiveBarContentHTML(showLoading, showStreams, state.liveStreams);
                    topBar.parentNode.insertBefore(newBar, topBar.nextSibling);
                    if (!showLoading) {
                        setTimeout(() => attachLiveBarListeners(newBar), 0);
                    }
                } else {
                    render(); // Fallback
                }
            }
        }

        function setupEventListeners() {
            setupSecretTrigger();
            document.getElementById('check-update-btn')?.addEventListener('click', () => performUpdateCheck(true));
            document.getElementById('manage-blacklist-btn')?.addEventListener('click', showBlacklistModal);

            document.querySelectorAll('#lang-switcher .lang-switcher-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.mode;
                    if (mode !== state.activeMode) {
                        state.activeMode = mode;
                        // localStorage.setItem(LANGUAGE_KEY, mode); // Might want to save mode instead

                        // Mode logic
                        if (mode === 'cn' || mode === 'jp') {
                            if (state.activeLanguage !== mode) {
                                state.activeLanguage = mode;
                                localStorage.setItem(LANGUAGE_KEY, mode);
                                state.activeMemberFilter = 'all';
                                state.activeChannelFilter = null;
                                state.activeVideoTypeFilter = 'all';
                                state.currentPage = 1;
                                initializeApp(); // Reload Content
                            } else {
                                render(); // Use existing content
                            }
                        } else if (mode === 'streams') {
                            loadStreams(1); // Fetch streams
                        }
                    }
                });
            });


            // --- Infinite Scroll Listener ---
            // Remove existing listener to prevent duplicates if re-setup
            if (state.scrollHandler) { window.removeEventListener('scroll', state.scrollHandler); }
            state.scrollHandler = () => {
                // Infinite Scroll Trigger
                const scrollHeight = document.documentElement.scrollHeight;
                const scrollTop = window.scrollY || document.documentElement.scrollTop;
                const clientHeight = window.innerHeight;

                if (scrollTop + clientHeight >= scrollHeight - 300) { // Trigger 300px before bottom
                    if (!state.isLoadingMore) {
                        state.isLoadingMore = true;
                        setTimeout(() => {
                            state.visibleCount += 24;
                            state.isLoadingMore = false;
                            render(); // Re-render to show more
                        }, 200);
                    }
                }

                // Back-to-Top Button Visibility
                const backToTopBtn = document.getElementById('back-to-top-btn');
                if (backToTopBtn) {
                    if (scrollTop > 500) { backToTopBtn.classList.remove('opacity-0', 'pointer-events-none'); }
                    else { backToTopBtn.classList.add('opacity-0', 'pointer-events-none'); }
                }
            };
            window.addEventListener('scroll', state.scrollHandler);

            // --- Back to Top Button ---
            if (!document.getElementById('back-to-top-btn')) {
                const backToTopBtn = document.createElement('button');
                backToTopBtn.id = 'back-to-top-btn';
                backToTopBtn.className = "fixed bottom-24 right-8 p-3 rounded-full bg-cyan-600 text-white shadow-lg shadow-cyan-500/50 hover:bg-cyan-500 transition-all duration-300 opacity-0 pointer-events-none z-50";
                backToTopBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>`;
                backToTopBtn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
                document.body.appendChild(backToTopBtn);
            }

            // --- Legacy Listeners Restored for CN Mode (Attached to specific elements recreated by render) ---
            document.getElementById('view-latest-btn')?.addEventListener('click', () => { state.activeView = 'latest'; render(); });
            document.getElementById('view-all-btn')?.addEventListener('click', () => { state.activeView = 'all'; state.currentPage = 1; render(); });
            // Removed view-streams-btn listener
            document.querySelectorAll('.pagination-btn').forEach(btn => { btn.addEventListener('click', (e) => { const page = parseInt(e.currentTarget.dataset.page, 10); if (page && page !== state.currentPage) { state.currentPage = page; render(() => window.scrollTo({ top: 0, behavior: 'smooth' })); } }); });

            document.querySelectorAll('.filter-btn').forEach(btn => { btn.addEventListener('click', (e) => { const filterList = document.getElementById('member-filter-list-container'); const scrollPosition = { top: filterList?.scrollTop || 0, left: filterList?.scrollLeft || 0 }; state.activeChannelFilter = null; state.activeMemberFilter = e.currentTarget.dataset.filter; state.currentPage = 1; render(() => { const newFilterList = document.getElementById('member-filter-list-container'); if (newFilterList) { newFilterList.scrollTop = scrollPosition.top; newFilterList.scrollLeft = scrollPosition.left; } window.scrollTo({ top: 0, behavior: 'smooth' }); }); }); });
            document.querySelectorAll('.channel-filter-btn').forEach(btn => { btn.addEventListener('click', (e) => { const button = e.currentTarget; state.activeMemberFilter = 'all'; state.activeChannelFilter = { id: button.dataset.channelId, name: button.dataset.channelName }; state.currentPage = 1; if (state.activeLanguage === 'jp') { state.activeTab = 'all'; } render(() => window.scrollTo({ top: 0, behavior: 'smooth' })); }); });
            document.getElementById('clear-channel-filter-btn')?.addEventListener('click', () => { state.activeChannelFilter = null; render(); });
        }

        // Global Listeners (Run Once)
        function setupGlobalListeners() {
            if (window.vspoGlobalListenersSetup) return;
            window.vspoGlobalListenersSetup = true;

            // --- Video Type Filters & Mobile Dropdown (Delegated) ---
            document.addEventListener('click', (e) => {
                // Mobile Dropdown Toggle
                const toggleBtn = e.target.closest('#cn-filter-dropdown-btn');
                if (toggleBtn && !toggleBtn.disabled) {
                    document.getElementById('cn-filter-dropdown-menu')?.classList.toggle('hidden');
                    return;
                }

                // Filter Button logic
                const btn = e.target.closest('.type-filter-btn');
                if (btn && !btn.disabled) {
                    // Best to rely on THIS delegated listener for cleanness, but removing onclick from HTML is extra work.
                    // Let's just set the state.

                    const type = btn.dataset.type;
                    if (type) {
                        state.activeVideoTypeFilter = type;
                        state.currentPage = 1;
                        if (state.activeLanguage === 'jp') { state.activeTab = type; }
                        render(() => window.scrollTo({ top: 0, behavior: 'smooth' }));
                        document.getElementById('cn-filter-dropdown-menu')?.classList.add('hidden');
                    }
                    return;
                }

                // Close dropdown when clicking outside
                if (!e.target.closest('#cn-filter-dropdown-menu')) {
                    document.getElementById('cn-filter-dropdown-menu')?.classList.add('hidden');
                }
            });

            let lastWidth = window.innerWidth;
            window.addEventListener('resize', () => {
                const currentWidth = window.innerWidth;
                const breakpoint = 1280;
                if ((lastWidth < breakpoint && currentWidth >= breakpoint) || (lastWidth >= breakpoint && currentWidth < breakpoint)) { if (state.activeView === 'latest') { render(); } }
                lastWidth = currentWidth;
            });
        }


        function startClassificationPolling() {
            if (state.classificationIntervalId) { clearInterval(state.classificationIntervalId); }
            console.log("ÈñãÂßãËº™Ë©¢ÂàÜÈ°ûÁãÄÊÖã...");
            state.classificationIntervalId = setInterval(async () => {
                try {
                    const status = await fetchApi('check-status'); // Returns { isDone: boolean }

                    if (!status.isDone) {
                        // [Optimization] If not done, actively trigger the next batch immediately
                        console.log("ÂàÜÈ°ûÂ∞öÊú™ÂÆåÊàêÔºåËß∏Áôº‰∏ã‰∏ÄÊâπÊ¨°ËôïÁêÜ...");
                        fetchApi('classify-videos', { method: 'POST' })
                            .then(res => console.log("ÊâπÊ¨°ËôïÁêÜÁµêÊûú:", res.message))
                            .catch(err => console.error("ÊâπÊ¨°ËôïÁêÜËß∏ÁôºÂ§±Êïó:", err));
                    } else {
                        console.log("ÂàÜÈ°ûÂÆåÊàêÔºÅÂÅúÊ≠¢Ëº™Ë©¢‰∏¶ÈáçÊñ∞Áç≤ÂèñÊúÄÁµÇË≥áÊñô„ÄÇ");
                        clearInterval(state.classificationIntervalId);
                        state.classificationIntervalId = null;
                        state.isClassifying = false;
                        const finalData = await fetchApi('youtube', { params: { lang: state.activeLanguage, no_increment: 'true' } });
                        state.allVideos = finalData.videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                        render();
                    }
                } catch (error) {
                    console.error("Ëº™Ë©¢Â§±Êïó:", error);
                    // Do not stop polling on error, just retry next tick
                    // clearInterval(state.classificationIntervalId);
                    // state.isClassifying = false;
                    // render();
                }
            }, 5000); // Â¢ûÂä†ÈñìÈöîÂà∞ 5s ÈÅøÂÖçÈÅéÊñºÈ†ªÁπÅ
        }

        function startLiveStatusPolling() {
            if (state.livePollingId) clearInterval(state.livePollingId);
            console.log("ÂïüÂãïÁõ¥Êí≠ÁãÄÊÖãËº™Ë©¢...");
            state.livePollingId = setInterval(async () => {
                try {
                    const res = await fetchApi('live');
                    if (res.success) {
                        state.liveStreams = res.streams || [];
                        state.isUpdatingLive = res.isUpdating || false;
                        state.liveLastUpdated = res.timestamp || 0;
                        state.liveStreams = res.streams || [];
                        state.isUpdatingLive = res.isUpdating || false;
                        state.liveLastUpdated = res.timestamp || 0;
                        updateLiveBarOnly(); // CHANGED: Use partial update instead of render()

                        if (!state.isUpdatingLive) {
                            console.log("Áõ¥Êí≠ÁãÄÊÖãÊõ¥Êñ∞ÂÆåÊàêÔºÅÂÅúÊ≠¢Ëº™Ë©¢„ÄÇ");
                            clearInterval(state.livePollingId);
                            state.livePollingId = null;
                        }
                    }
                } catch (e) { console.warn("Áõ¥Êí≠ÁãÄÊÖãËº™Ë©¢Â§±Êïó:", e); }
            }, 5000);
        }

        async function initializeApp(force = false, password = '') {
            state.activeLanguage = localStorage.getItem(LANGUAGE_KEY) || 'cn';
            state.blacklist = getBlacklist();
            state.isLoading = true;
            state.liveStreams = [];
            render();
            // Fetch Live Status Background
            fetchApi('live').then(res => {
                if (res.success) {
                    state.liveStreams = res.streams || [];
                    state.isUpdatingLive = res.isUpdating || false;
                    state.liveLastUpdated = res.timestamp || 0;
                    render();

                    if (state.isUpdatingLive) {
                        startLiveStatusPolling();
                    }
                }
            }).catch(e => console.warn('Live status fetch failed:', e));


            const lastSeenVersion = localStorage.getItem(LAST_SEEN_VERSION_KEY);
            if (lastSeenVersion !== CURRENT_APP_VERSION) {
                const allVersions = Object.keys(UPDATE_LOGS).sort((a, b) => parseFloat(b.slice(1)) - parseFloat(a.slice(1)));
                const newVersionsToShow = [];
                for (const v of allVersions) {
                    if (!lastSeenVersion || parseFloat(v.slice(1)) > parseFloat(lastSeenVersion.slice(1))) { newVersionsToShow.push(v); } else { break; }
                }
                if (newVersionsToShow.length > 0) { showVersionUpdateModal(newVersionsToShow); }
            }

            try {
                const apiParams = { lang: state.activeLanguage };
                if (force) {
                    apiParams.force_refresh = true;
                    apiParams.password = password;
                }

                const visitCountedInSession = sessionStorage.getItem('vspo_visit_counted');
                if (!visitCountedInSession) {
                    sessionStorage.setItem('vspo_visit_counted', 'true');
                } else {
                    apiParams.no_increment = 'true';
                }

                const dataPackage = await fetchApi('youtube', { params: apiParams });

                const videos = (dataPackage.videos || []).map(v => {
                    if (v.originalStreamInfo && typeof v.originalStreamInfo === 'string') {
                        try { v.originalStreamInfo = JSON.parse(v.originalStreamInfo); }
                        catch (e) { console.error(`Ëß£Êûê 'originalStreamInfo' Â§±Êïó(Video ID: ${v.id}): `, e); v.originalStreamInfo = null; }
                    }
                    v.videoType = v.videoType || v.type || (v.durationMinutes <= 1.05 ? 'short' : 'video');
                    return v;
                });

                state.allVideos = videos.sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
                state.lastUpdated = new Date(dataPackage.timestamp);
                state.totalVisits = dataPackage.totalVisits || 0;
                state.totalVisits = dataPackage.totalVisits || 0;
                state.todayVisits = dataPackage.todayVisits || 0;

                // --- START: ËôïÁêÜÂÖ¨ÂëäÈ°ØÁ§∫ ---
                const announcement = dataPackage.announcement;
                const banner = document.getElementById('announcement-banner');
                const bannerText = document.getElementById('announcement-text');
                const closeBtn = document.getElementById('close-announcement-btn');

                if (announcement && announcement.active) {
                    const dismissedKey = `vspo_announcement_dismissed_${announcement.timestamp} `;
                    const isDismissed = localStorage.getItem(dismissedKey);

                    if (!isDismissed) {
                        bannerText.textContent = announcement.content;
                        banner.className = `type-${announcement.type}`; // Ë®≠ÂÆöÈ°ûÂûãÊ®£Âºè
                        banner.classList.add('visible');

                        closeBtn.onclick = () => {
                            banner.classList.remove('visible');
                            localStorage.setItem(dismissedKey, 'true');
                        };
                    }
                }
                // --- END: ËôïÁêÜÂÖ¨ÂëäÈ°ØÁ§∫ ---

                // Áç®Á´ãËôïÁêÜÂàÜÈ°ûÁãÄÊÖãÊ™¢Êü•ÔºåÈÅøÂÖçÂõ†ÂÖ∂Â§±Êïó/ÈÄæÊôÇËÄåÂ∞éËá¥Êï¥ÂÄãÈ†ÅÈù¢È°ØÁ§∫ÈåØË™§
                try {
                    const classificationStatus = await fetchApi('check-status', { timeout: 5000 }); // Áµ¶‰∫àËºÉÁü≠ÁöÑ timeout
                    state.needsClassification = !classificationStatus.isDone;

                    if (state.needsClassification) {
                        console.log("ÂÅµÊ∏¨Âà∞ÂæåÁ´ØÊúâÊú™ÂàÜÈ°ûÁöÑÂΩ±ÁâáÔºåÂïüÂãïËÉåÊôØÂàÜÈ°ûÁ®ãÂ∫è„ÄÇ");
                        state.isClassifying = true;
                        // ‰∏çÁ≠âÂæÖÂàÜÈ°ûË´ãÊ±ÇÁµêÊûúÔºåÈÅøÂÖçÈòªÂ°û
                        fetchApi('classify-videos', { method: 'POST' }).catch(err => console.error("ËÉåÊôØËß∏ÁôºÂàÜÈ°ûÂ§±Êïó (ÈùûËá¥ÂëΩ):", err));
                        startClassificationPolling();
                    }
                } catch (statusError) {
                    console.warn("Ê™¢Êü•ÂàÜÈ°ûÁãÄÊÖãÂ§±Êïó (ÈùûËá¥ÂëΩÈåØË™§):", statusError);
                    // Âç≥‰ΩøÊ™¢Êü•Â§±ÊïóÔºå‰πü‰∏çÂΩ±Èüø‰∏ªÈ†ÅÈù¢È°ØÁ§∫
                }

            } catch (error) {
                console.error("ÂàùÂßãÂåñÂ§±Êïó:", error);
                state.apiError = error.message;
                if (force) { alert(`ÈåØË™§: ${error.message || 'Êú™Áü•ÈåØË™§'}`); }
            } finally {
                state.isLoading = false;
                render();
                setTimeout(() => performUpdateCheck(false), 2000);
            }
            setupGlobalListeners();
        }

        function setupSecretTrigger() {
            let sequence = [];
            let lastClickTime = 0;
            const targetSequence = ['„Çå', '„Å™', '„Å°'];
            document.querySelectorAll('.secret-trigger').forEach(span => {
                span.addEventListener('click', (e) => {
                    const char = e.target.dataset.char;
                    const now = Date.now();
                    if (now - lastClickTime > 3000) sequence = [];
                    sequence.push(char);
                    lastClickTime = now;
                    if (sequence.join('') === targetSequence.join('')) {
                        console.log("ÁßòÂØÜÈÄöÈÅìÂ∑≤Ëß∏ÁôºÔºÅ");
                        const password = prompt("Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂì°ÂØÜÁ¢ºÔºö");
                        if (password) {
                            // --- START: ‰øÆÊîπËß∏ÁôºÈÇèËºØ ---
                            showAdminUI(password);
                            // --- END: ‰øÆÊîπËß∏ÁôºÈÇèËºØ ---
                        }
                        sequence = [];
                    }
                    if (sequence.length >= targetSequence.length && sequence.join('') !== targetSequence.join('')) { sequence = []; }
                });
            });
        }

        initializeApp();
    </script>
</body>

</html>